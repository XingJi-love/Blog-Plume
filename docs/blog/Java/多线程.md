---
title: Java | å¤šçº¿ç¨‹
tags:
  - Java
createTime: 2025/07/27 20:00:00
permalink: /blog/3gl2wn23/
cover: /Java.jpg
---

![Java | å¤šçº¿ç¨‹](./Java.jpg)



## çº¿ç¨‹æ¦‚è¿°

### ä»€ä¹ˆæ˜¯è¿›ç¨‹ï¼Ÿä»€ä¹ˆæ˜¯çº¿ç¨‹ï¼Ÿå®ƒä»¬çš„åŒºåˆ«ï¼Ÿ

+ **è¿›ç¨‹æ˜¯æŒ‡æ“ä½œç³»ç»Ÿä¸­çš„ä¸€æ®µç¨‹åºï¼Œå®ƒæ˜¯ä¸€ä¸ªæ­£åœ¨æ‰§è¡Œä¸­çš„ç¨‹åºå®ä¾‹ï¼Œ`å…·æœ‰ç‹¬ç«‹çš„å†…å­˜ç©ºé—´å’Œç³»ç»Ÿèµ„æº`ï¼Œå¦‚æ–‡ä»¶ã€ç½‘ç»œç«¯å£ç­‰ã€‚åœ¨è®¡ç®—æœºç¨‹åºæ‰§è¡Œæ—¶ï¼Œ`å…ˆåˆ›å»ºè¿›ç¨‹ï¼Œå†åœ¨è¿›ç¨‹ä¸­è¿›è¡Œç¨‹åºçš„æ‰§è¡Œ`ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œ`ä¸€ä¸ªè¿›ç¨‹`å¯ä»¥åŒ…å«`å¤šä¸ªçº¿ç¨‹`ã€‚**

> [!NOTE]
>
> **æç¤º:**
>
> * Windows èµ„æºç®¡ç†å™¨çœ‹åˆ°çš„éƒ½æ˜¯è¿›ç¨‹ï¼Œè¿›ç¨‹æ˜¯æ“ä½œç³»ç»Ÿç®¡ç†çš„åŸºæœ¬å•å…ƒã€‚
>
> ![çº¿ç¨‹æ¦‚è¿°](./å¤šçº¿ç¨‹/img-2.jpg)
>

+ **çº¿ç¨‹æ˜¯`æŒ‡è¿›ç¨‹ä¸­çš„ä¸€ä¸ªæ‰§è¡Œå•å…ƒ`ï¼Œæ˜¯è¿›ç¨‹çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒ`è´Ÿè´£åœ¨è¿›ç¨‹ä¸­æ‰§è¡Œç¨‹åºä»£ç `ã€‚æ¯ä¸ªçº¿ç¨‹`éƒ½æœ‰è‡ªå·±çš„æ ˆå’Œç¨‹åºè®¡æ•°å™¨`ï¼Œå¹¶ä¸”å¯ä»¥`å…±äº«è¿›ç¨‹çš„èµ„æº`ã€‚å¤šä¸ªçº¿ç¨‹`å¯ä»¥åœ¨åŒä¸€æ—¶åˆ»æ‰§è¡Œä¸åŒçš„æ“ä½œ`ï¼Œä»è€Œæé«˜äº†ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ã€‚**

> [!NOTE]
>
> **æç¤º:**
>
> * Windows ä¸­æŸ¥çœ‹çº¿ç¨‹ä¿¡æ¯ï¼Œéœ€è¦å€ŸåŠ© [Process Explorer](https://learn.microsoft.com/zh-cn/sysinternals/downloads/process-explorer) å·¥å…·ã€‚
>
> ![çº¿ç¨‹æ¦‚è¿°](./å¤šçº¿ç¨‹/img-3.gif)
>



+ **ç°ä»£çš„æ“ä½œç³»ç»Ÿæ˜¯æ”¯æŒå¤šè¿›ç¨‹çš„ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥`å¯åŠ¨å¤šä¸ªè½¯ä»¶`ï¼Œ`ä¸€ä¸ªè½¯ä»¶å°±æ˜¯ä¸€ä¸ªè¿›ç¨‹`ã€‚ç§°ä¸ºï¼š`å¤šè¿›ç¨‹å¹¶å‘`ã€‚**

+ **é€šå¸¸ä¸€ä¸ªè¿›ç¨‹éƒ½æ˜¯`å¯ä»¥å¯åŠ¨å¤šä¸ªçº¿ç¨‹çš„`ã€‚ç§°ä¸ºï¼š`å¤šçº¿ç¨‹å¹¶å‘`ã€‚**



### å¤šçº¿ç¨‹çš„ä½œç”¨ï¼Ÿ

+ **æé«˜å¤„ç†æ•ˆç‡ã€‚ï¼ˆå¤šçº¿ç¨‹çš„ä¼˜ç‚¹ä¹‹ä¸€æ˜¯`èƒ½å¤Ÿä½¿ CPU åœ¨å¤„ç†ä¸€ä¸ªä»»åŠ¡æ—¶åŒæ—¶å¤„ç†å¤šä¸ªçº¿ç¨‹`ï¼Œè¿™æ ·å¯ä»¥å……åˆ†åˆ©ç”¨ CPU çš„èµ„æºï¼Œæé«˜ CPU çš„åˆ©ç”¨æ•ˆç‡ã€‚ï¼‰**



### JVMè§„èŒƒä¸­è§„å®š

+ **`å †å†…å­˜ã€æ–¹æ³•åŒº` æ˜¯`çº¿ç¨‹å…±äº«çš„`ã€‚**

+ **`è™šæ‹Ÿæœºæ ˆã€æœ¬åœ°æ–¹æ³•æ ˆã€ç¨‹åºè®¡æ•°å™¨ `æ˜¯`æ¯ä¸ªçº¿ç¨‹ç§æœ‰çš„`ã€‚**

![çº¿ç¨‹æ¦‚è¿°](./å¤šçº¿ç¨‹/img-1.jpg)



### å…³äºJavaç¨‹åºçš„è¿è¡ŒåŸç†

+ **â€œjava HelloWorldâ€æ‰§è¡Œåï¼Œä¼šå¯åŠ¨JVMï¼ŒJVMçš„å¯åŠ¨è¡¨ç¤ºä¸€ä¸ªè¿›ç¨‹å¯åŠ¨äº†ã€‚**

+ **JVMè¿›ç¨‹ä¼šé¦–å…ˆå¯åŠ¨ä¸€ä¸ªä¸»çº¿ç¨‹ï¼ˆmain-threadï¼‰ï¼Œä¸»çº¿ç¨‹è´Ÿè´£è°ƒç”¨mainæ–¹æ³•ã€‚å› æ­¤mainæ–¹æ³•æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­è¿è¡Œçš„ã€‚**

+ **é™¤äº†ä¸»çº¿ç¨‹ä¹‹å¤–ï¼Œè¿˜å¯åŠ¨äº†ä¸€ä¸ªåƒåœ¾å›æ”¶çº¿ç¨‹ã€‚å› æ­¤å¯åŠ¨JVMï¼Œè‡³å°‘å¯åŠ¨äº†ä¸¤ä¸ªçº¿ç¨‹ã€‚**

+ **åœ¨mainæ–¹æ³•çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç¨‹åºå‘˜å¯ä»¥æ‰‹åŠ¨åˆ›å»ºå…¶ä»–çº¿ç¨‹å¯¹è±¡å¹¶å¯åŠ¨ã€‚**

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·/å‘½ä»¤è¡Œ
    participant JVM as JVMè¿›ç¨‹
    participant MainThread as ä¸»çº¿ç¨‹
    participant GCThread as åƒåœ¾å›æ”¶çº¿ç¨‹
    participant OtherThread as å…¶ä»–çº¿ç¨‹
    participant MainMethod as mainæ–¹æ³•

    User->>JVM: java HelloWorld
    Note over JVM: JVMè¿›ç¨‹å¯åŠ¨
    
    JVM->>MainThread: åˆ›å»ºä¸»çº¿ç¨‹
    JVM->>GCThread: åˆ›å»ºåƒåœ¾å›æ”¶çº¿ç¨‹
    
    MainThread->>MainMethod: è°ƒç”¨main()
    
    Note over MainThread,MainMethod: mainæ–¹æ³•å¼€å§‹æ‰§è¡Œ
    
    MainMethod->>OtherThread: åˆ›å»ºçº¿ç¨‹å¯¹è±¡
    MainMethod->>OtherThread: thread.start()
    
    OtherThread-->>OtherThread: çº¿ç¨‹è¿è¡Œ
    
    Note over MainMethod: mainæ–¹æ³•ç»§ç»­æ‰§è¡Œ
    MainMethod-->>MainThread: main()æ‰§è¡Œå®Œæˆ
    
    Note over MainThread: ä¸»çº¿ç¨‹ç»“æŸ
    Note over GCThread: åƒåœ¾å›æ”¶çº¿ç¨‹(å®ˆæŠ¤çº¿ç¨‹)
    Note over OtherThread: å…¶ä»–çº¿ç¨‹ç»§ç»­è¿è¡Œ
```





### åˆ†æç¨‹åºæœ‰å¤šå°‘ä¸ªçº¿ç¨‹(ç»ƒä¹ )

```java
package com.powernode.javase.thread;

/**
 * åˆ†æå½“å‰ç¨‹åºæœ‰å¤šå°‘ä¸ªçº¿ç¨‹ï¼Ÿ
 *      è¿™ä¸ªç¨‹åºé™¤äº†GCçº¿ç¨‹ä¹‹å¤–ï¼Œåªæœ‰ä¸€ä¸ªä¸»çº¿ç¨‹ã€‚
 *      åœ¨JVMå½“ä¸­åªæœ‰ä¸€ä¸ªVM Stackã€‚
 *      è¿™ä¸ªæ ˆåº•éƒ¨æ˜¯mainæ–¹æ³•ã€‚
 *      æ ˆé¡¶éƒ¨æ˜¯m3æ–¹æ³•ã€‚
 */
public class ThreadTest01 {
    public static void main(String[] args) {
        System.out.println("main begin");
        m1();
        System.out.println("main over");
    }

    public static void m1() {
        System.out.println("m1 begin");
        m2();
        System.out.println("m1 over");
    }

    public static void m2() {
        System.out.println("m2 begin");
        m3();
        System.out.println("m2 over");
    }

    public static void m3() {
        System.out.println("m3 execute!");
    }
}
```

> [!NOTE]
>
> **æµ‹è¯•:**
>
> ```java
> main begin
> m1 begin
> m2 begin
> m3 execute!
> m2 over
> m1 over
> main over
> ```
>
> ```mermaid
> sequenceDiagram
>     participant Main as ä¸»çº¿ç¨‹
>     participant VMStack as JVMæ ˆ
>     
>     Note over Main, VMStack: ç¨‹åºå¼€å§‹æ‰§è¡Œ
>     
>     Main->>VMStack: main() å…¥æ ˆ
>     Main->>+Main: System.out.println("main begin")
>     Main-->>-Main: è¾“å‡ºå®Œæˆ
>     Main->>+Main: m1() è°ƒç”¨
>     Main->>VMStack: m1() å…¥æ ˆ
>     
>     Note over Main, VMStack: è¿›å…¥m1æ–¹æ³•
>     Main->>+Main: System.out.println("m1 begin")
>     Main-->>-Main: è¾“å‡ºå®Œæˆ
>     Main->>+Main: m2() è°ƒç”¨
>     Main->>VMStack: m2() å…¥æ ˆ
>     
>     Note over Main, VMStack: è¿›å…¥m2æ–¹æ³•
>     Main->>+Main: System.out.println("m2 begin")
>     Main-->>-Main: è¾“å‡ºå®Œæˆ
>     Main->>+Main: m3() è°ƒç”¨
>     Main->>VMStack: m3() å…¥æ ˆ
>     
>     Note over Main, VMStack: è¿›å…¥m3æ–¹æ³•
>     Main->>+Main: System.out.println("m3 execute!")
>     Main-->>-Main: è¾“å‡ºå®Œæˆ
>     Main->>VMStack: m3() å‡ºæ ˆ
>     
>     Note over Main, VMStack: è¿”å›m2æ–¹æ³•
>     Main->>+Main: System.out.println("m2 over")
>     Main-->>-Main: è¾“å‡ºå®Œæˆ
>     Main->>VMStack: m2() å‡ºæ ˆ
>     
>     Note over Main, VMStack: è¿”å›m1æ–¹æ³•
>     Main->>+Main: System.out.println("m1 over")
>     Main-->>-Main: è¾“å‡ºå®Œæˆ
>     Main->>VMStack: m1() å‡ºæ ˆ
>     
>     Note over Main, VMStack: è¿”å›mainæ–¹æ³•
>     Main->>+Main: System.out.println("main over")
>     Main-->>-Main: è¾“å‡ºå®Œæˆ
>     Main->>VMStack: main() å‡ºæ ˆ
>     
>     Note over Main, VMStack: ç¨‹åºæ‰§è¡Œç»“æŸ
> ```







## å¹¶å‘ä¸å¹¶è¡Œ



### å¹¶å‘ï¼ˆconcurrencyï¼‰

â‘ **ä½¿ç”¨å•æ ¸CPUçš„æ—¶å€™ï¼ŒåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€æ¡æŒ‡ä»¤æ‰§è¡Œï¼Œä½†å¤šä¸ªæŒ‡ä»¤è¢«å¿«é€Ÿçš„è½®æ¢æ‰§è¡Œï¼Œä½¿å¾—åœ¨å®è§‚ä¸Šå…·æœ‰å¤šä¸ªæŒ‡ä»¤åŒæ—¶æ‰§è¡Œçš„æ•ˆæœï¼Œä½†åœ¨å¾®è§‚ä¸Šå¹¶ä¸æ˜¯åŒæ—¶æ‰§è¡Œçš„ï¼Œåªæ˜¯æŠŠæ—¶é—´åˆ†æˆè‹¥å¹²ç«¯ï¼Œä½¿å¤šä¸ªæŒ‡ä»¤å¿«é€Ÿäº¤æ›¿çš„æ‰§è¡Œã€‚**

![å¹¶å‘ä¸å¹¶è¡Œ](./å¤šçº¿ç¨‹/img-4.jpg)

â‘¡**å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå‡è®¾åªæœ‰ä¸€ä¸ªCPUèµ„æºï¼Œçº¿ç¨‹ä¹‹é—´è¦ç«äº‰å¾—åˆ°æ‰§è¡Œæœºä¼šã€‚å›¾ä¸­çš„ç¬¬ä¸€ä¸ªé˜¶æ®µï¼Œåœ¨Aæ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼ŒBã€Cä¸ä¼šæ‰§è¡Œï¼Œå› ä¸ºè¿™æ®µæ—¶é—´å†…è¿™ä¸ªCPUèµ„æºè¢«Aç«äº‰åˆ°äº†ï¼ŒåŒç†ï¼Œç¬¬äºŒé˜¶æ®µåªæœ‰Båœ¨æ‰§è¡Œï¼Œç¬¬ä¸‰é˜¶æ®µåªæœ‰Cåœ¨æ‰§è¡Œã€‚å…¶å®ï¼Œå¹¶å‘è¿‡ç¨‹ä¸­ï¼ŒAã€Bã€Cå¹¶ä¸æ˜¯åŒæ—¶è¿›è¡Œçš„ï¼ˆå¾®è§‚è§’åº¦ï¼‰ï¼Œä½†åˆæ˜¯åŒæ—¶è¿›è¡Œçš„ï¼ˆå®è§‚è§’åº¦ï¼‰ã€‚**

â‘¢**åœ¨åŒä¸€ä¸ªæ—¶é—´ç‚¹ä¸Šï¼Œä¸€ä¸ªCPUåªèƒ½æ”¯æŒä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œã€‚å› ä¸ºCPUè¿è¡Œçš„é€Ÿåº¦å¾ˆå¿«ï¼ŒCPUä½¿ç”¨æŠ¢å å¼è°ƒåº¦æ¨¡å¼åœ¨å¤šä¸ªçº¿ç¨‹é—´è¿›è¡Œç€é«˜é€Ÿçš„åˆ‡æ¢ï¼Œå› æ­¤æˆ‘ä»¬çœ‹èµ·æ¥çš„æ„Ÿè§‰å°±åƒæ˜¯å¤šçº¿ç¨‹ä¸€æ ·ï¼Œä¹Ÿå°±æ˜¯çœ‹ä¸Šå»å°±æ˜¯åœ¨åŒä¸€æ—¶åˆ»è¿è¡Œã€‚**





### å¹¶è¡Œï¼ˆparallellismï¼‰

â‘ **ä½¿ç”¨å¤šæ ¸CPUçš„æ—¶å€™ï¼ŒåŒä¸€æ—¶åˆ»ï¼Œæœ‰å¤šæ¡æŒ‡ä»¤åœ¨å¤šä¸ªCPUä¸ŠåŒæ—¶æ‰§è¡Œã€‚**

![å¹¶å‘ä¸å¹¶è¡Œ](./å¤šçº¿ç¨‹/img-5.jpg)

â‘¡**å¦‚å›¾æ‰€ç¤ºï¼Œåœ¨åŒä¸€æ—¶åˆ»ï¼ŒABCéƒ½æ˜¯åŒæ—¶æ‰§è¡Œï¼ˆå¾®è§‚ã€å®è§‚ï¼‰**





### å¹¶å‘ç¼–ç¨‹ä¸å¹¶è¡Œç¼–ç¨‹



#### å¹¶å‘ç¼–ç¨‹

**æ ¸å¿ƒæ€æƒ³ï¼š** åœ¨å•ä¸ªCPUæ ¸å¿ƒä¸Šï¼Œé€šè¿‡æ—¶é—´åˆ†ç‰‡çš„æ–¹å¼ï¼Œè®©å¤šä¸ªä»»åŠ¡â€œçœ‹èµ·æ¥â€æ˜¯åŒæ—¶è¿›è¡Œçš„ã€‚å½“ä¸€ä¸ªä»»åŠ¡ç­‰å¾…ï¼ˆå¦‚ç­‰å¾…I/Oæ“ä½œï¼‰æ—¶ï¼ŒCPUä¼šç«‹åˆ»åˆ‡æ¢åˆ°å¦ä¸€ä¸ªä»»åŠ¡ï¼Œä»è€Œå……åˆ†åˆ©ç”¨CPUèµ„æºã€‚

**æ—¶åºå›¾è§£é‡Šï¼š**

ä¸‹å›¾å±•ç¤ºäº†åœ¨**å•æ ¸CPU**ä¸Šï¼Œä¸¤ä¸ªä»»åŠ¡ï¼ˆä»»åŠ¡Aå’Œä»»åŠ¡Bï¼‰å¹¶å‘æ‰§è¡Œçš„è¿‡ç¨‹ã€‚

```mermaid
sequenceDiagram
    participant CPU as å•æ ¸CPU
    participant TaskA as ä»»åŠ¡A (è®¡ç®—å¯†é›†å‹)
    participant TaskB as ä»»åŠ¡B (å«I/Oç­‰å¾…)

    Note over CPU, TaskB: æ—¶é—´ç‰‡å¼€å§‹
    CPU->>TaskA: æ‰§è¡Œä»»åŠ¡A
    Note over TaskA: æ‰§è¡Œè®¡ç®—...
    CPU-->>TaskA: æ—¶é—´ç‰‡ç”¨å®Œï¼Œä¸­æ–­<br>ä¿å­˜ä»»åŠ¡Açš„ä¸Šä¸‹æ–‡

    Note over CPU, TaskB: åˆ‡æ¢åˆ°ä»»åŠ¡B
    CPU->>TaskB: æ‰§è¡Œä»»åŠ¡B
    Note over TaskB: æ‰§è¡Œè®¡ç®—...
    TaskB-->>CPU: å‘èµ·I/Oè¯·æ±‚ï¼ˆå¦‚è¯»å†™æ–‡ä»¶ï¼‰
    Note over TaskB: ç­‰å¾…I/Oå“åº”ï¼ˆCPUç©ºé—²ï¼‰
    TaskB->>CPU: I/Oå®Œæˆ

    Note over CPU, TaskB: æ—¶é—´ç‰‡å¼€å§‹
    CPU->>TaskB: ç»§ç»­æ‰§è¡Œä»»åŠ¡B
    Note over TaskB: å¤„ç†I/Oæ•°æ®...
    CPU-->>TaskB: æ—¶é—´ç‰‡ç”¨å®Œï¼Œä¸­æ–­<br>ä¿å­˜ä»»åŠ¡Bçš„ä¸Šä¸‹æ–‡

    Note over CPU, TaskA: åˆ‡æ¢å›ä»»åŠ¡A
    CPU->>TaskA: æ¢å¤ä»»åŠ¡Açš„ä¸Šä¸‹æ–‡å¹¶æ‰§è¡Œ
    Note over TaskA: ç»§ç»­æ‰§è¡Œè®¡ç®—...
```

**æ—¶åºå›¾å…³é”®ç‚¹ï¼š**

1. **å•æ ¸èµ„æº**ï¼šæ•´ä¸ªæµç¨‹åªæœ‰ä¸€ä¸ªCPUæ ¸å¿ƒåœ¨å·¥ä½œã€‚
2. **æ—¶é—´åˆ†ç‰‡**ï¼šCPUå°†æ—¶é—´åˆ†æˆå°ç‰‡æ®µï¼Œè½®æµåˆ†é…ç»™ä»»åŠ¡Aå’Œä»»åŠ¡Bã€‚
3. **ä¸Šä¸‹æ–‡åˆ‡æ¢**ï¼šæ¯æ¬¡åˆ‡æ¢ä»»åŠ¡æ—¶ï¼ŒCPUéœ€è¦ä¿å­˜å½“å‰ä»»åŠ¡çš„çŠ¶æ€ï¼ˆä¸Šä¸‹æ–‡ï¼‰ï¼Œå¹¶åŠ è½½ä¸‹ä¸€ä¸ªä»»åŠ¡çš„çŠ¶æ€ã€‚è¿™ä¸ªè¿‡ç¨‹æœ‰ä¸€å®šå¼€é”€ã€‚
4. **åˆ©ç”¨ç­‰å¾…æ—¶é—´**ï¼šå½“ä»»åŠ¡Bè¿›è¡ŒI/Oæ“ä½œï¼ˆå¦‚è¯»å†™æ–‡ä»¶ã€ç½‘ç»œè¯·æ±‚ï¼‰æ—¶ï¼Œå®ƒä¸éœ€è¦CPUã€‚æ­¤æ—¶CPUä¸ä¼šå‚»ç­‰ï¼Œè€Œæ˜¯ç«‹å³åˆ‡æ¢åˆ°ä»»åŠ¡Aå»æ‰§è¡Œã€‚**è¿™æ˜¯å¹¶å‘ç¼–ç¨‹æå‡æ•ˆç‡çš„å…³é”®**ã€‚
5. **å®è§‚ä¸å¾®è§‚**ï¼šåœ¨å®è§‚ä¸Šï¼ˆæ¯”å¦‚1ç§’é’Ÿå†…ï¼‰ï¼Œä»»åŠ¡Aå’ŒBéƒ½åœ¨å‘å‰æ¨è¿›ï¼Œå¥½åƒæ˜¯â€œåŒæ—¶â€è¿è¡Œçš„ï¼›ä½†åœ¨å¾®è§‚ä¸Šï¼ˆçº³ç§’æˆ–æ¯«ç§’çº§ï¼‰ï¼Œå®ƒä»¬åœ¨äº¤æ›¿æ‰§è¡Œã€‚

**å¹¶å‘çš„ä¸»è¦ç›®çš„ï¼š** æé«˜ç¨‹åºçš„å“åº”èƒ½åŠ›å’Œèµ„æºï¼ˆç‰¹åˆ«æ˜¯CPUï¼‰çš„åˆ©ç”¨ç‡





#### å¹¶è¡Œç¼–ç¨‹

**æ ¸å¿ƒæ€æƒ³ï¼š** åˆ©ç”¨å¤šä¸ªCPUæ ¸å¿ƒï¼Œåœ¨åŒä¸€æ—¶åˆ»çœŸæ­£åŒæ—¶æ‰§è¡Œå¤šä¸ªä»»åŠ¡ã€‚

**æ—¶åºå›¾è§£é‡Šï¼š**

ä¸‹å›¾å±•ç¤ºäº†åœ¨**åŒæ ¸CPU**ä¸Šï¼Œä¸¤ä¸ªä»»åŠ¡å¹¶è¡Œæ‰§è¡Œçš„è¿‡ç¨‹ã€‚

```mermaid
sequenceDiagram
    participant CPU1 as CPUæ ¸å¿ƒ1
    participant CPU2 as CPUæ ¸å¿ƒ2
    participant TaskA as ä»»åŠ¡A
    participant TaskB as ä»»åŠ¡B

    Note over CPU1, TaskB: æ—¶åˆ» T1
    CPU1->>TaskA: æ‰§è¡Œä»»åŠ¡A
    CPU2->>TaskB: æ‰§è¡Œä»»åŠ¡B

    Note over CPU1, TaskB: æ—¶åˆ» T2 (ä¸T1åŒæ—¶)
    Note over TaskA: æ‰§è¡Œè®¡ç®—...
    Note over TaskB: æ‰§è¡Œè®¡ç®—...

    Note over CPU1, TaskB: æ—¶åˆ» T3 (ä¸T1åŒæ—¶)
    Note over TaskA: ç»§ç»­æ‰§è¡Œ...
    Note over TaskB: ç»§ç»­æ‰§è¡Œ...
```

**æ—¶åºå›¾å…³é”®ç‚¹ï¼š**

1. **å¤šæ ¸èµ„æº**ï¼šæœ‰å¤šä¸ªCPUæ ¸å¿ƒï¼ˆè¿™é‡Œæ˜¯ä¸¤ä¸ªï¼‰ä½œä¸ºæ‰§è¡Œå•å…ƒã€‚
2. **çœŸæ­£åŒæ—¶**ï¼šåœ¨åŒä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸï¼ˆæ—¶åˆ»T1ï¼‰ï¼Œæ ¸å¿ƒ1æ‰§è¡Œä»»åŠ¡Aï¼Œæ ¸å¿ƒ2æ‰§è¡Œä»»åŠ¡Bã€‚å®ƒä»¬ä¹‹é—´æ²¡æœ‰â€œäº¤æ›¿â€æˆ–â€œæŠ¢å â€ï¼Œæ˜¯ç‰©ç†ä¸Šçš„åŒæ—¶æ‰§è¡Œã€‚
3. **æ— ä¸Šä¸‹æ–‡åˆ‡æ¢**ï¼šæ¯ä¸ªä»»åŠ¡ç‹¬å ä¸€ä¸ªæ ¸å¿ƒï¼Œåœ¨å…¶æ—¶é—´ç‰‡å†…ä¸éœ€è¦è¢«ä¸­æ–­å’Œåˆ‡æ¢ï¼Œå› æ­¤æ²¡æœ‰å¹¶å‘æ¨¡å¼ä¸‹çš„é‚£ç§ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ã€‚
4. **æ•ˆç‡æå‡**ï¼šç†æƒ³æƒ…å†µä¸‹ï¼ŒåŒæ ¸å¹¶è¡Œæ‰§è¡Œä¸¤ä¸ªè®¡ç®—å¯†é›†å‹ä»»åŠ¡ï¼Œæ—¶é—´å¯ä»¥ç¼©çŸ­åˆ°å•æ ¸çš„ä¸€åŠã€‚

**å¹¶è¡Œçš„ä¸»è¦ç›®çš„ï¼š** å¤§å¹…æå‡è®¡ç®—é€Ÿåº¦ï¼Œç¼©çŸ­é—®é¢˜çš„æ€»ä½“è§£å†³æ—¶é—´ï¼Œé€šå¸¸ç”¨äºå¤„ç†è®¡ç®—å¯†é›†å‹ä»»åŠ¡ï¼ˆå¦‚ç§‘å­¦è®¡ç®—ã€å¤§æ•°æ®å¤„ç†ã€å›¾å½¢æ¸²æŸ“ï¼‰ã€‚



#### æ€»ç»“ä¸å…³ç³»

| ç‰¹æ€§         | å¹¶å‘                     | å¹¶è¡Œ             |
| :----------- | :----------------------- | :--------------- |
| **æ ¸å¿ƒæ•°é‡** | å•æ ¸å³å¯                 | å¿…é¡»å¤šæ ¸         |
| **æ‰§è¡Œæ–¹å¼** | äº¤æ›¿æ‰§è¡Œ                 | åŒæ—¶æ‰§è¡Œ         |
| **æ ¸å¿ƒç›®æ ‡** | æé«˜å“åº”å’Œèµ„æºåˆ©ç”¨ç‡     | æå‡è®¡ç®—é€Ÿåº¦     |
| **æ˜¯å¦åŒæ—¶** | å®è§‚åŒæ—¶ï¼Œå¾®è§‚äº¤æ›¿       | å®è§‚å’Œå¾®è§‚éƒ½åŒæ—¶ |
| **é€‚ç”¨åœºæ™¯** | I/Oå¯†é›†å‹ä»»åŠ¡ã€WebæœåŠ¡å™¨ | è®¡ç®—å¯†é›†å‹ä»»åŠ¡   |

**ç›¸äº’å…³ç³»ï¼š**

- **å¹¶è¡Œæ˜¯å¹¶å‘çš„çœŸå­é›†**ï¼šä¸€ä¸ªç³»ç»Ÿå¦‚æœå¯ä»¥å¹¶è¡Œï¼Œé‚£ä¹ˆå®ƒå¿…ç„¶å¯ä»¥å¹¶å‘ï¼ˆå› ä¸ºå¤šä¸ªæ ¸å¿ƒå¯ä»¥å„è‡ªè¿›è¡Œä»»åŠ¡åˆ‡æ¢ï¼‰ã€‚ä½†å¯ä»¥å¹¶å‘çš„ç³»ç»Ÿä¸ä¸€å®šèƒ½å¹¶è¡Œï¼ˆæ¯”å¦‚åœ¨å•æ ¸CPUä¸Šï¼‰ã€‚
- **ç°ä»£ç¼–ç¨‹é€šå¸¸ç»“åˆä¸¤è€…**ï¼šåœ¨ä¸€ä¸ªå¤šæ ¸CPUä¸Šï¼Œå¯ä»¥åŒæ—¶è¿è¡Œå¤šä¸ªç¨‹åºï¼ˆ**å¹¶è¡Œ**ï¼‰ï¼Œè€Œæ¯ä¸ªç¨‹åºå†…éƒ¨åˆé€šè¿‡å¤šçº¿ç¨‹æ¥å®ç°**å¹¶å‘**ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªWebæœåŠ¡å™¨åœ¨8æ ¸CPUä¸Šè¿è¡Œï¼Œå®ƒå¯ä»¥åŒæ—¶å¤„ç†8ä¸ªç”¨æˆ·è¯·æ±‚ï¼ˆ**å¹¶è¡Œ**ï¼‰ï¼Œè€Œå¤„ç†æ¯ä¸ªè¯·æ±‚çš„çº¿ç¨‹åœ¨é‡åˆ°æ•°æ®åº“æŸ¥è¯¢æ—¶ï¼Œä¼šé‡Šæ”¾CPUç»™å…¶ä»–çº¿ç¨‹ä½¿ç”¨ï¼ˆ**å¹¶å‘**ï¼‰ã€‚







## çº¿ç¨‹çš„è°ƒåº¦ç­–ç•¥

### æ¦‚è¿°

**å¦‚æœ`å¤šä¸ªçº¿ç¨‹`è¢«åˆ†é…åˆ°`ä¸€ä¸ªCPUå†…æ ¸ä¸­æ‰§è¡Œ`ï¼Œåˆ™åŒä¸€æ—¶åˆ»`åªèƒ½å…è®¸æœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è·å¾—CPUçš„æ‰§è¡Œæƒ`ï¼Œé‚£ä¹ˆè¿›ç¨‹ä¸­çš„`å¤šä¸ªçº¿ç¨‹`å°±ä¼š`æŠ¢å¤ºCPUçš„æ‰§è¡Œæƒ`ï¼Œè¿™å°±æ˜¯æ¶‰åŠåˆ°`çº¿ç¨‹è°ƒåº¦ç­–ç•¥`ã€‚**

```mermaid
graph TB
    A[å¤šä¸ªçº¿ç¨‹] --> B[å•ä¸ªCPUæ ¸å¿ƒ]
    B --> C[çº¿ç¨‹è°ƒåº¦å™¨]
    C --> D[åˆ†æ—¶è°ƒåº¦æ¨¡å‹]
    C --> E[æŠ¢å å¼è°ƒåº¦æ¨¡å‹]
```





### çº¿ç¨‹çš„è°ƒåº¦æ¨¡å‹



#### åˆ†æ—¶è°ƒåº¦æ¨¡å‹

> **æ‰€æœ‰çº¿ç¨‹è½®æµä½¿ç”¨CPUçš„æ‰§è¡Œæƒï¼Œå¹¶ä¸”`å¹³å‡çš„åˆ†é…æ¯ä¸ªçº¿ç¨‹å ç”¨çš„CPUçš„æ—¶é—´`ã€‚**

```mermaid
sequenceDiagram
    participant Scheduler as è°ƒåº¦å™¨
    participant ThreadA as çº¿ç¨‹A
    participant ThreadB as çº¿ç¨‹B
    participant ThreadC as çº¿ç¨‹C

    Note over Scheduler, ThreadC: æ—¶é—´ç‰‡1 (20ms)
    Scheduler->>ThreadA: æ‰§è¡Œ
    Note over ThreadA: è¿è¡Œ20ms...
    Scheduler-->>ThreadA: æ—¶é—´ç‰‡ç»“æŸï¼Œå¼ºåˆ¶æŒ‚èµ·
    
    Note over Scheduler, ThreadC: æ—¶é—´ç‰‡2 (20ms)
    Scheduler->>ThreadB: æ‰§è¡Œ
    Note over ThreadB: è¿è¡Œ20ms...
    Scheduler-->>ThreadB: æ—¶é—´ç‰‡ç»“æŸï¼Œå¼ºåˆ¶æŒ‚èµ·
    
    Note over Scheduler, ThreadC: æ—¶é—´ç‰‡3 (20ms)
    Scheduler->>ThreadC: æ‰§è¡Œ
    Note over ThreadC: è¿è¡Œ20ms...
    Scheduler-->>ThreadC: æ—¶é—´ç‰‡ç»“æŸï¼Œå¼ºåˆ¶æŒ‚èµ·
    
    Note over Scheduler, ThreadC: æ–°ä¸€è½®å¾ªç¯
    Scheduler->>ThreadA: å†æ¬¡æ‰§è¡Œ
    Note over ThreadA: è¿è¡Œ20ms...
```

**åˆ†æ—¶è°ƒåº¦çš„å…³é”®ç‚¹**ï¼š

- â±ï¸ **å›ºå®šæ—¶é—´ç‰‡**ï¼šæ¯ä¸ªçº¿ç¨‹è·å¾—ç›¸ç­‰çš„CPUæ—¶é—´ï¼ˆå¦‚20msï¼‰
- ğŸ”„ **å¾ªç¯è½®è½¬**ï¼šæŒ‰é¡ºåºè½®æµæ‰§è¡Œï¼Œä¿è¯å…¬å¹³æ€§
- â¸ï¸ **å¼ºåˆ¶åˆ‡æ¢**ï¼šæ—¶é—´ç‰‡ç”¨å®Œç«‹å³æŒ‚èµ·ï¼Œä¸ç®¡ä»»åŠ¡æ˜¯å¦å®Œæˆ
- ğŸ¯ **é€‚ç”¨åœºæ™¯**ï¼šå¼ºè°ƒå…¬å¹³æ€§çš„ç³»ç»Ÿï¼Œæ—©æœŸUnixç³»ç»Ÿ





#### æŠ¢å å¼è°ƒåº¦æ¨¡å‹

> **è®©`ä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹`ä»¥è¾ƒå¤§çš„æ¦‚ç‡`ä¼˜å…ˆè·å¾—CPUçš„æ‰§è¡Œæƒ`ï¼Œå¦‚æœ`çº¿ç¨‹çš„ä¼˜å…ˆçº§ç›¸åŒ`ï¼Œé‚£ä¹ˆå°±ä¼š`éšæœºé€‰æ‹©ä¸€ä¸ªçº¿ç¨‹è·å¾—CPUçš„æ‰§è¡Œæƒ`ï¼Œè€Œ`Javaé‡‡ç”¨çš„å°±æ˜¯æŠ¢å å¼è°ƒç”¨`ã€‚**

```mermaid
sequenceDiagram
    participant Scheduler as è°ƒåº¦å™¨
    participant ThreadA as çº¿ç¨‹A (é«˜ä¼˜å…ˆçº§)
    participant ThreadB as çº¿ç¨‹B (ä¸­ä¼˜å…ˆçº§)
    participant ThreadC as çº¿ç¨‹C (ä½ä¼˜å…ˆçº§)

    Note over Scheduler, ThreadC: åˆå§‹çŠ¶æ€
    Scheduler->>ThreadB: é€‰æ‹©ä¸­ä¼˜å…ˆçº§çº¿ç¨‹Bæ‰§è¡Œ
    Note over ThreadB: æ‰§è¡Œè®¡ç®—...
    
    Note over Scheduler, ThreadC: é«˜ä¼˜å…ˆçº§çº¿ç¨‹Aå°±ç»ª
    ThreadA->>Scheduler: çº¿ç¨‹Aå‡†å¤‡å°±ç»ªï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
    Scheduler-->>ThreadB: ç«‹å³æŠ¢å ï¼æŒ‚èµ·çº¿ç¨‹B
    Scheduler->>ThreadA: æ‰§è¡Œé«˜ä¼˜å…ˆçº§çº¿ç¨‹A
    Note over ThreadA: ä¼˜å…ˆæ‰§è¡Œ...
    
    Note over Scheduler, ThreadC: çº¿ç¨‹Aé˜»å¡æˆ–å®Œæˆ
    ThreadA-->>Scheduler: çº¿ç¨‹Aç­‰å¾…I/O
    Scheduler->>ThreadB: æ¢å¤ä¸­ä¼˜å…ˆçº§çº¿ç¨‹B
    Note over ThreadB: ç»§ç»­æ‰§è¡Œ...
    
    Note over Scheduler, ThreadC: åŒä¼˜å…ˆçº§éšæœºé€‰æ‹©
    ThreadB-->>Scheduler: çº¿ç¨‹Bæ—¶é—´ç‰‡ç»“æŸ
    Scheduler->>ThreadC: éšæœºé€‰æ‹©çº¿ç¨‹Cæ‰§è¡Œï¼ˆåŒä¼˜å…ˆçº§ï¼‰
```

**æŠ¢å å¼è°ƒåº¦çš„å…³é”®ç‚¹**ï¼š

- ğŸ† **ä¼˜å…ˆçº§é©±åŠ¨**ï¼šé«˜ä¼˜å…ˆçº§çº¿ç¨‹ä¼˜å…ˆæ‰§è¡Œï¼Œå¹¶å¯æŠ¢å ä½ä¼˜å…ˆçº§çº¿ç¨‹
- ğŸ² **åŒä¼˜å…ˆçº§éšæœº**ï¼šä¼˜å…ˆçº§ç›¸åŒæ—¶ï¼Œéšæœºé€‰æ‹©æˆ–è½®è½¬
- ğŸ”„ **åŠ¨æ€å“åº”**ï¼šæ–°å°±ç»ªçš„é«˜ä¼˜å…ˆçº§çº¿ç¨‹èƒ½ç«‹å³è·å¾—CPU
- âš¡ **Javaé‡‡ç”¨**ï¼šè¿™æ­£æ˜¯Javaçº¿ç¨‹è°ƒåº¦çš„æ–¹å¼



#### Javaä¸­çš„æŠ¢å å¼è°ƒåº¦ç¤ºä¾‹

```java
public class ThreadPriorityExample {
    public static void main(String[] args) {
        Thread highPriorityThread = new Thread(() -> {
            for (int i = 0; i < 5; i++) {
                System.out.println("é«˜ä¼˜å…ˆçº§çº¿ç¨‹æ‰§è¡Œ");
            }
        });
        
        Thread lowPriorityThread = new Thread(() -> {
            for (int i = 0; i < 5; i++) {
                System.out.println("ä½ä¼˜å…ˆçº§çº¿ç¨‹æ‰§è¡Œ");
            }
        });
        
        // è®¾ç½®ä¼˜å…ˆçº§ï¼ˆ1-10ï¼Œé»˜è®¤5ï¼‰
        highPriorityThread.setPriority(Thread.MAX_PRIORITY); // 10
        lowPriorityThread.setPriority(Thread.MIN_PRIORITY);  // 1
        
        lowPriorityThread.start();
        highPriorityThread.start(); // é«˜ä¼˜å…ˆçº§çº¿ç¨‹å¯èƒ½å…ˆå®Œæˆ
    }
}
```







## å®ç°çº¿ç¨‹



### ç¬¬ä¸€ç§æ–¹å¼ï¼šç»§æ‰¿Thread

```java
åœ¨Javaè¯­è¨€ä¸­ï¼Œå®ç°çº¿ç¨‹ï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼Œç¬¬ä¸€ç§æ–¹å¼ï¼š
 	ç¬¬ä¸€æ­¥ï¼šç¼–å†™ä¸€ä¸ªç±»ç»§æ‰¿ java.lang.Thread
 	ç¬¬äºŒæ­¥ï¼šé‡å†™runæ–¹æ³•
 	ç¬¬ä¸‰æ­¥ï¼šnewçº¿ç¨‹å¯¹è±¡
 	ç¬¬å››éƒ¨ï¼šè°ƒç”¨çº¿ç¨‹å¯¹è±¡çš„startæ–¹æ³•æ¥å¯åŠ¨çº¿ç¨‹ã€‚
```

```java
package com.powernode.javase.thread;

public class ThreadTest02 {
    public static void main(String[] args) {
        // åˆ›å»ºçº¿ç¨‹å¯¹è±¡
        //MyThread mt = new MyThread();
        Thread t = new MyThread();

        // ç›´æ¥è°ƒç”¨runæ–¹æ³•ï¼Œä¸ä¼šå¯åŠ¨æ–°çš„çº¿ç¨‹ã€‚
        // javaä¸­æœ‰ä¸€ä¸ªè¯­æ³•è§„åˆ™ï¼šå¯¹äºæ–¹æ³•ä½“å½“ä¸­çš„ä»£ç ï¼Œå¿…é¡»éµå¾ªè‡ªä¸Šè€Œä¸‹çš„é¡ºåºä¾æ¬¡é€è¡Œæ‰§è¡Œã€‚
        // run()æ–¹æ³•ä¸ç»“æŸï¼Œmainæ–¹æ³•æ˜¯æ— æ³•ç»§ç»­æ‰§è¡Œçš„ã€‚
        //t.run();

        // è°ƒç”¨start()æ–¹æ³•ï¼Œå¯åŠ¨çº¿ç¨‹
        // javaä¸­æœ‰ä¸€ä¸ªè¯­æ³•è§„åˆ™ï¼šå¯¹äºæ–¹æ³•ä½“å½“ä¸­çš„ä»£ç ï¼Œå¿…é¡»éµå¾ªè‡ªä¸Šè€Œä¸‹çš„é¡ºåºä¾æ¬¡é€è¡Œæ‰§è¡Œã€‚
        // start()æ–¹æ³•ä¸ç»“æŸï¼Œmainæ–¹æ³•æ˜¯æ— æ³•ç»§ç»­æ‰§è¡Œçš„ã€‚
        // start()ç¬é—´å°±ä¼šç»“æŸï¼ŒåŸå› è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯ï¼šå¯åŠ¨ä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œåªè¦æ–°çº¿ç¨‹å¯åŠ¨æˆåŠŸäº†ï¼Œstart()å°±ç»“æŸäº†ã€‚
        t.start();

        // è¿™é‡Œç¼–å†™çš„ä»£ç åœ¨mainæ–¹æ³•ä¸­ï¼Œå› æ­¤è¿™é‡Œçš„ä»£ç å±äºåœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œã€‚
        for (int i = 0; i < 100; i++) {
            System.out.println("main--->" + i);
        }
    }
}


// è‡ªå®šä¹‰ä¸€ä¸ªçº¿ç¨‹ç±»
// java.lang.Threadæœ¬èº«å°±æ˜¯ä¸€ä¸ªçº¿ç¨‹ã€‚
// MyThreadç»§æ‰¿Threadï¼Œå› æ­¤MyThreadæœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªçº¿ç¨‹ã€‚
class MyThread extends Thread {
    @Override
    public void run() {
        for (int i = 0; i < 100; i++) {
            System.out.println("MyThread--->" + i);
        }
    }
}
```



####  æ­£ç¡®æ‰§è¡Œæµç¨‹ï¼ˆä½¿ç”¨start()æ–¹æ³•ï¼‰

![å®ç°çº¿ç¨‹](./å¤šçº¿ç¨‹/img-6.jpg)

```mermaid
sequenceDiagram
    participant M as Main Thread
    participant T as MyThread Thread
    participant JVM as JVM Thread Scheduler
    
    Note over M: ä¸»çº¿ç¨‹å¼€å§‹æ‰§è¡Œ
    
    M->>T: new MyThread() - åˆ›å»ºçº¿ç¨‹å¯¹è±¡
    Note over T: çº¿ç¨‹å¯¹è±¡åˆ›å»ºå®Œæˆ<br/>ä½†å°šæœªå¯åŠ¨
    
    M->>T: start() - å¯åŠ¨çº¿ç¨‹
    Note over T: çº¿ç¨‹è¿›å…¥å°±ç»ªçŠ¶æ€<br/>start()æ–¹æ³•ç«‹å³è¿”å›
    
    M->>M: ç»§ç»­æ‰§è¡Œmainæ–¹æ³•ä¸­çš„å¾ªç¯
    activate M
    M->>M: è¾“å‡º "main--->0"
    M->>M: è¾“å‡º "main--->1"
    M->>M: ... (ç»§ç»­æ‰§è¡Œ)
    deactivate M
    
    JVM->>T: åˆ†é…CPUæ—¶é—´ç‰‡
    activate T
    T->>T: æ‰§è¡Œrun()æ–¹æ³•
    T->>T: è¾“å‡º "MyThread--->0"
    T->>T: è¾“å‡º "MyThread--->1"
    T->>T: ... (ç»§ç»­æ‰§è¡Œ)
    deactivate T
    
    Note over M,T: ä¸¤ä¸ªçº¿ç¨‹äº¤æ›¿æ‰§è¡Œ<br/>ç”±JVMçº¿ç¨‹è°ƒåº¦å™¨æ§åˆ¶
    
    M->>M: è¾“å‡º "main--->99"
    Note over M: ä¸»çº¿ç¨‹å¯èƒ½å…ˆç»“æŸ
    
    T->>T: è¾“å‡º "MyThread--->99"
    Note over T: å­çº¿ç¨‹æ‰§è¡Œå®Œæˆ
```

>  **ä½¿ç”¨`start()`æ–¹æ³•çš„è¾“å‡ºç‰¹ç‚¹:**
>
> ```java
> main--->0
> MyThread--->0
> main--->1
> MyThread--->1
> main--->2
> MyThread--->2
> ...
> ```
>
> - **ä¸¤ä¸ªå¾ªç¯äº¤æ›¿æ‰§è¡Œ**
> - **æ‰§è¡Œé¡ºåºä¸ç¡®å®šï¼Œç”±çº¿ç¨‹è°ƒåº¦å™¨å†³å®š**
> - **ä¸»çº¿ç¨‹å’Œå­çº¿ç¨‹å¹¶å‘æ‰§è¡Œ**



#### é”™è¯¯æ‰§è¡Œæµç¨‹ï¼ˆä½¿ç”¨run()æ–¹æ³•ï¼‰

![å®ç°çº¿ç¨‹](./å¤šçº¿ç¨‹/img-7.jpg)

```mermaid
sequenceDiagram
    participant M as Main Thread
    participant T as MyThread Thread
    
    Note over M: ä¸»çº¿ç¨‹å¼€å§‹æ‰§è¡Œ
    
    M->>T: new MyThread() - åˆ›å»ºçº¿ç¨‹å¯¹è±¡
    
    M->>T: run() - ç›´æ¥è°ƒç”¨runæ–¹æ³•
    Note over T: æ³¨æ„ï¼šè¿™ä¸æ˜¯å¯åŠ¨æ–°çº¿ç¨‹<br/>è€Œæ˜¯åœ¨å½“å‰çº¿ç¨‹ä¸­æ‰§è¡Œ
    
    activate T
    T->>T: æ‰§è¡Œrun()æ–¹æ³•
    T->>T: è¾“å‡º "MyThread--->0"
    T->>T: è¾“å‡º "MyThread--->1"
    T->>T: ... (ç»§ç»­æ‰§è¡Œ100æ¬¡)
    T->>T: è¾“å‡º "MyThread--->99"
    deactivate T
    
    Note over M: ä¸»çº¿ç¨‹è¢«é˜»å¡ï¼Œç­‰å¾…run()æ–¹æ³•æ‰§è¡Œå®Œæˆ
    
    M->>M: å¼€å§‹æ‰§è¡Œmainæ–¹æ³•ä¸­çš„å¾ªç¯
    M->>M: è¾“å‡º "main--->0"
    M->>M: è¾“å‡º "main--->1"
    M->>M: ... (ç»§ç»­æ‰§è¡Œ)
    
    Note over M: ä¸»çº¿ç¨‹åœ¨å­çº¿ç¨‹å®Œå…¨ç»“æŸåæ‰å¼€å§‹æ‰§è¡Œ
```

> **ä½¿ç”¨`run()`æ–¹æ³•çš„è¾“å‡ºç‰¹ç‚¹ï¼š**
>
> ```java
> MyThread--->0
> MyThread--->1
> ...
> MyThread--->99
>     
> main--->0
> main--->1
> ...
> main--->99
> ```
>
> - **å…ˆå®Œæ•´æ‰§è¡Œå­çº¿ç¨‹çš„runæ–¹æ³•**
> - **ç„¶åæ‰æ‰§è¡Œä¸»çº¿ç¨‹çš„å¾ªç¯**
> - **å®é™…ä¸Šæ˜¯å•çº¿ç¨‹é¡ºåºæ‰§è¡Œ**





#### æ€»ç»“

`start()` vs `run()` çš„åŒºåˆ«

| æ–¹æ³•      | ä½œç”¨                                | çº¿ç¨‹æ•°é‡                 | æ‰§è¡Œé¡ºåº |
| :-------- | :---------------------------------- | :----------------------- | :------- |
| `start()` | å¯åŠ¨æ–°çº¿ç¨‹ï¼Œåœ¨æ–°çº¿ç¨‹ä¸­æ‰§è¡Œrun()æ–¹æ³• | 2ä¸ªçº¿ç¨‹ï¼ˆä¸»çº¿ç¨‹+æ–°çº¿ç¨‹ï¼‰ | å¹¶å‘æ‰§è¡Œ |
| `run()`   | ç›´æ¥è°ƒç”¨æ–¹æ³•ï¼Œä¸ä¼šå¯åŠ¨æ–°çº¿ç¨‹        | 1ä¸ªçº¿ç¨‹ï¼ˆä¸»çº¿ç¨‹ï¼‰        | é¡ºåºæ‰§è¡Œ |

> 1. **åˆ›å»ºçº¿ç¨‹å¯¹è±¡**åªæ˜¯åˆ›å»ºäº†å¯¹è±¡ï¼Œçº¿ç¨‹å¹¶æœªå¯åŠ¨
> 2. **è°ƒç”¨`start()`** ä¼šå¯åŠ¨æ–°çº¿ç¨‹ï¼Œç«‹å³è¿”å›ï¼Œä¸»çº¿ç¨‹ç»§ç»­æ‰§è¡Œ
> 3. **è°ƒç”¨`run()`** åªæ˜¯æ™®é€šæ–¹æ³•è°ƒç”¨ï¼Œä¸ä¼šå¯åŠ¨æ–°çº¿ç¨‹
> 4. **å¤šçº¿ç¨‹å¹¶å‘æ‰§è¡Œ**æ—¶ï¼Œæ‰§è¡Œé¡ºåºç”±JVMçº¿ç¨‹è°ƒåº¦å™¨å†³å®šï¼Œå…·æœ‰ä¸ç¡®å®šæ€§





### ç¬¬äºŒç§æ–¹å¼ï¼šå®ç°Runnableæ¥å£

```java
åœ¨Javaè¯­è¨€ä¸­ï¼Œå®ç°çº¿ç¨‹ï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼Œç¬¬äºŒç§æ–¹å¼ï¼š
       ç¬¬ä¸€æ­¥ï¼šç¼–å†™ä¸€ä¸ªç±»å®ç° java.lang.Runnableæ¥å£ï¼ˆå¯è¿è¡Œçš„æ¥å£ï¼‰
       ç¬¬äºŒæ­¥ï¼šå®ç°æ¥å£ä¸­çš„runæ–¹æ³•ã€‚
       ç¬¬ä¸‰æ­¥ï¼šnewçº¿ç¨‹å¯¹è±¡
       ç¬¬å››éƒ¨ï¼šè°ƒç”¨çº¿ç¨‹çš„startæ–¹æ³•å¯åŠ¨çº¿ç¨‹
 
  æ€»ç»“ï¼šå®ç°çº¿ç¨‹ä¸¤ç§æ–¹å¼ï¼š
       ç¬¬ä¸€ç§ï¼šç¼–å†™ç±»ç›´æ¥ç»§æ‰¿Thread
       ç¬¬äºŒç§ï¼šç¼–å†™ç±»å®ç°Runnableæ¥å£
 
       æ¨èä½¿ç”¨ç¬¬äºŒç§ï¼Œå› ä¸ºå®ç°æ¥å£çš„åŒæ—¶ï¼Œä¿ç•™äº†ç±»çš„ç»§æ‰¿ã€‚
```

```java
package com.powernode.javase.thread;

public class ThreadTest03 {
    public static void main(String[] args) {
        // åˆ›å»ºRunnableå¯¹è±¡
        //Runnable r = new MyRunnable();
        // åˆ›å»ºçº¿ç¨‹å¯¹è±¡
        //Thread t1 = new Thread(r);

        // åˆ›å»ºçº¿ç¨‹å¯¹è±¡
        Thread t = new Thread(new MyRunnable());

        // å¯åŠ¨çº¿ç¨‹
        t.start();

        // ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œçš„ã€‚
        for (int i = 0; i < 100; i++) {
            System.out.println("main----->" + i);
        }
    }
}


// ä¸¥æ ¼æ¥è¯´ï¼Œè¿™ä¸ªä¸æ˜¯ä¸€ä¸ªçº¿ç¨‹ç±»
// å®ƒæ˜¯ä¸€ä¸ªæ™®é€šçš„ç±»ï¼Œåªä¸è¿‡å®ç°äº†ä¸€ä¸ªRunnableæ¥å£ã€‚
class MyRunnable implements Runnable {

    @Override
    public void run() {
        for (int i = 0; i < 100; i++) {
            System.out.println("t----->" + i);
        }
    }
}
```

> **å®ç°Runnableæ¥å£æ–¹å¼çš„æ‰§è¡Œæµç¨‹:**
>
> ```mermaid
> sequenceDiagram
>     participant M as Main Thread
>     participant R as MyRunnableå¯¹è±¡
>     participant T as Threadå¯¹è±¡
>     participant JVM as JVM Thread Scheduler
>     
>     Note over M: ä¸»çº¿ç¨‹å¼€å§‹æ‰§è¡Œ
>     
>     M->>R: new MyRunnable() - åˆ›å»ºRunnableå¯¹è±¡
>     Note over R: æ™®é€šå¯¹è±¡ï¼Œä¸æ˜¯çº¿ç¨‹
>     
>     M->>T: new Thread(R) - åˆ›å»ºThreadå¯¹è±¡å¹¶ä¼ å…¥Runnable
>     Note over T: Threadå¯¹è±¡æŒæœ‰Runnableå¼•ç”¨
>     
>     M->>T: start() - å¯åŠ¨çº¿ç¨‹
>     Note over T: çº¿ç¨‹è¿›å…¥å°±ç»ªçŠ¶æ€<br/>start()æ–¹æ³•ç«‹å³è¿”å›
>     
>     par ä¸»çº¿ç¨‹æ‰§è¡Œ
>         M->>M: æ‰§è¡Œmainæ–¹æ³•ä¸­çš„å¾ªç¯
>         activate M
>         M->>M: è¾“å‡º "main----->0"
>         M->>M: è¾“å‡º "main----->1"
>         M->>M: ... (ç»§ç»­æ‰§è¡Œ)
>         M->>M: è¾“å‡º "main----->99"
>         deactivate M
>     and å­çº¿ç¨‹æ‰§è¡Œ
>         JVM->>T: åˆ†é…CPUæ—¶é—´ç‰‡
>         activate T
>         T->>R: è°ƒç”¨run()æ–¹æ³•
>         activate R
>         R->>R: è¾“å‡º "t----->0"
>         R->>R: è¾“å‡º "t----->1"
>         R->>R: ... (ç»§ç»­æ‰§è¡Œ)
>         R->>R: è¾“å‡º "t----->99"
>         deactivate R
>         deactivate T
>     end
>     
>     Note over M,T: ä¸¤ä¸ªçº¿ç¨‹å¹¶å‘æ‰§è¡Œ<br/>è¾“å‡ºç»“æœäº¤æ›¿å‡ºç°
> ```
>
> **è¾“å‡ºç»“æœç¤ºä¾‹ï¼š**
>
> ```java
> main----->0
> t----->0
> main----->1
> t----->1
> main----->2
> t----->2
> ...
> main----->99
> t----->99
> ```







### ä¸¤ç§å®ç°æ–¹å¼çš„å¯¹æ¯”

```mermaid
sequenceDiagram
    participant M as Main Thread
    participant T1 as ç»§æ‰¿Threadæ–¹å¼
    participant R as Runnableå¯¹è±¡
    participant T2 as Threadå¯¹è±¡(Runnableæ–¹å¼)
    
    Note over M: æ–¹å¼1ï¼šç»§æ‰¿Threadç±»
    M->>T1: new MyThread()
    M->>T1: start()
    activate T1
    T1->>T1: ç›´æ¥æ‰§è¡Œè‡ªå·±çš„run()
    deactivate T1
    
    Note over M: æ–¹å¼2ï¼šå®ç°Runnableæ¥å£
    M->>R: new MyRunnable()
    M->>T2: new Thread(R)
    M->>T2: start()
    activate T2
    T2->>R: è°ƒç”¨Runnableçš„run()
    activate R
    deactivate R
    deactivate T2
```

**ä¸¤ç§æ–¹å¼çš„æ¯”è¾ƒ:**

| ç‰¹æ€§         | ç»§æ‰¿Threadç±»                    | å®ç°Runnableæ¥å£                          |
| :----------- | :------------------------------ | :---------------------------------------- |
| **ä»£ç ç»“æ„** | `class MyThread extends Thread` | `class MyRunnable implements Runnable`    |
| **çº¿ç¨‹åˆ›å»º** | `Thread t = new MyThread()`     | `Thread t = new Thread(new MyRunnable())` |
| **æ‰§è¡Œæ–¹å¼** | ç›´æ¥æ‰§è¡Œè‡ªå·±çš„run()æ–¹æ³•         | é€šè¿‡Threadè°ƒç”¨Runnableçš„run()æ–¹æ³•         |
| **ç»§æ‰¿é™åˆ¶** | å ç”¨ç»§æ‰¿åé¢                    | ä¸å ç”¨ç»§æ‰¿åé¢                            |
| **èµ„æºå…±äº«** | æ¯ä¸ªçº¿ç¨‹ç‹¬ç«‹å®ä¾‹                | å¤šä¸ªçº¿ç¨‹å¯å…±äº«åŒä¸€Runnableå®ä¾‹            |





### ä¼˜åŒ–æ–¹å¼äºŒ(åŒ¿åå†…éƒ¨ç±»åˆ›å»ºå¤šçº¿ç¨‹)

```java
åŒ¿åå†…éƒ¨ç±»å›é¡¾: 
  1.new æ¥å£/æŠ½è±¡ç±»(){
      é‡å†™æ–¹æ³•
  }.é‡å†™çš„æ–¹æ³•();

  2.æ¥å£å/ç±»å å¯¹è±¡å = new æ¥å£/æŠ½è±¡ç±»(){
      é‡å†™æ–¹æ³•
  }
    å¯¹è±¡å.é‡å†™çš„æ–¹æ³•();
```

```java
package com.powernode.javase.thread;

/**
 * é‡‡ç”¨åŒ¿åå†…éƒ¨ç±»çš„æ–¹å¼ï¼Œå°‘å†™ä¸€ä¸ªRunnableæ¥å£çš„å®ç°ç±»ã€‚
 */
public class ThreadTest04 {
    public static void main(String[] args) {
        // åˆ›å»ºçº¿ç¨‹å¯¹è±¡
        /*Thread t = new Thread(new Runnable() {
            @Override
            public void run() {
                for (int i = 0; i < 100; i++) {
                    System.out.println("t ---> " + i);
                }
            }
        });

        // å¯åŠ¨çº¿ç¨‹
        t.start();*/

        new Thread(new Runnable() {
            @Override
            public void run() {
                for (int i = 0; i < 100; i++) {
                    System.out.println("t--->" + i);
                }
            }
        }).start();

        for (int i = 0; i < 100; i++) {
            System.out.println("main ---> " + i);
        }
    }
}
```

> **è¾“å‡ºç»“æœç¤ºä¾‹ï¼š**
>
> ```java
> main ---> 0
> main ---> 1
> t--->0
> main ---> 2
> main ---> 3
> main ---> 4
> main ---> 5
> t--->1
> main ---> 6
> ...
> main----->99
> t----->99
> ```





### ç¬¬ä¸‰ç§æ–¹å¼ï¼šå®ç°Callableæ¥å£(å®ç°callæ–¹æ³•)

> [!NOTE]
>
> * â‘  ä¼˜ç‚¹ï¼šæ‰©å±•æ€§å¼ºï¼Œå®ç°è¯¥æ¥å£çš„åŒæ—¶è¿˜å¯ä»¥ç»§æ‰¿å…¶ä»–ç±»ã€‚
> * â‘¡ ç¼ºç‚¹ï¼šç¼–ç¨‹ç›¸å¯¹å¤æ‚ï¼Œä¸èƒ½ç›´æ¥ä½¿ç”¨ Thread ç±»ä¸­çš„æ–¹æ³•ã€‚

![ç¬¬ä¸‰ç§æ–¹å¼ï¼šå®ç°Callableæ¥å£(å®ç°callæ–¹æ³•)](./å¤šçº¿ç¨‹/img-14.jpg)

```java
package com.powernode.javase.thread24;

import java.util.concurrent.Callable;
import java.util.concurrent.FutureTask;

/**
 * å®ç°çº¿ç¨‹çš„ç¬¬ä¸‰ç§æ–¹å¼ï¼šå®ç°Callableæ¥å£ï¼Œå®ç°callæ–¹æ³•ã€‚
 * è¿™ç§æ–¹å¼å®ç°çš„çº¿ç¨‹ï¼Œæ˜¯å¯ä»¥è·å–åˆ°çº¿ç¨‹è¿”å›å€¼çš„ã€‚
 */
public class ThreadTest {
    public static void main(String[] args) {
        // åˆ›å»º"æœªæ¥ä»»åŠ¡"å¯¹è±¡
        FutureTask<Integer> task = new FutureTask<>(new Callable<Integer>() {
            @Override
            public Integer call() throws Exception {
                // å¤„ç†ä¸šåŠ¡......
                Thread.sleep(1000 * 5);
                return 1;
            }
        });

        // åˆ›å»ºçº¿ç¨‹å¯¹è±¡
        Thread t = new Thread(task);
        t.setName("t1");

        // å¯åŠ¨çº¿ç¨‹
        t.start();


        try {
            // è·å–â€œæœªæ¥ä»»åŠ¡â€çº¿ç¨‹çš„è¿”å›å€¼
            // é˜»å¡å½“å‰çº¿ç¨‹ï¼Œç­‰å¾…â€œæœªæ¥ä»»åŠ¡â€ç»“æŸå¹¶è¿”å›å€¼ã€‚
            // æ‹¿åˆ°è¿”å›å€¼ï¼Œå½“å‰çº¿ç¨‹çš„é˜»å¡æ‰ä¼šè§£é™¤ã€‚ç»§ç»­æ‰§è¡Œã€‚
            Integer i = task.get();
            System.out.println(i);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}


/*
class MyThread extends Thread {
    @Override
    public void run() {}
}

class MyRunnable implements Runnable {
    @Override
    public void run() {}
}*/
```

```java
1 (5såè¿”å›ç»“æœ)
```



```mermaid
sequenceDiagram
    participant M as Main Thread
    participant F as FutureTask
    participant T as Thread t1
    participant C as Callable

    Note over M: ç¨‹åºå¼€å§‹
    
    M->>F: new FutureTask<>(Callable)
    activate F
    F-->>M: è¿”å›FutureTaskå¯¹è±¡
    
    M->>T: new Thread(task)
    activate T
    T-->>M: è¿”å›Threadå¯¹è±¡
    
    M->>T: t.setName("t1")
    M->>T: t.start()
    
    Note over T: çº¿ç¨‹t1å¼€å§‹è¿è¡Œ
    
    M->>F: task.get()
    activate M
    Note over M: Mainçº¿ç¨‹é˜»å¡ç­‰å¾…
    
    T->>C: æ‰§è¡Œcall()æ–¹æ³•
    activate C
    Note over C: Thread.sleep(5000)<br/>æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†
    C-->>T: return 1
    deactivate C
    
    T->>F: è®¾ç½®è¿”å›å€¼1
    deactivate T
    
    F-->>M: è¿”å›ç»“æœ1
    deactivate M
    deactivate F
    
    Note over M: Mainçº¿ç¨‹ç»§ç»­æ‰§è¡Œ
    M->>M: System.out.println(i)
    
    Note over M: ç¨‹åºç»“æŸ
```

> **æ€»ç»“:**
>
> 1. **åˆå§‹åŒ–é˜¶æ®µ**ï¼š
>    - Mainçº¿ç¨‹åˆ›å»ºFutureTaskå¯¹è±¡ï¼Œä¼ å…¥CallableåŒ¿åå†…éƒ¨ç±»
>    - åˆ›å»ºThreadçº¿ç¨‹å¯¹è±¡ï¼Œå°†FutureTaskä½œä¸ºä»»åŠ¡ä¼ å…¥
>    - è®¾ç½®çº¿ç¨‹åå¹¶å¯åŠ¨çº¿ç¨‹
> 2. **æ‰§è¡Œé˜¶æ®µ**ï¼š
>    - Mainçº¿ç¨‹è°ƒç”¨`task.get()`æ–¹æ³•ï¼Œ**è¿›å…¥é˜»å¡çŠ¶æ€**ï¼Œç­‰å¾…è®¡ç®—ç»“æœ
>    - çº¿ç¨‹t1å¼€å§‹æ‰§è¡ŒCallableçš„call()æ–¹æ³•
>    - call()æ–¹æ³•ä¸­ç¡çœ 5ç§’æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†ï¼Œç„¶åè¿”å›ç»“æœ1
> 3. **ç»“æœè¿”å›é˜¶æ®µ**ï¼š
>    - çº¿ç¨‹t1å°†è®¡ç®—ç»“æœè®¾ç½®åˆ°FutureTaskä¸­
>    - FutureTaskå”¤é†’é˜»å¡çš„Mainçº¿ç¨‹
>    - Mainçº¿ç¨‹è·å–åˆ°è¿”å›å€¼1å¹¶æ‰“å°







### ç¬¬å››ç§æ–¹å¼ï¼šä½¿ç”¨çº¿ç¨‹æ± æŠ€æœ¯

```java
åˆ›å»ºçº¿ç¨‹çš„ç¬¬å››ç§æ–¹å¼ï¼šä½¿ç”¨çº¿ç¨‹æ± æŠ€æœ¯
 	1.çº¿ç¨‹æ± æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªç¼“å­˜ï¼šcache
    
 	2.ä¸€èˆ¬éƒ½æ˜¯æœåŠ¡å™¨åœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œåˆå§‹åŒ–çº¿ç¨‹æ± 
    
 	3.ä¹Ÿå°±æ˜¯è¯´æœåŠ¡å™¨åœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œåˆ›å»ºNå¤šä¸ªçº¿ç¨‹å¯¹è±¡
    
 	4.ç›´æ¥æ”¾åˆ°çº¿ç¨‹æ± ä¸­ï¼Œéœ€è¦ä½¿ç”¨çº¿ç¨‹å¯¹è±¡çš„æ—¶å€™ï¼Œç›´æ¥ä»çº¿ç¨‹æ± ä¸­è·å–ã€‚
```

**ä½¿ç”¨æ­¥éª¤ï¼š**

* â‘  `é€šè¿‡ Executors ç±»çš„é™æ€å·¥å‚æ–¹æ³•åˆ›å»ºçº¿ç¨‹æ± å¯¹è±¡`ã€‚
* â‘¡ `é€šè¿‡è°ƒç”¨çº¿ç¨‹æ± å¯¹è±¡çš„ submit()ã€execute()ã€invokeAny() ä»¥åŠ invokeAll() æ–¹æ³•å°†ä»»åŠ¡ï¼ˆçº¿ç¨‹ï¼‰åˆ†é…ç»™çº¿ç¨‹æ± å¯¹è±¡`ã€‚
* â‘¢ `å…³é—­çº¿ç¨‹æ± å¯¹è±¡`ã€‚

```java
package com.powernode.javase.thread25;

import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

public class ThreadTest {
    public static void main(String[] args) {
        // åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± å¯¹è±¡ï¼ˆçº¿ç¨‹æ± ä¸­æœ‰3ä¸ªçº¿ç¨‹ï¼‰
        ExecutorService executorService = Executors.newFixedThreadPool(3);

        // å°†ä»»åŠ¡äº¤ç»™çº¿ç¨‹æ± ï¼ˆä½ ä¸éœ€è¦è§¦ç¢°åˆ°è¿™ä¸ªçº¿ç¨‹å¯¹è±¡ï¼Œä½ åªéœ€è¦å°†è¦å¤„ç†çš„ä»»åŠ¡äº¤ç»™çº¿ç¨‹æ± å³å¯ã€‚ï¼‰
        executorService.submit(new Runnable() {
            @Override
            public void run() {
                for (int i = 0; i < 10; i++) {
                    System.out.println(Thread.currentThread().getName() + "--->" + i);
                }
            }
        });

        // æœ€åè®°å¾—å…³é—­çº¿ç¨‹æ± 
        executorService.shutdown();
    }
}
```

```java
pool-1-thread-1--->0
pool-1-thread-1--->1
pool-1-thread-1--->2
pool-1-thread-1--->3
pool-1-thread-1--->4
pool-1-thread-1--->5
pool-1-thread-1--->6
pool-1-thread-1--->7
pool-1-thread-1--->8
pool-1-thread-1--->9
```

```mermaid
sequenceDiagram
    participant M as Main Thread
    participant EP as Executors
    participant ES as ExecutorService
    participant WT as WorkerThread
    participant T as Task

    M->>EP: newFixedThreadPool(3)
    Note over EP: åˆ›å»ºåŒ…å«3ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± 
    EP-->>M: è¿”å›ExecutorServiceå®ä¾‹
    
    M->>ES: submit(Runnable Task)
    Note over ES: æ¥æ”¶ä»»åŠ¡å¹¶ç¼“å­˜
    
    ES->>WT: åˆ†é…ä»»åŠ¡ç»™å·¥ä½œçº¿ç¨‹
    activate WT
    
    WT->>T: run()
    activate T
    T->>T: æ‰§è¡Œå¾ªç¯æ‰“å°
    T-->>WT: ä»»åŠ¡æ‰§è¡Œå®Œæˆ
    deactivate T
    
    WT-->>ES: çº¿ç¨‹è¿”å›çº¿ç¨‹æ± ç­‰å¾…æ–°ä»»åŠ¡
    deactivate WT
    
    M->>ES: shutdown()
    Note over ES: åœæ­¢æ¥æ”¶æ–°ä»»åŠ¡ï¼Œç­‰å¾…ç°æœ‰ä»»åŠ¡å®Œæˆ
    ES-->>M: çº¿ç¨‹æ± å…³é—­å®Œæˆ
```

> **æ€»ç»“ï¼š**
>
> 1. **åˆå§‹åŒ–é˜¶æ®µ**ï¼š
>    - ä¸»çº¿ç¨‹é€šè¿‡ `Executors.newFixedThreadPool(3)` åˆ›å»ºçº¿ç¨‹æ± 
>    - çº¿ç¨‹æ± å†…éƒ¨åˆå§‹åŒ–3ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œä½†æ­¤æ—¶çº¿ç¨‹å¤„äºç­‰å¾…çŠ¶æ€
> 2. **ä»»åŠ¡æäº¤é˜¶æ®µ**ï¼š
>    - ä¸»çº¿ç¨‹è°ƒç”¨ `executorService.submit()` æäº¤Runnableä»»åŠ¡
>    - çº¿ç¨‹æ± æ¥æ”¶ä»»åŠ¡å¹¶å°†å…¶æ”¾å…¥ä»»åŠ¡é˜Ÿåˆ—
>    - çº¿ç¨‹æ± é€‰æ‹©ä¸€ä¸ªç©ºé—²çš„å·¥ä½œçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡
> 3. **ä»»åŠ¡æ‰§è¡Œé˜¶æ®µ**ï¼š
>    - å·¥ä½œçº¿ç¨‹è°ƒç”¨ä»»åŠ¡çš„ `run()` æ–¹æ³•
>    - æ‰§è¡Œå¾ªç¯æ‰“å°æ“ä½œ
>    - ä»»åŠ¡å®Œæˆåï¼Œå·¥ä½œçº¿ç¨‹è¿”å›åˆ°çº¿ç¨‹æ± ç­‰å¾…æ–°ä»»åŠ¡
> 4. **å…³é—­é˜¶æ®µ**ï¼š
>    - ä¸»çº¿ç¨‹è°ƒç”¨ `shutdown()` æ–¹æ³•
>    - çº¿ç¨‹æ± åœæ­¢æ¥æ”¶æ–°ä»»åŠ¡ï¼Œä½†ä¼šç­‰å¾…å·²æäº¤çš„ä»»åŠ¡æ‰§è¡Œå®Œæˆ
>    - æ‰€æœ‰ä»»åŠ¡å®Œæˆåï¼Œçº¿ç¨‹æ± æ­£å¼å…³é—­





## Threadç±»ä¸­çš„æ–¹æ³•

```java
void start() -> å¼€å¯çº¿ç¨‹,jvmè‡ªåŠ¨è°ƒç”¨runæ–¹æ³•
    
void run()  -> è®¾ç½®çº¿ç¨‹ä»»åŠ¡,è¿™ä¸ªrunæ–¹æ³•æ˜¯Threadé‡å†™çš„æ¥å£Runnableä¸­çš„runæ–¹æ³•
    
String getName()  -> è·å–çº¿ç¨‹åå­—
    
void setName(String name) -> ç»™çº¿ç¨‹è®¾ç½®åå­—
    
static Thread currentThread() -> è·å–æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹å¯¹è±¡(æ­¤æ–¹æ³•åœ¨å“ªä¸ªçº¿ç¨‹ä¸­ä½¿ç”¨,è·å–çš„å°±æ˜¯å“ªä¸ªçº¿ç¨‹å¯¹è±¡)   
```

```java
package com.powernode.javase.thread01;

/**
 * å…³äºçº¿ç¨‹ä¸­å¸¸ç”¨æ–¹æ³•ï¼š
 *      å®ä¾‹æ–¹æ³•ï¼š
 *          String getName();  è·å–çº¿ç¨‹å¯¹è±¡çš„åå­—
 *          void setName(String threadName); ä¿®æ”¹çº¿ç¨‹çš„åå­—
 *      é™æ€æ–¹æ³•ï¼š
 *          static Thread currentThread(); è·å–å½“å‰çº¿ç¨‹å¯¹è±¡çš„å¼•ç”¨ã€‚
 */
public class ThreadTest {
    public static void main(String[] args) {
        // è·å–å½“å‰çº¿ç¨‹å¯¹è±¡
        Thread mainThread = Thread.currentThread();

        // è·å–å½“å‰çº¿ç¨‹çš„åå­—
        System.out.println("ä¸»çº¿ç¨‹çš„åå­—ï¼š" + mainThread.getName()); // ä¸»çº¿ç¨‹çš„åå­—ï¼šmain

        // åˆ›å»ºçº¿ç¨‹å¯¹è±¡
        Thread t = new MyThread("tt");
        // ä¿®æ”¹çº¿ç¨‹çš„åå­—
        t.setName("t");
        // å¯åŠ¨çº¿ç¨‹
        t.start();

        // åˆ›å»ºçº¿ç¨‹å¯¹è±¡
        Thread t1 = new MyThread("tt1");
        // ä¿®æ”¹çº¿ç¨‹åå­—
        t1.setName("t1");
        // å¯åŠ¨çº¿ç¨‹
        t1.start();
    }
}

class MyThread extends Thread{

    public MyThread(String threadName) {
        super(threadName);
    }

    @Override
    public void run() {
        // è·å–å½“å‰çº¿ç¨‹å¯¹è±¡
        Thread t = Thread.currentThread();
        // è·å–å½“å‰çº¿ç¨‹å¯¹è±¡çš„åå­—
        System.out.println("åˆ†æ”¯çº¿ç¨‹çš„åå­—ï¼š" + t.getName()); // åˆ†æ”¯çº¿ç¨‹çš„åå­—ï¼šThread-0
    }
}
```

> **æµ‹è¯•:**
>
> ![Threadç±»ä¸­çš„æ–¹æ³•](./å¤šçº¿ç¨‹/img-8.jpg)







## çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ

> **`çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ`æŒ‡çš„æ˜¯ï¼šä»çº¿ç¨‹å¯¹è±¡æ–°å»ºï¼Œåˆ°æœ€ç»ˆçº¿ç¨‹æ­»äº¡çš„æ•´ä¸ªè¿‡ç¨‹ã€‚**

```java
1.NEW
	æ–°å»ºçŠ¶æ€
    
2.RUNNABLE
	å¯è¿è¡ŒçŠ¶æ€
	ç»†åˆ†çš„è¯ï¼Œåˆå¯ä»¥åˆ†ä¸ºä¸¤ä¸ªå­çŠ¶æ€ï¼š
	2.1å°±ç»ªçŠ¶æ€
	2.2è¿è¡ŒçŠ¶æ€
    
3.BLOCKED
	é˜»å¡çŠ¶æ€
	é‡åˆ°é”ä¹‹åè¿›å…¥é˜»å¡çŠ¶æ€ã€‚ï¼ˆä»€ä¹ˆæ˜¯é”ï¼ï¼ï¼ï¼‰
    
4.WAITING
	ç­‰å¾…çŠ¶æ€
	æ— æœŸé™çš„ç­‰å¾…ï¼Œæ²¡æœ‰æ—¶é•¿é™å®š
    
5.TIMED_WAITING
	è¶…æ—¶ç­‰å¾…çŠ¶æ€
	è¿™ç§ç­‰å¾…æ˜¯æœ‰æ—¶é•¿é™å®šçš„ã€‚
    
6.TERMINATED
	ç»ˆæ­¢çŠ¶æ€(æ­»äº¡çŠ¶æ€)
    
é¢è¯•çš„æ—¶å€™ï¼Œçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸè¯´å‡ ä¸ªçŠ¶æ€å‘¢ï¼Ÿä¸ƒä¸ªçŠ¶æ€ï¼š
	1ï¼æ–°å»ºçŠ¶æ€
	2ï¼å°±ç»ªçŠ¶æ€
	3ï¼Œè¿è¡ŒçŠ¶æ€
	4ï¼è¶…æ—¶ç­‰å¾…çŠ¶æ€
	5ï¼ç­‰å¾…çŠ¶æ€ï¼ˆç­‰åé¢å­¦ä¹ äº†çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ä¹‹åï¼Œå¯ä»¥æ·»åŠ è¿™ä¸ªçŠ¶æ€ã€‚wait()æ–¹æ³•ã€‚ï¼‰
	6ï¼é˜»å¡çŠ¶æ€ï¼ˆç­‰åé¢å­¦ä¹ äº†çº¿ç¨‹åŒæ­¥æœºåˆ¶ä¹‹åï¼Œå¯ä»¥æ·»åŠ è¿™ä¸ªçŠ¶æ€ã€‚ï¼‰
	7ï¼ç»ˆæ­¢çŠ¶æ€
```

![çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ](./å¤šçº¿ç¨‹/img-9.jpg)

```mermaid
graph TD
    A[æ–°å»ºçŠ¶æ€ NEW] -->|start| B[å°±ç»ªçŠ¶æ€ RUNNABLE]
    B -->|è·å¾—CPUæ—¶é—´ç‰‡| C[è¿è¡ŒçŠ¶æ€ RUNNING]
    C -->|æ—¶é—´ç‰‡ç”¨å®Œ| B
    C -->|Thread.sleep| D[è¶…æ—¶ç­‰å¾…çŠ¶æ€ TIMED_WAITING]
    D -->|æ—¶é—´åˆ°äº†| B
    C -->|Synchronized è·å–é”å¤±è´¥| E[é˜»å¡çŠ¶æ€ BLOCKED]
    E -->|è·å–åˆ°é”| B
    C -->|wait/æ— æœŸé™ç­‰å¾…| F[ç­‰å¾…çŠ¶æ€ WAITING]
    F -->|è¢«å”¤é†’| B
    C -->|runæ–¹æ³•ç»“æŸ| G[ç»ˆæ­¢çŠ¶æ€ TERMINATED]
    
    style A fill:#f9f9f9
    style B fill:#e3f2fd
    style C fill:#c8e6c9
    style D fill:#fff3e0
    style E fill:#ffebee
    style F fill:#fff8e1
    style G fill:#f5f5f5
```





### çº¿ç¨‹çš„sleepæ–¹æ³•

```java
å…³äºçº¿ç¨‹çš„sleepæ–¹æ³•ï¼š
       1. static void sleep(long millis)
           é™æ€æ–¹æ³•ï¼Œæ²¡æœ‰è¿”å›å€¼ï¼Œå‚æ•°æ˜¯ä¸€ä¸ªæ¯«ç§’ã€‚1ç§’ = 1000æ¯«ç§’
    
       2. è¿™ä¸ªæ–¹æ³•ä½œç”¨æ˜¯ï¼š
           è®©å½“å‰çº¿ç¨‹è¿›å…¥ä¼‘çœ ï¼Œä¹Ÿå°±æ˜¯è®©å½“å‰çº¿ç¨‹æ”¾å¼ƒå æœ‰çš„CPUæ—¶é—´ç‰‡ï¼Œè®©å…¶è¿›å…¥é˜»å¡çŠ¶æ€ã€‚
           æ„æ€ï¼šä½ åˆ«å†å ç”¨CPUäº†ï¼Œè®©ç»™å…¶ä»–çº¿ç¨‹å§ã€‚
           é˜»å¡å¤šä¹…å‘¢ï¼Ÿå‚æ•°æ¯«ç§’ä¸ºå‡†ã€‚åœ¨æŒ‡å®šçš„æ—¶é—´èŒƒå›´å†…ï¼Œå½“å‰çº¿ç¨‹æ²¡æœ‰æƒåˆ©æŠ¢å¤ºCPUæ—¶é—´ç‰‡äº†ã€‚
    
       3. æ€ä¹ˆç†è§£â€œå½“å‰çº¿ç¨‹â€å‘¢ï¼Ÿ
           Thread.sleep(1000); è¿™ä¸ªä»£ç å‡ºç°åœ¨å“ªä¸ªçº¿ç¨‹ä¸­ï¼Œå½“å‰çº¿ç¨‹å°±æ˜¯è¿™ä¸ªçº¿ç¨‹ã€‚
    
       4. runæ–¹æ³•åœ¨æ–¹æ³•é‡å†™çš„æ—¶å€™ï¼Œä¸èƒ½åœ¨æ–¹æ³•å£°æ˜ä½ç½®ä½¿ç”¨ throws æŠ›å‡ºå¼‚å¸¸ã€‚
    
       5. sleepæ–¹æ³•å¯ä»¥æ¨¡æ‹Ÿæ¯éš”å›ºå®šçš„æ—¶é—´è°ƒç”¨ä¸€æ¬¡ç¨‹åºã€‚
```

```java
package com.powernode.javase.thread02;

public class ThreadTest {
    public static void main(String[] args) {
        try {
            // è®©å½“å‰çº¿ç¨‹ç¡çœ 5ç§’
            // è¿™æ®µä»£ç å‡ºç°åœ¨ä¸»çº¿ç¨‹ä¸­ï¼Œæ‰€ä»¥å½“å‰çº¿ç¨‹å°±æ˜¯ä¸»çº¿ç¨‹
            // è®©ä¸»çº¿ç¨‹ç¡çœ 5ç§’
            Thread.sleep(1000);
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        }

        for (int i = 0; i < 10; i++) {
            System.out.println(Thread.currentThread().getName() + "===>" + i);
        }

        // å¯åŠ¨çº¿ç¨‹
        Thread t = new Thread(new MyRunnable());
        t.setName("t");
        t.start();
    }
}


class MyRunnable implements Runnable {

    @Override
    public void run() {
        for (int i = 0; i < 10; i++) {
            System.out.println(Thread.currentThread().getName() + "===>" + i);
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            }
        }
    }
}
```

```mermaid
sequenceDiagram
    participant M as Main Thread<br/>ä¸»çº¿ç¨‹
    participant T as Thread t<br/>çº¿ç¨‹t
    participant JVM as JVM Scheduler<br/>JVMè°ƒåº¦å™¨

    Note over M: ç¨‹åºå¼€å§‹ï¼Œä¸»çº¿ç¨‹è¿è¡Œ
    
    M->>M: è¾“å‡º"ä¸»çº¿ç¨‹å¼€å§‹ä¼‘çœ 5ç§’..."
    M->>M: Thread.sleep(5000)
    Note over M: è¿›å…¥TIMED_WAITINGçŠ¶æ€<br/>æŒç»­5ç§’
    
    JVM->>M: 5ç§’åå”¤é†’
    Note over M: å›åˆ°RUNNABLEçŠ¶æ€
    
    M->>M: è¾“å‡º"ä¸»çº¿ç¨‹ä¼‘çœ ç»“æŸï¼Œç»§ç»­æ‰§è¡Œ"
    M->>M: æ‰§è¡Œå¿«é€Ÿå¾ªç¯(0-9)
    Note over M: è¿ç»­è¾“å‡º10è¡Œï¼Œæ— å»¶è¿Ÿ
    
    M->>T: new Thread(new MyRunnable())
    Note over T: æ–°å»ºçŠ¶æ€ (NEW)
    
    M->>T: t.start()
    Note over T: è¿›å…¥RUNNABLEçŠ¶æ€
    
    M->>M: è¾“å‡º"ä¸»çº¿ç¨‹æ‰§è¡Œå®Œæ¯•"
    Note over M: ä¸»çº¿ç¨‹å¯èƒ½ç»“æŸæˆ–ç­‰å¾…
    
    loop 10æ¬¡å¾ªç¯
        JVM->>T: åˆ†é…CPUæ—¶é—´ç‰‡
        activate T
        T->>T: è¿›å…¥RUNNINGçŠ¶æ€
        T->>T: è¾“å‡º "t===>X"
        T->>T: Thread.sleep(1000)
        Note over T: è¿›å…¥TIMED_WAITINGçŠ¶æ€<br/>æŒç»­1ç§’
        
        JVM->>T: 1ç§’åå”¤é†’
        deactivate T
    end
    
    T->>T: è¾“å‡º"çº¿ç¨‹tæ‰§è¡Œå®Œæ¯•"
    Note over T: è¿›å…¥TERMINATEDçŠ¶æ€
```



```java
main===>0(main(ä¸»çº¿ç¨‹)ç¡çœ 5ç§’åå†æ‰§è¡Œ)
main===>1
main===>2
main===>3
main===>4
main===>5
main===>6
main===>7
main===>8
main===>9
t===>0(æ¯æ¬¡å¾ªç¯ç¡çœ 1ç§’)
t===>1
t===>2
t===>3
t===>4
t===>5
t===>6
t===>7
t===>8
t===>9
```





### sleepé¢è¯•é¢˜

> **å…³äºsleepçš„é¢è¯•é¢˜ï¼šä»¥ä¸‹ç¨‹åºä¸­ï¼Œæ˜¯`mainçº¿ç¨‹ä¼‘çœ 5ç§’`ï¼Œè¿˜æ˜¯`åˆ†æ”¯çº¿ç¨‹ä¼‘çœ 5ç§’`ï¼Ÿ**

```java
package com.powernode.javase.thread03;

public class ThreadTest {
    public static void main(String[] args) {
        MyThread t = new MyThread();
        t.setName("t");
        t.start();

        try {
            // è¿™è¡Œä»£ç å¹¶ä¸æ˜¯è®©tçº¿ç¨‹ç¡çœ ï¼Œè€Œæ˜¯è®©å½“å‰çº¿ç¨‹ç¡çœ ã€‚
            // å½“å‰çº¿ç¨‹æ˜¯mainçº¿ç¨‹ã€‚
            t.sleep(1000 * 5); // ç­‰åŒäºï¼šThread.sleep(1000 * 5);
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        }

        for (int i = 0; i < 100; i++) {
            System.out.println(Thread.currentThread().getName() + "===>" + i);
        }
    }
}

class MyThread extends Thread {
    @Override
    public void run(){
        for (int i = 0; i < 100; i++) {
            System.out.println(Thread.currentThread().getName() + "===>" + i);
        }
    }
}
```

```mermaid
sequenceDiagram
    participant M as Main Thread
    participant T as Thread t

    Note over M,T: åˆå§‹çŠ¶æ€
    M->>M: åˆ›å»ºMyThreadå¯¹è±¡ t
    M->>T: t.start()
    
    Note over M,T: çº¿ç¨‹å¯åŠ¨åå¹¶å‘æ‰§è¡Œ
    activate T
    T->>T: æ‰§è¡Œrun()æ–¹æ³•
    T->>T: è¾“å‡ºå¾ªç¯å†…å®¹
    
    M->>M: æ‰§è¡Œt.sleep(5000)
    Note right of M: sleepæ˜¯é™æ€æ–¹æ³•<br/>å®é™…è°ƒç”¨Thread.sleep(5000)
    
    Note over M: Mainçº¿ç¨‹ä¼‘çœ 5ç§’
    M-->>M: â¸ï¸ Sleeping for 5 seconds
    
    T->>T: ç»§ç»­æ‰§è¡Œrun()æ–¹æ³•
    T->>T: è¾“å‡ºå¾ªç¯å†…å®¹(ä¸å—å½±å“)
    
    Note over M: 5ç§’å
    M-->>M: â–¶ï¸ å”¤é†’ç»§ç»­æ‰§è¡Œ
    M->>M: æ‰§è¡Œforå¾ªç¯è¾“å‡º
    
    deactivate T
    Note over M,T: ç¨‹åºç»“æŸ
```

```java
t===>0
t===>1
t===>2
t===>3
...
t===>99
(mainçº¿ç¨‹ä¼‘çœ 5såå¼€å§‹æ‰§è¡Œ)
main===>0
main===>1
main===>2
main===>3
...
main===>99
```

> **ç»“è®º:**
>
> 1. **åˆå§‹é˜¶æ®µ**
>    - Mainçº¿ç¨‹åˆ›å»ºThread tå¯¹è±¡
>    - è°ƒç”¨t.start()å¯åŠ¨åˆ†æ”¯çº¿ç¨‹
> 2. **å¹¶å‘æ‰§è¡Œé˜¶æ®µ**
>    - Thread tç«‹å³å¼€å§‹æ‰§è¡Œrun()æ–¹æ³•
>    - Mainçº¿ç¨‹æ‰§è¡Œåˆ°`t.sleep(5000)`æ—¶ï¼Œå®é™…ä¸Šæ˜¯è°ƒç”¨é™æ€æ–¹æ³•`Thread.sleep(5000)`
> 3. **ä¼‘çœ é˜¶æ®µ**
>    - **Mainçº¿ç¨‹è¿›å…¥5ç§’ä¼‘çœ çŠ¶æ€**
>    - Thread tç»§ç»­æ­£å¸¸æ‰§è¡Œï¼Œä¸å—sleepå½±å“
> 4. **å”¤é†’åé˜¶æ®µ**
>    - Mainçº¿ç¨‹5ç§’åå”¤é†’ï¼Œç»§ç»­æ‰§è¡Œåç»­ä»£ç 
>    - ä¸¤ä¸ªçº¿ç¨‹éƒ½æ‰§è¡Œå„è‡ªçš„å¾ªç¯è¾“å‡º







### ä¸­æ–­çº¿ç¨‹çš„ç¡çœ 

> **æ€ä¹ˆä¸­æ–­ä¸€ä¸ªçº¿ç¨‹çš„ç¡çœ ã€‚ï¼ˆæ€ä¹ˆè§£é™¤çº¿ç¨‹å› sleepå¯¼è‡´çš„é˜»å¡ï¼Œè®©å…¶å¼€å§‹æŠ¢å¤ºCPUæ—¶é—´ç‰‡ã€‚ï¼‰**

```java
package com.powernode.javase.thread04;

public class ThreadTest {
    public static void main(String[] args) {
        // åˆ›å»ºçº¿ç¨‹å¯¹è±¡å¹¶å¯åŠ¨
        Thread t = new Thread(new Runnable(){
            @Override
            public void run() {
                System.out.println(Thread.currentThread().getName() + "===> begin");
                try {
                    // ç¡çœ ä¸€å¹´
                    Thread.sleep(1000 * 60 * 60 * 24 * 365);
                } catch (InterruptedException e) {
                    // æ‰“å°å¼‚å¸¸ä¿¡æ¯
                    //e.printStackTrace();
                    System.out.println("çŸ¥é“äº†ï¼Œè¿™å°±èµ·åºŠï¼");
                }
                // ç¡çœ ä¸€å¹´ä¹‹åï¼Œèµ·æ¥å¹²æ´»äº†
                System.out.println(Thread.currentThread().getName() + " do some!");
            }
        });

        // å¯åŠ¨çº¿ç¨‹
        t.start();

        // ä¸»çº¿ç¨‹
        // è¦æ±‚ï¼š5ç§’ä¹‹åï¼Œç¡çœ çš„Thread-0çº¿ç¨‹èµ·æ¥å¹²æ´»
        try {
            Thread.sleep(5*1000);
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        }

        // Thread-0èµ·æ¥å¹²æ´»äº†ã€‚
        // è¿™è¡Œä»£ç çš„ä½œç”¨æ˜¯ç»ˆæ­¢ t çº¿ç¨‹çš„ç¡çœ ã€‚
        // interruptæ–¹æ³•æ˜¯ä¸€ä¸ªå®ä¾‹æ–¹æ³•ã€‚
        // ä»¥ä¸‹ä»£ç å«ä¹‰ï¼štçº¿ç¨‹åˆ«ç¡äº†ã€‚
        // åº•å±‚å®ç°åŸç†æ˜¯åˆ©ç”¨äº†ï¼šå¼‚å¸¸å¤„ç†æœºåˆ¶ã€‚
        // å½“è°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œå¦‚æœtçº¿ç¨‹æ­£åœ¨ç¡çœ ï¼Œå¿…ç„¶ä¼šæŠ›å‡ºï¼šInterruptedExceptionï¼Œç„¶åæ•æ‰å¼‚å¸¸ï¼Œç»ˆæ­¢ç¡çœ ã€‚
        t.interrupt();
    }
}
```

```mermaid
sequenceDiagram
    participant M as ä¸»çº¿ç¨‹
    participant T as Thread-0çº¿ç¨‹

    M->>T: åˆ›å»ºå¹¶å¯åŠ¨çº¿ç¨‹
    T->>T: æ‰“å°"Thread-0===> begin"
    T->>T: è°ƒç”¨Thread.sleep(365å¤©)
    Note over T: è¿›å…¥TIMED_WAITINGçŠ¶æ€
    
    M->>M: è°ƒç”¨Thread.sleep(5ç§’)
    Note over M: ä¸»çº¿ç¨‹ç­‰å¾…5ç§’
    
    M-->>T: 5ç§’åè°ƒç”¨t.interrupt()
    Note over T: ä¸­æ–­çŠ¶æ€è¢«è®¾ç½®ï¼Œsleep()æŠ›å‡ºInterruptedException
    
    T->>T: æ•è·InterruptedException
    T->>T: æ‰“å°"çŸ¥é“äº†ï¼Œè¿™å°±èµ·åºŠï¼"
    T->>T: æ‰“å°"Thread-0 do some!"
    
    T->>T: çº¿ç¨‹è‡ªç„¶ç»“æŸ
    M->>M: ä¸»çº¿ç¨‹ç»“æŸ
```

```java
Thread-0===> begin
çŸ¥é“äº†ï¼Œè¿™å°±èµ·åºŠï¼
Thread-0 do some!
```

> **æ€»ç»“:**
>
> 1. **åˆå§‹çŠ¶æ€**ï¼š
>    - ä¸»çº¿ç¨‹åˆ›å»ºå¹¶å¯åŠ¨Thread-0çº¿ç¨‹
>    - Thread-0è¿›å…¥é•¿æ—¶é—´çš„ç¡çœ çŠ¶æ€
> 2. **ä¸­æ–­æœºåˆ¶**ï¼š
>    - `interrupt()`æ–¹æ³•å¹¶ä¸ä¼šç«‹å³åœæ­¢çº¿ç¨‹
>    - è€Œæ˜¯è®¾ç½®çº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ä½
>    - å½“çº¿ç¨‹åœ¨é˜»å¡çŠ¶æ€ï¼ˆå¦‚sleepï¼‰æ—¶ï¼Œä¼šç«‹å³æŠ›å‡º`InterruptedException`
> 3. **å¼‚å¸¸å¤„ç†**ï¼š
>    - Thread-0åœ¨sleepä¸­è¢«ä¸­æ–­æ—¶ï¼Œä¼šæŠ›å‡ºInterruptedException
>    - ç¨‹åºæ•è·å¼‚å¸¸åç»§ç»­æ‰§è¡Œåç»­ä»£ç 
>    - è¿™æ ·å°±å®ç°äº†"å”¤é†’"ç¡çœ çº¿ç¨‹çš„æ•ˆæœ
> 4. **çº¿ç¨‹çŠ¶æ€å˜åŒ–**ï¼š
>    - RUNNABLE â†’ TIMED_WAITING(sleep) â†’ RUNNABLE(è¢«ä¸­æ–­) â†’ TERMINATED
>
> **è¿™ç§æœºåˆ¶å¸¸ç”¨äºå®ç°çº¿ç¨‹çš„ä¼˜é›…ç»ˆæ­¢ï¼Œæ¯”å¦‚åœ¨éœ€è¦åœæ­¢åå°ä»»åŠ¡æ—¶ï¼Œé€šè¿‡ä¸­æ–­æ¥å”¤é†’æ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹ã€‚**





### ç»ˆæ­¢çº¿ç¨‹çš„æ‰§è¡Œ

> **ä¸€ä¸ªçº¿ç¨‹ t ä¸€ç›´åœ¨æ­£å¸¸çš„è¿è¡Œï¼Œå¦‚ä½•ç»ˆæ­¢ t çº¿ç¨‹çš„æ‰§è¡Œï¼ï¼ï¼ï¼**

#### æ–¹å¼ä¸€(å·²ç»è¿‡æ—¶)

```java
package com.powernode.javase.thread05;

public class ThreadTest {
    public static void main(String[] args) {
        Thread t = new Thread(new MyRunnable());

        t.setName("t");
        t.start();

        // 5ç§’ä¹‹åï¼Œtçº¿ç¨‹åœæ­¢ï¼
        try {
            Thread.sleep(5000);
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        }
        // ç»ˆæ­¢çº¿ç¨‹tçš„æ‰§è¡Œã€‚
        // ä»java2å¼€å§‹å°±ä¸å»ºè®®ä½¿ç”¨äº†ï¼Œå› ä¸ºè¿™ç§æ–¹å¼æ˜¯å¼ºè¡Œç»ˆæ­¢çº¿ç¨‹ã€‚å®¹æ˜“å¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚
        // æ²¡æœ‰ä¿å­˜çš„æ•°æ®ï¼Œåœ¨å†…å­˜ä¸­çš„æ•°æ®ä¸€å®šä¼šå› ä¸ºæ­¤æ–¹å¼å¯¼è‡´ä¸¢å¤±ã€‚
        t.stop();
    }
}


class MyRunnable implements Runnable {
    @Override
    public void run() {
        for (int i = 0; i < 10; i++) {
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            }
            System.out.println(Thread.currentThread().getName() + "===>" + i);
        }
    }
}
```





#### æ–¹å¼äºŒ(ä¼˜åŒ–å)

> **å¦‚ä½•åˆç†çš„ï¼Œæ­£å¸¸çš„æ–¹å¼`ç»ˆæ­¢ä¸€ä¸ªçº¿ç¨‹çš„æ‰§è¡Œ`ï¼Ÿ**
>
>  *      **ä¸€èˆ¬æˆ‘ä»¬åœ¨å®é™…å¼€å‘ä¸­ä¼šä½¿ç”¨`æ‰“æ ‡è®°`çš„æ–¹å¼ï¼Œæ¥ç»ˆæ­¢ä¸€ä¸ªçº¿ç¨‹çš„æ‰§è¡Œã€‚**

```java
package com.powernode.javase.thread06;

public class ThreadTest {
    public static void main(String[] args) {
        // åˆ›å»ºçº¿ç¨‹å¯¹è±¡
        MyRunnable mr = new MyRunnable();
        Thread t = new Thread(mr);

        t.setName("t");
        // å¯åŠ¨çº¿ç¨‹
        t.start();

        // 5ç§’ä¹‹åç»ˆæ­¢çº¿ç¨‹tçš„æ‰§è¡Œ
        try {
            Thread.sleep(5000);
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        }

        //ç»ˆæ­¢çº¿ç¨‹tçš„æ‰§è¡Œã€‚
        mr.run = false;
    }
}


class MyRunnable implements Runnable {
    /**
     * æ˜¯å¦ç»§ç»­æ‰§è¡Œçš„æ ‡è®°ã€‚
     * trueè¡¨ç¤ºï¼šç»§ç»­æ‰§è¡Œã€‚
     * falseè¡¨ç¤ºï¼šåœæ­¢æ‰§è¡Œã€‚
     */
    boolean run = true;

    @Override
    public void run() {
        for (int i = 0; i < 10; i++) {
            if (run) {
                System.out.println(Thread.currentThread().getName() + "==>" + i);
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    throw new RuntimeException(e);
                }
            } else {
                return;
            }
        }
    }
}
```

```mermaid
sequenceDiagram
    participant M as Main Thread
    participant T as Thread t
    participant R as MyRunnable(mr)

    Note over M: åˆ›å»ºçº¿ç¨‹å¯¹è±¡
    M->>R: new MyRunnable()
    M->>T: new Thread(mr)
    M->>T: setName("t")
    
    Note over M: å¯åŠ¨çº¿ç¨‹
    M->>T: start()
    
    Note over T: çº¿ç¨‹tå¼€å§‹æ‰§è¡Œ
    T->>R: run()
    
    loop å¾ªç¯æ‰§è¡Œ (i=0 to 9)
        R->>R: æ£€æŸ¥ run == true
        R->>M: è¾“å‡ºçº¿ç¨‹åå’Œè®¡æ•°
        R->>R: Thread.sleep(1000)
    end
    
    Note over M: 5ç§’åç»ˆæ­¢çº¿ç¨‹
    M->>M: Thread.sleep(5000)
    M->>R: mr.run = false
    
    Note over R: æ£€æµ‹åˆ°run=false
    R->>R: return (çº¿ç¨‹ç»ˆæ­¢)
```

```java
t==>0
t==>1
t==>2
t==>3
t==>4
(5ç§’ä¹‹åç»ˆæ­¢äº†çº¿ç¨‹tçš„æ‰§è¡Œ)
è¿›ç¨‹å·²ç»“æŸï¼Œé€€å‡ºä»£ç ä¸º 0
```

> **æ€»ç»“:**
>
> ### 1. **åˆå§‹åŒ–é˜¶æ®µ**
>
> - ä¸»çº¿ç¨‹åˆ›å»º `MyRunnable` å¯¹è±¡å’Œçº¿ç¨‹å¯¹è±¡
> - è®¾ç½®çº¿ç¨‹åå¹¶å¯åŠ¨çº¿ç¨‹
>
> ### 2. **çº¿ç¨‹æ‰§è¡Œé˜¶æ®µ**
>
> - çº¿ç¨‹tå¼€å§‹æ‰§è¡Œ`run()`æ–¹æ³•
> - åœ¨å¾ªç¯ä¸­ä¸æ–­æ£€æŸ¥`run`æ ‡å¿—ä½
> - æ¯æ¬¡å¾ªç¯è¾“å‡ºä¿¡æ¯å¹¶ç¡çœ 1ç§’
>
> ### 3. **ç»ˆæ­¢é˜¶æ®µ**
>
> - ä¸»çº¿ç¨‹ç¡çœ 5ç§’åï¼Œå°†`run`æ ‡å¿—è®¾ä¸º`false`
> - çº¿ç¨‹tåœ¨ä¸‹æ¬¡å¾ªç¯æ£€æŸ¥æ—¶å‘ç°`run`ä¸º`false`ï¼Œç«‹å³è¿”å›ç»ˆæ­¢æ‰§è¡Œ







## å®ˆæŠ¤çº¿ç¨‹

* è®¾ç½®å½“å‰çº¿ç¨‹ä¸ºå®ˆæŠ¤çº¿ç¨‹ï¼ˆåå°çº¿ç¨‹ï¼‰ï¼š

```java
public final void setDaemon(boolean on) {}
```

* åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼ˆåå°çº¿ç¨‹ï¼‰ï¼š

```java
public final boolean isDaemon() {}
```

> [!NOTE]
>
> * â‘  Java ä¸­é»˜è®¤åˆ›å»ºçš„çº¿ç¨‹æ˜¯éå®ˆæŠ¤çº¿ç¨‹ï¼ˆæ™®é€šçº¿ç¨‹ï¼Œç”¨æˆ·çº¿ç¨‹ï¼‰ã€‚
> * â‘¡ å¦‚æœä¸€ä¸ªåº”ç”¨ä¸­åªè¦æœ‰ä¸€ä¸ªæ™®é€šçº¿ç¨‹è¿˜åœ¨è¿è¡Œï¼Œåº”ç”¨ç¨‹åºå°±ä¸ä¼šé€€å‡ºï¼›åä¹‹ï¼Œåˆ™ä¼šé€€å‡ºã€‚
> * â‘¢ å®ˆæŠ¤çº¿ç¨‹ä¾èµ–äºæ™®é€šçº¿ç¨‹ï¼Œå½“æœ€åä¸€ä¸ªå‰å°çº¿ç¨‹ç»“æŸæ—¶ï¼Œæ‰€æœ‰åå°çº¿ç¨‹ç«‹å³ç»ˆæ­¢ã€‚
> * â‘£ Java ä¸­çš„ GC å°±æ˜¯å…¸å‹çš„å®ˆæŠ¤çº¿ç¨‹ã€‚

```java
1. åœ¨Javaè¯­è¨€ä¸­ï¼Œçº¿ç¨‹è¢«åˆ†ä¸ºä¸¤å¤§ç±»ï¼š
 	ç¬¬ä¸€ç±»ï¼šç”¨æˆ·çº¿ç¨‹ï¼ˆéå®ˆæŠ¤çº¿ç¨‹ï¼‰
 	ç¬¬äºŒç±»ï¼šå®ˆæŠ¤çº¿ç¨‹ï¼ˆåå°çº¿ç¨‹ï¼‰

2. åœ¨JVMå½“ä¸­ï¼Œæœ‰ä¸€ä¸ªéšè—çš„å®ˆæŠ¤çº¿ç¨‹ä¸€ç›´åœ¨å®ˆæŠ¤è€…ï¼Œå®ƒå°±æ˜¯GCçº¿ç¨‹ã€‚

3. å®ˆæŠ¤çº¿ç¨‹çš„ç‰¹ç‚¹ï¼šæ‰€æœ‰çš„ç”¨æˆ·çº¿ç¨‹ç»“æŸä¹‹åï¼Œå®ˆæŠ¤çº¿ç¨‹è‡ªåŠ¨é€€å‡º/ç»“æŸã€‚
 
4. å¦‚ä½•å°†ä¸€ä¸ªçº¿ç¨‹è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹ï¼Ÿ
	t.setDaemon(true);
```

```java
package com.powernode.javase.thread07;

public class ThreadTest {
    public static void main(String[] args) {
        // åˆ›å»ºçº¿ç¨‹
        MyThread myThread = new MyThread();
        myThread.setName("t");

        // åœ¨å¯åŠ¨çº¿ç¨‹ä¹‹å‰ï¼Œè®¾ç½®çº¿ç¨‹ä¸ºå®ˆæŠ¤çº¿ç¨‹
        myThread.setDaemon(true);

        // å¯åŠ¨çº¿ç¨‹
        myThread.start();

        // 10sç»“æŸï¼
        // mainçº¿ç¨‹ä¸­ï¼Œmainçº¿ç¨‹æ˜¯ä¸€ä¸ªç”¨æˆ·çº¿ç¨‹ã€‚
        for (int i = 0; i < 10; i++) {
            System.out.println(Thread.currentThread().getName() + "===>" + i);
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            }
        }
    }
}


class MyThread extends Thread {
    @Override
    public void run() {
        int i = 0;
        while (true) {
            System.out.println(Thread.currentThread().getName() + "==>" + (++i));
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            }
        }
    }
}
```

```mermaid
sequenceDiagram
    participant M as Main Thread<br/>(ç”¨æˆ·çº¿ç¨‹)
    participant T as Thread t<br/>(å®ˆæŠ¤çº¿ç¨‹)
    participant JVM as JVM

    Note over M: åˆ›å»ºå¹¶è®¾ç½®å®ˆæŠ¤çº¿ç¨‹
    M->>T: new MyThread()
    M->>T: setName("t")
    M->>T: setDaemon(true)
    M->>T: start()
    
    Note over T: å®ˆæŠ¤çº¿ç¨‹å¼€å§‹æ‰§è¡Œ
    T->>T: è¿›å…¥æ— é™å¾ªç¯
    
    par ä¸»çº¿ç¨‹æ‰§è¡Œ
        loop 10æ¬¡å¾ªç¯ (i=0 to 9)
            M->>M: è¾“å‡º main===>i
            M->>M: Thread.sleep(1000)
        end
        M->>JVM: ä¸»çº¿ç¨‹ç»“æŸ
    and å®ˆæŠ¤çº¿ç¨‹æ‰§è¡Œ
        loop æ— é™å¾ªç¯
            T->>T: è¾“å‡º t==>è®¡æ•°
            T->>T: Thread.sleep(1000)
        end
    end
    
    Note over JVM: æ£€æµ‹æ‰€æœ‰ç”¨æˆ·çº¿ç¨‹ç»“æŸ
    JVM->>T: å¼ºåˆ¶ç»ˆæ­¢å®ˆæŠ¤çº¿ç¨‹
    JVM->>JVM: ç¨‹åºé€€å‡º
```

```java
main===>0
t==>1
main===>1
t==>2
main===>2
t==>3
t==>4
main===>3
main===>4
t==>5
main===>5
t==>6
t==>7
main===>6
main===>7
t==>8
main===>8
t==>9
main===>9
t==>10
t==>11
```

> **æ€»ç»“:**
>
> ### 1. **åˆå§‹åŒ–é˜¶æ®µ**
>
> - ä¸»çº¿ç¨‹åˆ›å»º`MyThread`å¯¹è±¡
> - è®¾ç½®çº¿ç¨‹åä¸º"t"
> - **å…³é”®æ­¥éª¤**ï¼šè°ƒç”¨`setDaemon(true)`å°†çº¿ç¨‹è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹
> - å¯åŠ¨çº¿ç¨‹
>
> ### 2. **å¹¶å‘æ‰§è¡Œé˜¶æ®µ**
>
> - **ä¸»çº¿ç¨‹**ï¼šæ‰§è¡Œ10æ¬¡å¾ªç¯ï¼Œæ¯æ¬¡ç¡çœ 1ç§’
> - **å®ˆæŠ¤çº¿ç¨‹t**ï¼šæ‰§è¡Œæ— é™å¾ªç¯ï¼Œæ¯æ¬¡ç¡çœ 1ç§’
>
> ### 3. **ç»ˆæ­¢é˜¶æ®µ**
>
> - ä¸»çº¿ç¨‹å®Œæˆ10æ¬¡å¾ªç¯åè‡ªç„¶ç»“æŸ
> - JVMæ£€æµ‹åˆ°**æ‰€æœ‰ç”¨æˆ·çº¿ç¨‹**ï¼ˆè¿™é‡Œåªæœ‰mainçº¿ç¨‹ï¼‰éƒ½å·²ç»“æŸ
> - JVM**å¼ºåˆ¶ç»ˆæ­¢**æ‰€æœ‰å®ˆæŠ¤çº¿ç¨‹ï¼ˆåŒ…æ‹¬çº¿ç¨‹tï¼‰
> - ç¨‹åºé€€å‡º





## å®šæ—¶ä»»åŠ¡(è®°å½•æ—¥å¿—)

```java
1. JDKä¸­æä¾›çš„å®šæ—¶ä»»åŠ¡ï¼š
      java.util.Timer         å®šæ—¶å™¨
      java.util.TimerTask     å®šæ—¶ä»»åŠ¡
    
2. å®šæ—¶å™¨ + å®šæ—¶ä»»åŠ¡ï¼šå¯ä»¥å¸®æˆ‘ä»¬åœ¨ç¨‹åºä¸­å®Œæˆï¼šæ¯é—´éš”å¤šä¹…æ‰§è¡Œä¸€æ¬¡æŸæ®µç¨‹åºã€‚

3. Timerçš„æ„é€ æ–¹æ³•ï¼š
      Timer()
      Timer(boolean isDaemon) isDaemonæ˜¯trueè¡¨ç¤ºè¯¥å®šæ—¶å™¨æ˜¯ä¸€ä¸ªå®ˆæŠ¤çº¿ç¨‹ã€‚
```

```java
package com.powernode.javase.thread08;

import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.Timer;
import java.util.TimerTask;

public class ThreadTest {
    public static void main(String[] args) throws Exception {
        // åˆ›å»ºå®šæ—¶å™¨å¯¹è±¡ï¼ˆæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼‰
        // å¦‚æœè¿™ä¸ªå®šæ—¶å™¨æ‰§è¡Œçš„ä»»åŠ¡æ˜¯ä¸€ä¸ªåå°ä»»åŠ¡ï¼Œæ˜¯ä¸€ä¸ªå®ˆæŠ¤ä»»åŠ¡ï¼Œå»ºè®®å°†å…¶å®šä¹‰ä¸ºå®ˆæŠ¤çº¿ç¨‹ã€‚
        Timer timer = new Timer(true);

        // æŒ‡å®šå®šæ—¶ä»»åŠ¡
        SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
        Date firstTime = sdf.parse("2025-11-9 15:13:00");
        //timer.schedule(å®šæ—¶ä»»åŠ¡,ç¬¬ä¸€æ¬¡æ‰§è¡Œæ—¶é—´,é—´éš”å¤šä¹…ä¸€æ¬¡);
        //timer.schedule(new LogTimerTask(), firstTime, 1000);

        // åŒ¿åå†…éƒ¨ç±»çš„æ–¹å¼
        timer.schedule(new TimerTask() {
            int count = 0;

            @Override
            public void run() {
                // æ‰§è¡Œä»»åŠ¡
                Date now = new Date();
                String strTime = sdf.format(now);
                System.out.println(strTime + ": " + count++);
            }
        },firstTime,1000*5);

        for (int i = 0; i < 10; i++) {
            Thread.sleep(1000);
        }
    }
}
```

```mermaid
sequenceDiagram
    participant M as Main Thread
    participant T as Timer Thread<br/>(å®ˆæŠ¤çº¿ç¨‹)
    participant TT as TimerTask<br/>(åŒ¿åå†…éƒ¨ç±»)

    Note over M: åˆ›å»ºå®šæ—¶å™¨ï¼ˆå®ˆæŠ¤çº¿ç¨‹ï¼‰
    M->>T: new Timer(true)
    
    Note over M: è®¾ç½®å®šæ—¶ä»»åŠ¡
    M->>T: schedule(TimerTask, firstTime, 5000)
    
    Note over T: å®šæ—¶å™¨çº¿ç¨‹å¯åŠ¨
    T->>T: ç­‰å¾…é¦–æ¬¡æ‰§è¡Œæ—¶é—´"2025-11-9 15:13:00"
    
    Note over T: é¦–æ¬¡æ‰§è¡Œæ—¶é—´åˆ°è¾¾
    T->>TT: run()
    TT->>TT: åˆ›å»ºDateå¯¹è±¡è·å–å½“å‰æ—¶é—´
    TT->>TT: æ ¼å¼åŒ–æ—¶é—´å­—ç¬¦ä¸²
    TT->>M: è¾“å‡º"æ—¶é—´å­—ç¬¦ä¸²: count"
    
    loop æ¯éš”5ç§’æ‰§è¡Œ
        T->>TT: run()
        TT->>TT: count++å¹¶è¾“å‡º
        T->>T: ç­‰å¾…5ç§’
    end
    
    Note over M: ä¸»çº¿ç¨‹æ‰§è¡Œ10ç§’
    loop 10æ¬¡
        M->>M: Thread.sleep(1000)
    end
    
    Note over M: ä¸»çº¿ç¨‹ç»“æŸ
    Note over T: JVMæ£€æµ‹åˆ°ç”¨æˆ·çº¿ç¨‹ç»“æŸ<br/>å¼ºåˆ¶ç»ˆæ­¢å®šæ—¶å™¨å®ˆæŠ¤çº¿ç¨‹
```

```java
2025-11-09 15:19:31: 0
2025-11-09 15:19:36: 1
2025-11-09 15:19:41: 2

è¿›ç¨‹å·²ç»“æŸï¼Œé€€å‡ºä»£ç ä¸º 0
```

> **æ€»ç»“:**
>
> **åˆå§‹åŒ–é˜¶æ®µ**
>
> - ä¸»çº¿ç¨‹åˆ›å»º`Timer`å¯¹è±¡ï¼Œå‚æ•°`true`è¡¨ç¤ºè®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹
> - è°ƒç”¨`schedule()`æ–¹æ³•è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼š
>   - **å®šæ—¶ä»»åŠ¡**ï¼šåŒ¿åå†…éƒ¨ç±»å®ç°çš„`TimerTask`
>   - **é¦–æ¬¡æ‰§è¡Œæ—¶é—´**ï¼š`2025-11-9 15:13:00`
>   - **æ‰§è¡Œé—´éš”**ï¼š5ç§’ï¼ˆ5000æ¯«ç§’ï¼‰
>
> **å®šæ—¶å™¨å·¥ä½œé˜¶æ®µ**
>
> - å®šæ—¶å™¨çº¿ç¨‹ï¼ˆå®ˆæŠ¤çº¿ç¨‹ï¼‰å¯åŠ¨å¹¶ç­‰å¾…é¦–æ¬¡æ‰§è¡Œæ—¶é—´
> - å½“ç³»ç»Ÿæ—¶é—´åˆ°è¾¾æŒ‡å®šæ—¶é—´æ—¶ï¼Œæ‰§è¡Œç¬¬ä¸€æ¬¡ä»»åŠ¡
> - ä¹‹åæ¯éš”5ç§’è‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡ä»»åŠ¡
> - æ¯æ¬¡æ‰§è¡Œï¼š
>   - è·å–å½“å‰æ—¶é—´å¹¶æ ¼å¼åŒ–
>   - è¾“å‡ºæ—¶é—´å­—ç¬¦ä¸²å’Œè®¡æ•°å™¨å€¼
>   - è®¡æ•°å™¨è‡ªå¢
>
> **ç¨‹åºç»ˆæ­¢é˜¶æ®µ**
>
> - ä¸»çº¿ç¨‹æ‰§è¡Œ10ç§’åç»“æŸ
> - JVMæ£€æµ‹åˆ°æ‰€æœ‰ç”¨æˆ·çº¿ç¨‹ç»“æŸ
> - å¼ºåˆ¶ç»ˆæ­¢å®šæ—¶å™¨å®ˆæŠ¤çº¿ç¨‹
> - ç¨‹åºé€€å‡º
>
> **å…³é”®ç‰¹ç‚¹ï¼š**
>
> **Timeræ„é€ æ–¹æ³•**ï¼š
>
> - `Timer()` - åˆ›å»ºç”¨æˆ·çº¿ç¨‹å®šæ—¶å™¨
> - `Timer(boolean isDaemon)` - åˆ›å»ºå®ˆæŠ¤çº¿ç¨‹å®šæ—¶å™¨
>
> **scheduleæ–¹æ³•å‚æ•°**ï¼š
>
> 1. **TimerTask** - è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼ˆæŠ½è±¡ç±»ï¼Œéœ€å®ç°runæ–¹æ³•ï¼‰
> 2. **firstTime** - é¦–æ¬¡æ‰§è¡Œæ—¶é—´ï¼ˆDateå¯¹è±¡ï¼‰
> 3. **period** - æ‰§è¡Œé—´éš”ï¼ˆæ¯«ç§’ï¼‰
>
> **å®ˆæŠ¤çº¿ç¨‹çš„ä¼˜åŠ¿**ï¼š
>
> - å½“åº”ç”¨ç¨‹åºä¸»çº¿ç¨‹ç»“æŸæ—¶ï¼Œå®šæ—¶å™¨è‡ªåŠ¨åœæ­¢
> - é¿å…ç¨‹åºæ— æ³•æ­£å¸¸é€€å‡ºçš„é—®é¢˜
> - é€‚åˆæ‰§è¡Œåå°æ¸…ç†ã€ç›‘æ§ç­‰éå…³é”®ä»»åŠ¡





## çº¿ç¨‹åˆå¹¶

```java
1. è°ƒç”¨join()æ–¹æ³•å®Œæˆçº¿ç¨‹åˆå¹¶ã€‚
    
2. join()æ–¹æ³•æ˜¯ä¸€ä¸ªå®ä¾‹æ–¹æ³•ã€‚ï¼ˆä¸æ˜¯é™æ€æ–¹æ³•ï¼‰ t.join

3. å‡è®¾åœ¨mainæ–¹æ³•ï¼ˆmainçº¿ç¨‹ï¼‰ä¸­è°ƒç”¨äº† t.join()ï¼Œåæœæ˜¯ä»€ä¹ˆï¼Ÿ
		tçº¿ç¨‹åˆå¹¶åˆ°ä¸»çº¿ç¨‹ä¸­ã€‚ä¸»çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ã€‚ç›´åˆ° t çº¿ç¨‹æ‰§è¡Œç»“æŸã€‚ä¸»çº¿ç¨‹é˜»å¡è§£é™¤ã€‚
    
4. t.join()æ–¹æ³•å…¶å®æ˜¯è®©å½“å‰çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œç›´åˆ°tçº¿ç¨‹ç»“æŸï¼Œå½“å‰çº¿ç¨‹é˜»å¡è§£é™¤ã€‚
    
5. å’Œsleepæ–¹æ³•æœ‰ç‚¹ç±»ä¼¼ï¼Œä½†ä¸ä¸€æ ·ï¼š
	ç¬¬ä¸€ï¼šsleepæ–¹æ³•æ˜¯é™æ€æ–¹æ³•ï¼Œjoinæ˜¯å®ä¾‹æ–¹æ³•ã€‚
	ç¬¬äºŒï¼šsleepæ–¹æ³•å¯ä»¥æŒ‡å®šç¡çœ çš„æ—¶é•¿ï¼Œjoinæ–¹æ³•ä¸èƒ½ä¿è¯é˜»å¡çš„æ—¶é•¿ã€‚
	ç¬¬ä¸‰ï¼šsleepå’Œjoinæ–¹æ³•éƒ½æ˜¯è®©å½“å‰çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ã€‚
	ç¬¬å››ï¼šsleepæ–¹æ³•çš„é˜»å¡è§£é™¤æ¡ä»¶ï¼Ÿæ—¶é—´è¿‡å»äº†ã€‚ joinæ–¹æ³•çš„é˜»å¡è§£é™¤æ¡ä»¶ï¼Ÿè°ƒç”¨joinæ–¹æ³•çš„é‚£ä¸ªçº¿ç¨‹ç»“æŸäº†ã€‚
```

```java
package com.powernode.javase.thread09;

public class ThreadTest {
    public static void main(String[] args) throws InterruptedException {
        Thread t = new MyThread();
        t.setName("t");
        t.start();

        System.out.println("main begin");

        // åˆå¹¶çº¿ç¨‹
        // tåˆå¹¶åˆ°mainçº¿ç¨‹ä¸­ã€‚
        // mainçº¿ç¨‹å—åˆ°é˜»å¡ï¼ˆå½“å‰çº¿ç¨‹å—åˆ°é˜»å¡ï¼‰
        // tçº¿ç¨‹ç»§ç»­æ‰§è¡Œï¼Œç›´åˆ°tçº¿ç¨‹ç»“æŸã€‚mainçº¿ç¨‹é˜»å¡è§£é™¤ï¼ˆå½“å‰çº¿ç¨‹é˜»å¡è§£é™¤ï¼‰ã€‚
        // t.join();

        // joinæ–¹æ³•ä¹Ÿå¯ä»¥æœ‰å‚æ•°ï¼Œå‚æ•°æ˜¯æ¯«ç§’ã€‚
        // ä»¥ä¸‹ä»£ç è¡¨ç¤º t çº¿ç¨‹åˆå¹¶åˆ° å½“å‰çº¿ç¨‹ï¼Œåˆå¹¶æ—¶é•¿ 10 æ¯«ç§’
        // é˜»å¡å½“å‰çº¿ç¨‹ 10 æ¯«ç§’
        //t.join(10);

        // è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œæ˜¯æƒ³è®©å½“å‰çº¿ç¨‹å—é˜»10ç§’
        // ä½†ä¸ä¸€å®šï¼Œå¦‚æœåœ¨æŒ‡å®šçš„é˜»å¡æ—¶é—´å†…ï¼Œtçº¿ç¨‹ç»“æŸäº†ã€‚å½“å‰çº¿ç¨‹é˜»å¡ä¹Ÿä¼šè§£é™¤ã€‚
        t.join(1000 * 10);

        // å½“å‰çº¿ç¨‹ä¼‘çœ 10ç§’ã€‚
        //Thread.sleep(1000 * 10);

        // ä¸»çº¿ç¨‹
        for (int i = 0; i <= 100; i++) {
            System.out.println(Thread.currentThread().getName() + "==>" + i);
        }

        System.out.println("main over");
    }
}


class MyThread extends Thread {
    @Override
    public void run() {
        for (int i = 0; i <= 100; i++) {
            System.out.println(Thread.currentThread().getName() + "==>" + i);
        }
    }
}
```

```mermaid
sequenceDiagram
    participant M as Main Thread
    participant T as Thread t

    Note over M: åˆ›å»ºå¹¶å¯åŠ¨çº¿ç¨‹t
    M->>T: new MyThread()
    M->>T: setName("t")
    M->>T: start()
    
    M->>M: è¾“å‡º "main begin"
    
    Note over M: è°ƒç”¨t.join(10000)
    M->>M: è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œæœ€å¤šç­‰å¾…10ç§’
    
    par çº¿ç¨‹tæ‰§è¡Œ
        loop i=0 to 100
            T->>M: è¾“å‡º "t==>i"
        end
        Note over T: çº¿ç¨‹tæ‰§è¡Œå®Œæˆ
        T->>M: çº¿ç¨‹ç»“æŸä¿¡å·
    and ä¸»çº¿ç¨‹ç­‰å¾…
        Note over M: ç­‰å¾…æ¡ä»¶ï¼š<br/>1. çº¿ç¨‹tç»“æŸ<br/>2. æˆ–10ç§’è¶…æ—¶
    end
    
    alt çº¿ç¨‹tåœ¨10ç§’å†…å®Œæˆ
        M->>M: ç«‹å³è§£é™¤é˜»å¡
    else çº¿ç¨‹tæœªåœ¨10ç§’å†…å®Œæˆ
        M->>M: 10ç§’åè¶…æ—¶è§£é™¤é˜»å¡
    end
    
    Note over M: ä¸»çº¿ç¨‹ç»§ç»­æ‰§è¡Œ
    loop i=0 to 100
        M->>M: è¾“å‡º "main==>i"
    end
    
    M->>M: è¾“å‡º "main over"
```

```java
main begin
(mainçº¿ç¨‹å—åˆ°é˜»å¡ï¼ˆå½“å‰çº¿ç¨‹å—åˆ°é˜»å¡ï¼‰)
t==>0
t==>1
t==>2
...
t==>100
(tçº¿ç¨‹ç»§ç»­æ‰§è¡Œï¼Œç›´åˆ°tçº¿ç¨‹ç»“æŸã€‚mainçº¿ç¨‹é˜»å¡è§£é™¤ï¼ˆå½“å‰çº¿ç¨‹é˜»å¡è§£é™¤ï¼‰)
main==>0
main==>1
...
main==>100
main over
```

> **æ€»ç»“:**
>
> ## æ—¶åºå›¾è¯¦ç»†è§£é‡Šï¼š
>
> ### 1. **åˆå§‹åŒ–é˜¶æ®µ**
>
> - ä¸»çº¿ç¨‹åˆ›å»ºå¹¶å¯åŠ¨çº¿ç¨‹t
> - ä¸»çº¿ç¨‹è¾“å‡º"main begin"
>
> ### 2. **çº¿ç¨‹åˆå¹¶é˜¶æ®µ** - å…³é”®éƒ¨åˆ†
>
> - ä¸»çº¿ç¨‹è°ƒç”¨`t.join(10000)`ï¼Œè¿›å…¥é˜»å¡çŠ¶æ€
> - **é˜»å¡æ¡ä»¶**ï¼šä¸»çº¿ç¨‹ç­‰å¾…çº¿ç¨‹tç»“æŸï¼Œæœ€å¤šç­‰å¾…10ç§’
> - çº¿ç¨‹tç»§ç»­ç‹¬ç«‹æ‰§è¡Œå¾ªç¯
>
> ### 3. **è§£é™¤é˜»å¡é˜¶æ®µ**
>
> - **æƒ…å†µ1**ï¼šçº¿ç¨‹tåœ¨10ç§’å†…å®Œæˆæ‰§è¡Œ â†’ ä¸»çº¿ç¨‹ç«‹å³è§£é™¤é˜»å¡
> - **æƒ…å†µ2**ï¼šçº¿ç¨‹tæœªåœ¨10ç§’å†…å®Œæˆ â†’ ä¸»çº¿ç¨‹10ç§’åè¶…æ—¶è§£é™¤é˜»å¡
>
> ### 4. **ç»§ç»­æ‰§è¡Œé˜¶æ®µ**
>
> - ä¸»çº¿ç¨‹è§£é™¤é˜»å¡åç»§ç»­æ‰§è¡Œè‡ªå·±çš„å¾ªç¯
> - è¾“å‡º"main over"åç¨‹åºç»“æŸ
>
> 
>
> **joinæ–¹æ³•çš„ä¸‰ç§å½¢å¼ï¼š**
>
> 1. **æ— å‚join()**
>
> ```java
> t.join(); // æ— é™æœŸç­‰å¾…ï¼Œç›´åˆ°çº¿ç¨‹tç»“æŸ
> ```
>
> 2. **å¸¦æ¯«ç§’å‚æ•°çš„join(long millis)**
>
> ```java
> t.join(10000); // æœ€å¤šç­‰å¾…10ç§’
> ```
>
> 3. **å¸¦æ¯«ç§’å’Œçº³ç§’å‚æ•°çš„join(long millis, int nanos)**
>
> ```java
> t.join(10000, 500000); // æœ€å¤šç­‰å¾…10ç§’500çº³ç§’
> ```
>
> **joinæ–¹æ³•ä¸sleepæ–¹æ³•çš„å¯¹æ¯”ï¼š**
>
> | ç‰¹æ€§         | join()                   | sleep()                  |
> | :----------- | :----------------------- | :----------------------- |
> | **æ–¹æ³•ç±»å‹** | å®ä¾‹æ–¹æ³•                 | é™æ€æ–¹æ³•                 |
> | **é˜»å¡æ—¶é•¿** | ä¸ç¡®å®šï¼ˆä¾èµ–ç›®æ ‡çº¿ç¨‹ï¼‰   | ç¡®å®šï¼ˆæŒ‡å®šæ—¶é—´ï¼‰         |
> | **é˜»å¡æ¡ä»¶** | ç›®æ ‡çº¿ç¨‹ç»“æŸ             | æ—¶é—´åˆ°è¾¾                 |
> | **ä¸­æ–­å“åº”** | æ”¯æŒInterruptedException | æ”¯æŒInterruptedException |
> | **ç”¨é€”**     | çº¿ç¨‹ä¾èµ–æ‰§è¡Œé¡ºåº         | å®šæ—¶ç­‰å¾…ã€å»¶è¿Ÿæ‰§è¡Œ       |







## JVMè°ƒåº¦



### çº¿ç¨‹ä¼˜å…ˆçº§

```java
1. ä¼˜å…ˆçº§
    
2. çº¿ç¨‹æ˜¯å¯ä»¥è®¾ç½®ä¼˜å…ˆçº§çš„ï¼Œä¼˜å…ˆçº§è¾ƒé«˜çš„ï¼Œè·å¾—CPUæ—¶é—´ç‰‡çš„æ€»ä½“æ¦‚ç‡é«˜ä¸€äº›ã€‚
    
3. JVMé‡‡ç”¨çš„æ˜¯æŠ¢å å¼è°ƒåº¦æ¨¡å‹ã€‚è°çš„ä¼˜å…ˆçº§é«˜ï¼Œè·å–CPUæ—¶é—´ç‰‡çš„æ€»ä½“æ¦‚ç‡å°±é«˜ã€‚
    
4. é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸€ä¸ªçº¿ç¨‹çš„ä¼˜å…ˆçº§æ˜¯ 5
    
5. æœ€ä½æ˜¯1ï¼Œæœ€é«˜æ˜¯10
```

```java
package com.powernode.javase.thread10;

public class ThreadTest {
    public static void main(String[] args) {
        /*System.out.println("æœ€ä½ä¼˜å…ˆçº§ï¼š" + Thread.MIN_PRIORITY);
        System.out.println("æœ€é«˜ä¼˜å…ˆçº§ï¼š" + Thread.MAX_PRIORITY);
        System.out.println("é»˜è®¤ä¼˜å…ˆçº§ï¼š" + Thread.NORM_PRIORITY);

        // è·å–mainçº¿ç¨‹çš„ä¼˜å…ˆçº§
        Thread mainThread = new Thread();

        System.out.println("mainçº¿ç¨‹çš„ä¼˜å…ˆçº§ï¼š" + mainThread.getPriority()); // 5

        // è®¾ç½®ä¼˜å…ˆçº§
        mainThread.setPriority(Thread.MAX_PRIORITY);

        System.out.println("mainçº¿ç¨‹çš„ä¼˜å…ˆçº§ï¼š" + mainThread.getPriority()); // 10*/

        Thread t1 = new MyThread();
        t1.setName("t1");

        Thread t2 = new MyThread();
        t2.setName("t2");

        t1.setPriority(Thread.MAX_PRIORITY);
        t2.setPriority(Thread.MIN_PRIORITY);

        // å¯åŠ¨çº¿ç¨‹
        t1.start();
        t2.start();
    }
}

class MyThread extends Thread {
    @Override
    public void run() {
        for (int i = 0; i <= 1000; i++) {
            System.out.println(Thread.currentThread().getName() + "==>" + i);
        }
    }
}
```

```mermaid
sequenceDiagram
    participant M as Main Thread
    participant T1 as Thread t1<br/>(ä¼˜å…ˆçº§=10)
    participant T2 as Thread t2<br/>(ä¼˜å…ˆçº§=1)
    participant S as JVM Scheduler

    Note over M: åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹
    M->>T1: new MyThread()
    M->>T1: setName("t1")
    M->>T2: new MyThread()
    M->>T2: setName("t2")
    
    Note over M: è®¾ç½®çº¿ç¨‹ä¼˜å…ˆçº§
    M->>T1: setPriority(MAX_PRIORITY=10)
    M->>T2: setPriority(MIN_PRIORITY=1)
    
    Note over M: å¯åŠ¨çº¿ç¨‹
    M->>T1: start()
    M->>T2: start()
    
    Note over S: JVMè°ƒåº¦å™¨å¼€å§‹å·¥ä½œ
    Note over S: åŸºäºæŠ¢å å¼è°ƒåº¦æ¨¡å‹
    
    loop çº¿ç¨‹æ‰§è¡Œå‘¨æœŸ
        S->>S: é€‰æ‹©ä¸‹ä¸€ä¸ªè¿è¡Œçš„çº¿ç¨‹
        alt ä¼˜å…ˆé€‰æ‹©é«˜ä¼˜å…ˆçº§çº¿ç¨‹
            S->>T1: åˆ†é…CPUæ—¶é—´ç‰‡
            T1->>T1: æ‰§è¡Œå¾ªç¯è¾“å‡º
        else å¶å°”é€‰æ‹©ä½ä¼˜å…ˆçº§çº¿ç¨‹
            S->>T2: åˆ†é…CPUæ—¶é—´ç‰‡
            T2->>T2: æ‰§è¡Œå¾ªç¯è¾“å‡º
        end
    end
    
    Note over T1, T2: ä¸¤ä¸ªçº¿ç¨‹å¹¶å‘æ‰§è¡Œ<br/>t1è·å¾—æ›´å¤šCPUæ—¶é—´ç‰‡
```

```java
t2==>0
t2==>1
t1==>0
t2==>2
t1==>1
t2==>3
...
t1==>1000
...
t2==>1000
```

> **æ€»ç»“:**
>
> ### 1. **åˆå§‹åŒ–é˜¶æ®µ**
>
> - ä¸»çº¿ç¨‹åˆ›å»ºä¸¤ä¸ª`MyThread`å¯¹è±¡
> - åˆ†åˆ«è®¾ç½®çº¿ç¨‹åç§°ä¸º"t1"å’Œ"t2"
>
> ### 2. **ä¼˜å…ˆçº§è®¾ç½®é˜¶æ®µ** - å…³é”®éƒ¨åˆ†
>
> - è®¾ç½®t1çº¿ç¨‹ä¸ºæœ€é«˜ä¼˜å…ˆçº§ï¼ˆ10ï¼‰
> - è®¾ç½®t2çº¿ç¨‹ä¸ºæœ€ä½ä¼˜å…ˆçº§ï¼ˆ1ï¼‰
>
> ### 3. **çº¿ç¨‹å¯åŠ¨é˜¶æ®µ**
>
> - å¯åŠ¨ä¸¤ä¸ªçº¿ç¨‹ï¼Œå®ƒä»¬è¿›å…¥å°±ç»ªçŠ¶æ€
> - JVMè°ƒåº¦å™¨å¼€å§‹å·¥ä½œ
>
> ### 4. **è°ƒåº¦æ‰§è¡Œé˜¶æ®µ**
>
> - JVMåŸºäº**æŠ¢å å¼è°ƒåº¦æ¨¡å‹**åˆ†é…CPUæ—¶é—´ç‰‡
> - ä¼˜å…ˆçº§è¾ƒé«˜çš„t1çº¿ç¨‹**æ€»ä½“æ¦‚ç‡ä¸Š**è·å¾—æ›´å¤šCPUæ—¶é—´ç‰‡
> - ä¼˜å…ˆçº§è¾ƒä½çš„t2çº¿ç¨‹è·å¾—è¾ƒå°‘CPUæ—¶é—´ç‰‡
> - ä¸¤ä¸ªçº¿ç¨‹å¹¶å‘æ‰§è¡Œå¾ªç¯è¾“å‡º







### çº¿ç¨‹çš„è®©ä½

```java
1. è®©ä½
    
2. é™æ€æ–¹æ³•ï¼šThread.yield()
    
3. è®©å½“å‰çº¿ç¨‹è®©ä½ã€‚
    
4. æ³¨æ„ï¼šè®©ä½ä¸ä¼šè®©å…¶è¿›å…¥é˜»å¡çŠ¶æ€ã€‚åªæ˜¯æ”¾å¼ƒç›®å‰å æœ‰çš„CPUæ—¶é—´ç‰‡ï¼Œè¿›å…¥å°±ç»ªçŠ¶æ€ï¼Œç»§ç»­æŠ¢å¤ºCPUæ—¶é—´ç‰‡ã€‚
    
5. åªèƒ½ä¿è¯å¤§æ–¹å‘ä¸Šçš„ï¼Œå¤§æ¦‚ç‡ï¼Œåˆ°äº†æŸä¸ªç‚¹è®©ä½ä¸€æ¬¡ã€‚
```

```java
package com.powernode.javase.thread11;

public class ThreadTest {
    public static void main(String[] args) {
        Thread t1 = new MyThread();
        t1.setName("t1");

        Thread t2 = new MyThread();
        t2.setName("t2");

        t1.start();
        t2.start();
    }
}

class MyThread extends Thread {
    @Override
    public void run() {
        for (int i = 0; i <= 100; i++) {
            if (Thread.currentThread().getName().equals("t1") && i % 10 == 0) {
                System.out.println(Thread.currentThread().getName() + "è®©ä½äº†ï¼Œæ­¤æ—¶çš„iä¸‹æ ‡æ˜¯ï¼š" + i);
                // å½“å‰çº¿ç¨‹è®©ä½ï¼Œè¿™ä¸ªå½“å‰çº¿ç¨‹ä¸€å®šæ˜¯t1
                // t1ä¼šè®©ä½ä¸€æ¬¡
                Thread.yield();
            }
            System.out.println(Thread.currentThread().getName() + "==>" + i);
        }
    }
}
```

```mermaid
sequenceDiagram
    participant Main as ä¸»çº¿ç¨‹
    participant T1 as çº¿ç¨‹t1
    participant T2 as çº¿ç¨‹t2
    participant Scheduler as çº¿ç¨‹è°ƒåº¦å™¨

    Note over Main: ç¨‹åºå¯åŠ¨
    
    Main->>T1: åˆ›å»ºå¹¶å¯åŠ¨t1
    Main->>T2: åˆ›å»ºå¹¶å¯åŠ¨t2
    
    Note over T1, T2: ä¸¤ä¸ªçº¿ç¨‹å¼€å§‹å¹¶å‘æ‰§è¡Œ
    
    loop t1å¾ªç¯ i=0 to 100
        T1->>T1: æ‰§è¡Œå¾ªç¯ä½“
        alt i % 10 == 0 (æ¯10æ¬¡)
            T1->>T1: è¾“å‡ºè®©ä½ä¿¡æ¯
            T1->>Scheduler: Thread.yield()<br/>ä¸»åŠ¨è®©å‡ºCPU
            Scheduler->>T2: å¯èƒ½åˆ‡æ¢åˆ°t2æ‰§è¡Œ
        else å…¶ä»–æƒ…å†µ
            T1->>T1: æ­£å¸¸è¾“å‡ºiçš„å€¼
        end
    end
    
    loop t2å¾ªç¯ i=0 to 100
        T2->>T2: æ‰§è¡Œå¾ªç¯ä½“
        T2->>T2: æ­£å¸¸è¾“å‡ºiçš„å€¼<br/>(t2ä¸ä¼šè°ƒç”¨yield)
    end
    
    Note over Scheduler: çº¿ç¨‹è°ƒåº¦å™¨è´Ÿè´£<br/>åœ¨t1ã€t2é—´åˆ‡æ¢
    
    T1-->>Main: t1æ‰§è¡Œå®Œæˆ
    T2-->>Main: t2æ‰§è¡Œå®Œæˆ
```

```java
t2==>0
t2==>1
t2==>2
t2==>3
t2==>4
t2==>5
t1è®©ä½äº†ï¼Œæ­¤æ—¶çš„iä¸‹æ ‡æ˜¯ï¼š0
t2==>6
t2==>7
t2==>8
t1==>0
t2==>9
t1==>1
t2==>10
t1==>2
t2==>11
t2==>12
t2==>13
t2==>14
t2==>15
t2==>16
t2==>17
t2==>18
t1==>3
t2==>19
t1==>4
t1==>5
t1==>6
t1==>7
t1==>8
t1==>9
t2==>20
t1è®©ä½äº†ï¼Œæ­¤æ—¶çš„iä¸‹æ ‡æ˜¯ï¼š10
t2==>21
```

> **æ€»ç»“:**
>
> 1. **åˆå§‹é˜¶æ®µ**
>
> - ä¸»çº¿ç¨‹åˆ›å»ºå¹¶å¯åŠ¨t1ã€t2ä¸¤ä¸ªçº¿ç¨‹
> - ä¸¤ä¸ªçº¿ç¨‹è¿›å…¥å°±ç»ªçŠ¶æ€ï¼Œç­‰å¾…CPUæ—¶é—´ç‰‡
>
> 2. **å¹¶å‘æ‰§è¡Œé˜¶æ®µ**
>
> - **t1çº¿ç¨‹**ï¼šæ¯10æ¬¡å¾ªç¯(i%10==0)æ—¶ï¼š
>   - è¾“å‡ºè®©ä½ä¿¡æ¯
>   - è°ƒç”¨`Thread.yield()`ä¸»åŠ¨è®©å‡ºCPU
>   - è¿›å…¥å°±ç»ªçŠ¶æ€ï¼Œé‡æ–°å‚ä¸CPUç«äº‰
> - **t2çº¿ç¨‹**ï¼šå§‹ç»ˆæ­£å¸¸æ‰§è¡Œå¾ªç¯ï¼Œä¸ä¸»åŠ¨è®©ä½
>
> 3. **çº¿ç¨‹è°ƒåº¦**
>
> - çº¿ç¨‹è°ƒåº¦å™¨è´Ÿè´£åœ¨t1ã€t2ä¹‹é—´åˆ†é…CPUæ—¶é—´ç‰‡
> - å½“t1è°ƒç”¨yield()æ—¶ï¼Œè°ƒåº¦å™¨å¯èƒ½ï¼ˆä½†ä¸æ˜¯å¿…ç„¶ï¼‰åˆ‡æ¢åˆ°t2æ‰§è¡Œ
> - ä¸¤ä¸ªçº¿ç¨‹äº¤æ›¿æ‰§è¡Œï¼Œç›´åˆ°å„è‡ªå¾ªç¯ç»“æŸ
>
> 4. **æ‰§è¡Œç»“æœç‰¹ç‚¹**
>
> - t1çš„è¾“å‡ºä¼šå‡ºç°"è®©ä½äº†"çš„æç¤ºä¿¡æ¯
> - ä¸¤ä¸ªçº¿ç¨‹çš„è¾“å‡ºä¼šäº¤é”™å‡ºç°
> - t1è®©ä½æ—¶ï¼Œt2å¯èƒ½è·å¾—æ›´å¤šæ‰§è¡Œæœºä¼š
> - ä½†ç”±äºçº¿ç¨‹è°ƒåº¦çš„ä¸ç¡®å®šæ€§ï¼Œå…·ä½“æ‰§è¡Œé¡ºåºæ¯æ¬¡è¿è¡Œå¯èƒ½ä¸åŒ









## çº¿ç¨‹å®‰å…¨

```java
1. ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Ÿ
          æ¡ä»¶1ï¼šå¤šçº¿ç¨‹çš„å¹¶å‘ç¯å¢ƒä¸‹
          æ¡ä»¶2ï¼šæœ‰å…±äº«çš„æ•°æ®
          æ¡ä»¶3ï¼šå…±äº«æ•°æ®æ¶‰åŠåˆ°ä¿®æ”¹çš„æ“ä½œ

2. ä¸€èˆ¬æƒ…å†µä¸‹ï¼š
	å±€éƒ¨å˜é‡ä¸å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚ï¼ˆå°¤å…¶æ˜¯åŸºæœ¬æ•°æ®ç±»å‹ä¸å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ã€åœ¨æ ˆä¸­ï¼Œæ ˆä¸æ˜¯å…±äº«çš„ã€‘ï¼Œå¦‚æœæ˜¯å¼•ç”¨æ•°æ®ç±»å‹ï¼Œå°±å¦è¯´äº†ï¼ï¼‰
	å®ä¾‹å˜é‡å¯èƒ½å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚å®ä¾‹å˜é‡åœ¨å †ä¸­ã€‚å †æ˜¯å¤šçº¿ç¨‹å…±äº«çš„ã€‚
	é™æ€å˜é‡ä¹Ÿå¯èƒ½å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚é™æ€å˜é‡åœ¨å †ä¸­ã€‚å †æ˜¯å¤šçº¿ç¨‹å…±äº«çš„ã€‚
```



### çº¿ç¨‹å¼‚æ­¥æœºåˆ¶

![çº¿ç¨‹å®‰å…¨](./å¤šçº¿ç¨‹/img-10.jpg)

```java
1. å¤§å®¶æ‰¾ä¸€ä¸ªç°å®ç”Ÿæ´»ä¸­çš„ä¾‹å­ï¼Œæ¥è¯´æ˜ä¸€ä¸‹ï¼Œçº¿ç¨‹å®‰å…¨é—®é¢˜ï¼šæ¯”å¦‚åŒæ—¶å–é’±ï¼
    
2. ä»¥ä¸Šå¤šçº¿ç¨‹å¹¶å‘å¯¹åŒä¸€ä¸ªè´¦æˆ·è¿›è¡Œå–æ¬¾æ“ä½œçš„æ—¶å€™ï¼Œæœ‰å®‰å…¨é—®é¢˜ï¼Ÿæ€ä¹ˆè§£å†³ï¼Ÿ
	è®©çº¿ç¨‹t1å’Œçº¿ç¨‹t2æ’é˜Ÿæ‰§è¡Œã€‚ä¸è¦å¹¶å‘ã€‚è¦æ’é˜Ÿã€‚
	æˆ‘ä»¬æŠŠçº¿ç¨‹æ’é˜Ÿæ‰§è¡Œï¼Œå«åšï¼šçº¿ç¨‹åŒæ­¥æœºåˆ¶ã€‚ï¼ˆt1å’Œt2çº¿ç¨‹ï¼Œt1çº¿ç¨‹åœ¨æ‰§è¡Œçš„æ—¶å€™å¿…é¡»ç­‰å¾…t2çº¿ç¨‹æ‰§è¡Œåˆ°æŸä¸ªä½ç½®ä¹‹åï¼Œt1çº¿ç¨‹æ‰èƒ½æ‰§è¡Œã€‚åªè¦t1å’Œt2ä¹‹é—´å‘ç”Ÿäº†ç­‰å¾…ï¼Œå°±è®¤ä¸ºæ˜¯åŒæ­¥ã€‚ï¼‰
	å¦‚æœä¸æ’é˜Ÿï¼Œæˆ‘ä»¬å°†å…¶ç§°ä¸ºï¼šçº¿ç¨‹å¼‚æ­¥æœºåˆ¶ã€‚ï¼ˆt1å’Œt2å„è‡ªæ‰§è¡Œå„è‡ªçš„ï¼Œè°ä¹Ÿä¸éœ€è¦ç­‰å¯¹æ–¹ã€‚å¹¶å‘çš„ï¼Œå°±è®¤ä¸ºæ˜¯å¼‚æ­¥ï¼‰
	å¼‚æ­¥ï¼šæ•ˆç‡é«˜ã€‚ä½†æ˜¯å¯èƒ½å­˜åœ¨å®‰å…¨éšæ‚£ã€‚
	åŒæ­¥ï¼šæ•ˆç‡ä½ã€‚æ’é˜Ÿäº†ã€‚å¯ä»¥ä¿è¯æ•°æ®çš„å®‰å…¨é—®é¢˜ã€‚
    
3. ä»¥ä¸‹ç¨‹åºå­˜åœ¨å®‰å…¨é—®é¢˜ã€‚t1å’Œt2çº¿ç¨‹åŒæ—¶å¯¹actä¸€ä¸ªè´¦å·è¿›è¡Œå–æ¬¾æ“ä½œã€‚æ•°æ®æ˜¯é”™è¯¯çš„ã€‚
```

![çº¿ç¨‹å®‰å…¨](./å¤šçº¿ç¨‹/img-11.jpg)

![çº¿ç¨‹å®‰å…¨](./å¤šçº¿ç¨‹/img-12.jpg)

```java
package com.powernode.javase.thread12;

public class ThreadTest {
    public static void main(String[] args) {
        // åˆ›å»ºè´¦æˆ·å¯¹è±¡
        Account act = new Account("act-001",10000);

        // åˆ›å»ºçº¿ç¨‹å¯¹è±¡1
        Thread t1 = new Thread(new Withdraw(act));

        // åˆ›å»ºçº¿ç¨‹å¯¹è±¡2
        Thread t2 = new Thread(new Withdraw(act));

        // å¯åŠ¨çº¿ç¨‹
        t1.start();
        t2.start();
    }
}


class Withdraw implements Runnable{

    // å®ä¾‹å˜é‡(å…±äº«æ•°æ®)
    private Account act;

    public Withdraw(Account act) {
        this.act = act;
    }

    @Override
    public void run() {
        act.withdraw(1000);
    }
}


class Account {
    /**
     * è´¦å·
     */
    private String actNo;
    /**
     * ä½™é¢
     */
    private double balance;

    public Account(String actNo, double balance) {
        this.actNo = actNo;
        this.balance = balance;
    }

    public String getActNo() {
        return actNo;
    }

    public void setActNo(String actNo) {
        this.actNo = actNo;
    }

    public double getBalance() {
        return balance;
    }

    public void setBalance(double balance) {
        this.balance = balance;
    }


    /**
     * å–æ¬¾çš„æ–¹æ³•
     *
     * @param money å–æ¬¾é¢åº¦
     */
    public void withdraw(double money) {
        //this.setBalance(this.getBalance()-money);
        // æƒ³è¦æ¼”ç¤ºå‡ºå¤šçº¿ç¨‹å¹¶å‘å¸¦æ¥çš„å®‰å…¨é—®é¢˜ï¼Œè¿™é‡Œå»ºè®®åˆ†ä¸ºä¸¤æ­¥å»å®Œæˆå–æ¬¾æ“ä½œã€‚
        // ç¬¬ä¸€æ­¥ï¼šè¯»å–ä½™é¢
        double before = this.getBalance();
        System.out.println(Thread.currentThread().getName() + "çº¿ç¨‹æ­£åœ¨å–æ¬¾" + money + "ï¼Œå½“å‰" + this.getActNo() + "è´¦æˆ·ä½™é¢" + before);

        // ä¼‘çœ 1s
        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        }

        // ç¬¬äºŒæ­¥ï¼šä¿®æ”¹ä½™é¢
        this.setBalance(before - money);
        System.out.println(Thread.currentThread().getName() + "çº¿ç¨‹å–æ¬¾æˆåŠŸï¼Œå½“å‰" + this.getActNo() + "è´¦æˆ·ä½™é¢" + this.getBalance());
    }
}
```





### çº¿ç¨‹åŒæ­¥æœºåˆ¶

```java
1. çº¿ç¨‹åŒæ­¥çš„æœ¬è´¨æ˜¯ï¼šçº¿ç¨‹æ’é˜Ÿæ‰§è¡Œå°±æ˜¯åŒæ­¥æœºåˆ¶ã€‚
    
2. è¯­æ³•æ ¼å¼ï¼š
       synchronized(å¿…é¡»æ˜¯éœ€è¦æ’é˜Ÿçš„è¿™å‡ ä¸ªçº¿ç¨‹å…±äº«çš„å¯¹è±¡){
          // éœ€è¦åŒæ­¥çš„ä»£ç 
       }
 
           â€œå¿…é¡»æ˜¯éœ€è¦æ’é˜Ÿçš„è¿™å‡ ä¸ªçº¿ç¨‹å…±äº«çš„å¯¹è±¡â€ è¿™ä¸ªå¿…é¡»é€‰å¯¹äº†ã€‚
           è¿™ä¸ªå¦‚æœé€‰é”™äº†ï¼Œå¯èƒ½ä¼šæ— æ•…å¢åŠ åŒæ­¥çš„çº¿ç¨‹æ•°é‡ï¼Œå¯¼è‡´æ•ˆç‡é™ä½ã€‚
               
3. åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ
       synchronized(obj){
          // åŒæ­¥ä»£ç å—
       }
    å‡è®¾objæ˜¯t1 t2ä¸¤ä¸ªçº¿ç¨‹å…±äº«çš„ã€‚
    t1å’Œt2æ‰§è¡Œè¿™ä¸ªä»£ç çš„æ—¶å€™ï¼Œä¸€å®šæ˜¯æœ‰ä¸€ä¸ªå…ˆæŠ¢åˆ°äº†CPUæ—¶é—´ç‰‡ã€‚ä¸€å®šæ˜¯æœ‰å…ˆåé¡ºåºçš„ã€‚
    å‡è®¾t1å…ˆæŠ¢åˆ°äº†CPUæ—¶é—´ç‰‡ã€‚t1çº¿ç¨‹æ‰¾å…±äº«å¯¹è±¡objçš„å¯¹è±¡é”ï¼Œæ‰¾åˆ°ä¹‹åï¼Œåˆ™å æœ‰è¿™æŠŠé”ã€‚åªè¦èƒ½å¤Ÿå æœ‰objå¯¹è±¡çš„å¯¹è±¡é”ï¼Œå°±æœ‰æƒåˆ©è¿›å…¥åŒæ­¥ä»£ç å—æ‰§è¡Œä»£ç ã€‚
    å½“t1çº¿ç¨‹æ‰§è¡Œå®ŒåŒæ­¥ä»£ç å—ä¹‹åï¼Œä¼šé‡Šæ”¾ä¹‹å‰å æœ‰çš„å¯¹è±¡é”ï¼ˆå½’è¿˜é”ï¼‰ã€‚
    åŒæ ·ï¼Œt2çº¿ç¨‹æŠ¢åˆ°CPUæ—¶é—´ç‰‡ä¹‹åï¼Œä¹Ÿå¼€å§‹æ‰§è¡Œï¼Œä¹Ÿä¼šå»æ‰¾å…±äº«å¯¹è±¡objçš„å¯¹è±¡é”ï¼Œä½†ç”±äº t1çº¿ç¨‹å æœ‰è¿™æŠŠé”ï¼Œt2çº¿ç¨‹åªèƒ½åœ¨åŒæ­¥ä»£ç å—ä¹‹å¤–ç­‰å¾…ã€‚

4. æ³¨æ„åŒæ­¥ä»£ç å—çš„èŒƒå›´ï¼Œä¸è¦æ— æ•…æ‰©å¤§åŒæ­¥çš„èŒƒå›´ï¼ŒåŒæ­¥ä»£ç å—èŒƒå›´è¶Šå°ï¼Œæ•ˆç‡è¶Šé«˜ã€‚
```

```java
package com.powernode.javase.thread13;

public class ThreadTest {
    public static void main(String[] args) {
        // åˆ›å»ºè´¦æˆ·å¯¹è±¡
        Account act = new Account("act-001",10000);
        // åˆ›å»ºçº¿ç¨‹å¯¹è±¡1
        Thread t1 = new Thread(new Withdraw(act));
        // åˆ›å»ºçº¿ç¨‹å¯¹è±¡2
        Thread t2 = new Thread(new Withdraw(act));

        // å¯åŠ¨çº¿ç¨‹
        t1.start();
        t2.start();
    }
}

// å–æ¬¾çš„çº¿ç¨‹ç±»
class Withdraw implements Runnable{

    // å®ä¾‹å˜é‡ï¼ˆå…±äº«æ•°æ®ï¼‰
    private Account act;

    public Withdraw(Account act) {
        this.act = act;
    }

    @Override
    public void run() {
        act.withdraw(1000);
    }
}


// é“¶è¡Œè´¦æˆ·
class Account{

    private static Object obj = new Object();
    /**
     * è´¦å·
     */
    private String actNo;
    /**
     * ä½™é¢
     */
    private double balance;

    public Account(String actNo, double balance) {
        this.actNo = actNo;
        this.balance = balance;
    }

    public String getActNo() {
        return actNo;
    }

    public void setActNo(String actNo) {
        this.actNo = actNo;
    }

    public double getBalance() {
        return balance;
    }

    public void setBalance(double balance) {
        this.balance = balance;
    }

    /**
     * å–æ¬¾çš„æ–¹æ³•
     * @param money å–æ¬¾é¢åº¦
     */
    public void withdraw(double money){
        // thisæ˜¯å½“å‰è´¦æˆ·å¯¹è±¡
        // å½“å‰è´¦æˆ·å¯¹è±¡actï¼Œå°±æ˜¯t1å’Œt2å…±äº«çš„å¯¹è±¡ã€‚
        synchronized (this){
            //synchronized (obj) {
            // ç¬¬ä¸€æ­¥ï¼šè¯»å–ä½™é¢
            double before = this.getBalance();
            System.out.println(Thread.currentThread().getName() + "çº¿ç¨‹æ­£åœ¨å–æ¬¾"+money+"ï¼Œå½“å‰"+this.getActNo()+"è´¦æˆ·ä½™é¢" + before);

            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            }

            // ç¬¬äºŒæ­¥ï¼šä¿®æ”¹ä½™é¢
            this.setBalance(before - money);
            System.out.println(Thread.currentThread().getName() + "çº¿ç¨‹å–æ¬¾æˆåŠŸï¼Œå½“å‰"+this.getActNo()+"è´¦æˆ·ä½™é¢" + this.getBalance());
        }
    }
}
```

```mermaid
sequenceDiagram
    participant Main as ä¸»çº¿ç¨‹
    participant T1 as çº¿ç¨‹1
    participant T2 as çº¿ç¨‹2
    participant Account as è´¦æˆ·å¯¹è±¡
    
    Main->>Account: åˆ›å»ºè´¦æˆ·(act-001, 10000)
    Main->>T1: åˆ›å»ºçº¿ç¨‹1(å…±äº«è´¦æˆ·)
    Main->>T2: åˆ›å»ºçº¿ç¨‹2(å…±äº«è´¦æˆ·)
    Main->>T1: start()
    Main->>T2: start()
    
    Note over T1,T2: çº¿ç¨‹å¼€å§‹ç«äº‰é”
    
    T1->>Account: å°è¯•è·å–å¯¹è±¡é”
    Note right of T1: è·å–é”æˆåŠŸ
    
    T2->>Account: å°è¯•è·å–å¯¹è±¡é”
    Note right of T2: è·å–é”å¤±è´¥ï¼Œè¿›å…¥é˜»å¡çŠ¶æ€
    
    T1->>Account: withdraw(1000)
    Note over T1,Account: è¿›å…¥synchronizedä»£ç å—
    
    T1->>Account: getBalance() = 10000
    T1->>T1: Thread.sleep(1000)
    T1->>Account: setBalance(9000)
    T1->>Account: getBalance() = 9000
    T1->>Account: é‡Šæ”¾å¯¹è±¡é”
    
    Note over T1,T2: çº¿ç¨‹1é‡Šæ”¾é”åï¼Œçº¿ç¨‹2è¢«å”¤é†’
    
    T2->>Account: è·å–å¯¹è±¡é”æˆåŠŸ
    T2->>Account: withdraw(1000)
    Note over T2,Account: è¿›å…¥synchronizedä»£ç å—
    
    T2->>Account: getBalance() = 9000
    T2->>T2: Thread.sleep(1000)
    T2->>Account: setBalance(8000)
    T2->>Account: getBalance() = 8000
    T2->>Account: é‡Šæ”¾å¯¹è±¡é”
```

```java
Thread-0çº¿ç¨‹æ­£åœ¨å–æ¬¾1000.0ï¼Œå½“å‰act-001è´¦æˆ·ä½™é¢10000.0
Thread-0çº¿ç¨‹å–æ¬¾æˆåŠŸï¼Œå½“å‰act-001è´¦æˆ·ä½™é¢9000.0
Thread-1çº¿ç¨‹æ­£åœ¨å–æ¬¾1000.0ï¼Œå½“å‰act-001è´¦æˆ·ä½™é¢9000.0
Thread-1çº¿ç¨‹å–æ¬¾æˆåŠŸï¼Œå½“å‰act-001è´¦æˆ·ä½™é¢8000.0
```

> **æ€»ç»“:**
>
> ## å…³é”®ç‚¹è§£é‡Šï¼š
>
> 1. **é”çš„ç«äº‰**ï¼š
>    - çº¿ç¨‹1å’Œçº¿ç¨‹2åŒæ—¶å°è¯•è·å–Accountå¯¹è±¡çš„é”
>    - åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æˆåŠŸè·å–é”ï¼ˆå‡è®¾çº¿ç¨‹1å…ˆè·å–ï¼‰
> 2. **åŒæ­¥æ‰§è¡Œ**ï¼š
>    - çº¿ç¨‹1è·å–é”åï¼Œçº¿ç¨‹2åœ¨`synchronized`å—å¤–é˜»å¡ç­‰å¾…
>    - çº¿ç¨‹1æ‰§è¡Œå®Œæ•´ä¸ªå–æ¬¾æ“ä½œåé‡Šæ”¾é”
>    - çº¿ç¨‹2è¢«å”¤é†’å¹¶è·å–é”ï¼Œç„¶åæ‰§è¡Œå–æ¬¾æ“ä½œ
> 3. **çº¿ç¨‹å®‰å…¨**ï¼š
>    - ç”±äºä½¿ç”¨äº†`synchronized(this)`ï¼Œç¡®ä¿äº†åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æ‰§è¡Œå–æ¬¾æ“ä½œ
>    - é¿å…äº†æ•°æ®ç«äº‰å’Œä¸ä¸€è‡´çš„é—®é¢˜
> 4. **æœ€ç»ˆç»“æœ**ï¼š
>    - åˆå§‹ä½™é¢ï¼š10000
>    - çº¿ç¨‹1å–æ¬¾åï¼š9000
>    - çº¿ç¨‹2å–æ¬¾åï¼š8000
>    - æœ€ç»ˆä½™é¢æ­£ç¡®ä¸º8000





### çº¿ç¨‹åŒæ­¥æœºåˆ¶(æ·»åŠ åˆ°å®ä¾‹æ–¹æ³•ä¸Š)

```java
åœ¨å®ä¾‹æ–¹æ³•ä¸Šä¹Ÿå¯ä»¥æ·»åŠ  synchronized å…³é”®å­—ï¼š
       1. åœ¨å®ä¾‹æ–¹æ³•ä¸Šæ·»åŠ äº†synchronizedå…³é”®å­—ä¹‹åï¼Œæ•´ä¸ªæ–¹æ³•ä½“æ˜¯ä¸€ä¸ªåŒæ­¥ä»£ç å—ã€‚
       2. åœ¨å®ä¾‹æ–¹æ³•ä¸Šæ·»åŠ äº†synchronizedå…³é”®å­—ä¹‹åï¼Œå…±äº«å¯¹è±¡çš„å¯¹è±¡é”ä¸€å®šæ˜¯thisçš„ã€‚
 
è¿™ç§æ–¹å¼ç›¸å¯¹äºä¹‹å‰æ‰€è®²çš„å±€éƒ¨åŒæ­¥ä»£ç å—çš„æ–¹å¼è¦å·®ä¸€äº›ï¼š
       synchronized(å…±äº«å¯¹è±¡){
           // åŒæ­¥ä»£ç å—
       }
 
       è¿™ç§æ–¹å¼ä¼˜ç‚¹ï¼šçµæ´»
           å…±äº«å¯¹è±¡å¯ä»¥éšä¾¿è°ƒæ•´ã€‚
           åŒæ­¥ä»£ç å—çš„èŒƒå›´å¯ä»¥éšä¾¿è°ƒæ•´ã€‚
```

```java
package com.powernode.javase.thread14;

public class ThreadTest {
    public static void main(String[] args) {
        // åˆ›å»ºè´¦æˆ·å¯¹è±¡
        Account act = new Account("act-001",10000);
        // åˆ›å»ºçº¿ç¨‹å¯¹è±¡1
        Thread t1 = new Thread(new Withdraw(act));
        // åˆ›å»ºçº¿ç¨‹å¯¹è±¡2
        Thread t2 = new Thread(new Withdraw(act));

        // å¯åŠ¨çº¿ç¨‹
        t1.start();
        t2.start();
    }
}

// å–æ¬¾çš„çº¿ç¨‹ç±»
class Withdraw implements Runnable{

    // å®ä¾‹å˜é‡ï¼ˆå…±äº«æ•°æ®ï¼‰
    private Account act;

    public Withdraw(Account act) {
        this.act = act;
    }

    @Override
    public void run() {
        act.withdraw(1000);
    }
}


// é“¶è¡Œè´¦æˆ·
class Account{

    private static Object obj = new Object();
    /**
     * è´¦å·
     */
    private String actNo;
    /**
     * ä½™é¢
     */
    private double balance;

    public Account(String actNo, double balance) {
        this.actNo = actNo;
        this.balance = balance;
    }

    public String getActNo() {
        return actNo;
    }

    public void setActNo(String actNo) {
        this.actNo = actNo;
    }

    public double getBalance() {
        return balance;
    }

    public void setBalance(double balance) {
        this.balance = balance;
    }

    /**
     * å–æ¬¾çš„æ–¹æ³•
     * @param money å–æ¬¾é¢åº¦
     */
    public synchronized void withdraw(double money){
            // ç¬¬ä¸€æ­¥ï¼šè¯»å–ä½™é¢
            double before = this.getBalance();
            System.out.println(Thread.currentThread().getName() + "çº¿ç¨‹æ­£åœ¨å–æ¬¾"+money+"ï¼Œå½“å‰"+this.getActNo()+"è´¦æˆ·ä½™é¢" + before);

            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            }

            // ç¬¬äºŒæ­¥ï¼šä¿®æ”¹ä½™é¢
            this.setBalance(before - money);
            System.out.println(Thread.currentThread().getName() + "çº¿ç¨‹å–æ¬¾æˆåŠŸï¼Œå½“å‰"+this.getActNo()+"è´¦æˆ·ä½™é¢" + this.getBalance());
    }
}
```

```java
Thread-0çº¿ç¨‹æ­£åœ¨å–æ¬¾1000.0ï¼Œå½“å‰act-001è´¦æˆ·ä½™é¢10000.0
Thread-0çº¿ç¨‹å–æ¬¾æˆåŠŸï¼Œå½“å‰act-001è´¦æˆ·ä½™é¢9000.0
Thread-1çº¿ç¨‹æ­£åœ¨å–æ¬¾1000.0ï¼Œå½“å‰act-001è´¦æˆ·ä½™é¢9000.0
Thread-1çº¿ç¨‹å–æ¬¾æˆåŠŸï¼Œå½“å‰act-001è´¦æˆ·ä½™é¢8000.0
```





### çº¿ç¨‹åŒæ­¥æœºåˆ¶çš„é¢è¯•é¢˜



#### é¢è¯•é¢˜(1)

> + **çº¿ç¨‹åŒæ­¥æœºåˆ¶çš„é¢è¯•é¢˜ï¼šåˆ†æä»¥ä¸‹ç¨‹åº m2 æ–¹æ³•åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œéœ€è¦ç­‰å¾… m1 æ–¹æ³•çš„ç»“æŸå—ï¼Ÿ**
>
>  * **`ä¸éœ€è¦`**

```java
package com.powernode.javase.thread15;

public class ThreadTest {
    public static void main(String[] args) {
        MyClass mc = new MyClass();
        Thread t1 = new Thread(new MyRunnable(mc));
        Thread t2 = new Thread(new MyRunnable(mc));

        t1.setName("t1");
        t2.setName("t2");

        t1.start();
        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        }
        t2.start();
    }
}

class MyRunnable implements Runnable {

    private MyClass mc;

    public MyRunnable(MyClass mc) {
        this.mc = mc;
    }

    @Override
    public void run() {
        if("t1".equals(Thread.currentThread().getName())){
            mc.m1();
        }
        if("t2".equals(Thread.currentThread().getName())){
            mc.m2();
        }
    }
}

class MyClass {
    public synchronized void m1(){
        System.out.println("m1 begin");
        try {
            Thread.sleep(1000 * 5);
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        }
        System.out.println("m1 over");
    }

    public void m2(){
        System.out.println("m2 begin");
        System.out.println("m2 over");
    }
}
```

```mermaid
sequenceDiagram
    participant Main as ä¸»çº¿ç¨‹
    participant T1 as çº¿ç¨‹t1
    participant T2 as çº¿ç¨‹t2
    participant MC as MyClasså¯¹è±¡

    Main->>T1: å¯åŠ¨t1çº¿ç¨‹
    Main->>Main: sleep(1000ms)
    T1->>MC: è°ƒç”¨m1() - synchronizedæ–¹æ³•
    Note over T1,MC: t1è·å–å¯¹è±¡é”
    
    T1->>T1: sleep(5000ms)
    
    Main->>T2: å¯åŠ¨t2çº¿ç¨‹
    T2->>MC: è°ƒç”¨m2() - æ™®é€šæ–¹æ³•
    Note over T2,MC: m2()ä¸éœ€è¦é”ï¼Œç›´æ¥æ‰§è¡Œ
    
    T2->>T2: ç«‹å³æ‰§è¡Œm2()
    T2-->>MC: m2 over (ç«‹å³è¿”å›)
    
    T1->>T1: sleepç»“æŸ
    T1-->>MC: m1 over
    Note over T1,MC: t1é‡Šæ”¾å¯¹è±¡é”
```

```java
m1 begin
m2 begin
m2 over
m1 over
```

> **æ€»ç»“:**
>
> 1. **é”çš„ä½œç”¨èŒƒå›´**ï¼š
>    - `m1()`æ˜¯`synchronized`æ–¹æ³•ï¼Œéœ€è¦è·å–å¯¹è±¡é”
>    - `m2()`æ˜¯æ™®é€šæ–¹æ³•ï¼Œä¸éœ€è¦è·å–é”
> 2. **æ‰§è¡Œæ—¶åº**ï¼š
>    - t1å…ˆå¯åŠ¨ï¼Œè·å–MCçš„å¯¹è±¡é”ï¼Œæ‰§è¡Œm1()
>    - ä¸»çº¿ç¨‹sleep 1ç§’åå¯åŠ¨t2
>    - t2è°ƒç”¨m2()æ—¶ï¼Œç”±äºm2()ä¸éœ€è¦é”ï¼Œå¯ä»¥ç«‹å³æ‰§è¡Œ
>    - m1()å’Œm2()å¯ä»¥å¹¶å‘æ‰§è¡Œ
> 3. **ç»“è®º**ï¼š
>    - **m2()ä¸éœ€è¦ç­‰å¾…m1()ç»“æŸ**
>    - åªæœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨synchronizedæ–¹æ³•æ—¶æ‰ä¼šç›¸äº’ç­‰å¾…
>    - æ™®é€šæ–¹æ³•å’Œsynchronizedæ–¹æ³•ä¹‹é—´ä¸ä¼šäº§ç”Ÿç«äº‰
>
> **è¿™å°±æ˜¯ä¸ºä»€ä¹ˆm2()`ä¸éœ€è¦ç­‰å¾…`m1()æ‰§è¡Œå®Œæˆçš„åŸå› ã€‚**







#### é¢è¯•é¢˜(2)

>  * **çº¿ç¨‹åŒæ­¥æœºåˆ¶çš„é¢è¯•é¢˜ï¼šåˆ†æä»¥ä¸‹ç¨‹åº m2 æ–¹æ³•åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œéœ€è¦ç­‰å¾… m1 æ–¹æ³•çš„ç»“æŸå—ï¼Ÿ**
>  * **`éœ€è¦`**

```java
package com.powernode.javase.thread16;

public class ThreadTest {
    public static void main(String[] args) {
        MyClass mc = new MyClass();
        Thread t1 = new Thread(new MyRunnable(mc));
        Thread t2 = new Thread(new MyRunnable(mc));

        t1.setName("t1");
        t2.setName("t2");

        t1.start();
        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        }
        t2.start();
    }
}

class MyRunnable implements Runnable {

    private MyClass mc;

    public MyRunnable(MyClass mc) {
        this.mc = mc;
    }

    @Override
    public void run() {
        if("t1".equals(Thread.currentThread().getName())){
            mc.m1();
        }
        if("t2".equals(Thread.currentThread().getName())){
            mc.m2();
        }
    }
}

class MyClass {
    public synchronized void m1(){
        System.out.println("m1 begin");
        try {
            Thread.sleep(1000 * 5);
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        }
        System.out.println("m1 over");
    }

    public synchronized void m2(){
        System.out.println("m2 begin");
        System.out.println("m2 over");
    }
}
```

```mermaid
sequenceDiagram
    participant Main as ä¸»çº¿ç¨‹
    participant T1 as çº¿ç¨‹t1
    participant T2 as çº¿ç¨‹t2
    participant MC as MyClasså¯¹è±¡

    Main->>T1: å¯åŠ¨t1çº¿ç¨‹
    Main->>Main: sleep(1000ms)
    
    T1->>MC: è°ƒç”¨m1() - synchronizedæ–¹æ³•
    Note over T1,MC: t1è·å–å¯¹è±¡é”ğŸ”’
    
    T1->>T1: sleep(5000ms)
    Note over T1: m1æ‰§è¡Œä¸­...
    
    Main->>T2: å¯åŠ¨t2çº¿ç¨‹
    T2->>MC: å°è¯•è°ƒç”¨m2() - synchronizedæ–¹æ³•
    Note over T2,MC: t2ç­‰å¾…å¯¹è±¡é”â³<br/>å› ä¸ºm2ä¹Ÿæ˜¯synchronizedæ–¹æ³•
    
    T1->>T1: sleepç»“æŸ
    T1-->>MC: m1 over
    Note over T1,MC: t1é‡Šæ”¾å¯¹è±¡é”ğŸ”“
    
    MC->>T2: t2è·å¾—å¯¹è±¡é”
    T2->>MC: æ‰§è¡Œm2()
    T2-->>MC: m2 over
    Note over T2,MC: t2é‡Šæ”¾å¯¹è±¡é”
```

```java
m1 begin
m1 over
m2 begin
m2 over
```

> **æ€»ç»“:**
>
> 1. **é”çš„ä½œç”¨èŒƒå›´**ï¼š
>    - `m1()`æ˜¯`synchronized`æ–¹æ³•ï¼Œéœ€è¦è·å–å¯¹è±¡é”
>    - `m2()`ä¹Ÿæ˜¯`synchronized`æ–¹æ³•ï¼ŒåŒæ ·éœ€è¦è·å–å¯¹è±¡é”
> 2. **æ‰§è¡Œæ—¶åº**ï¼š
>    - t1å…ˆå¯åŠ¨ï¼Œè·å–MCçš„å¯¹è±¡é”ï¼Œæ‰§è¡Œm1()
>    - ä¸»çº¿ç¨‹sleep 1ç§’åå¯åŠ¨t2
>    - t2è°ƒç”¨m2()æ—¶ï¼Œç”±äºm2()ä¹Ÿéœ€è¦å¯¹è±¡é”ï¼Œä½†é”å·²è¢«t1æŒæœ‰
>    - t2å¿…é¡»ç­‰å¾…t1é‡Šæ”¾é”åæ‰èƒ½æ‰§è¡Œm2()
> 3. **é”ç«äº‰**ï¼š
>    - ä¸¤ä¸ªsynchronizedæ–¹æ³•å…±ç”¨åŒä¸€ä¸ªå¯¹è±¡é”
>    - åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æŒæœ‰è¯¥é”
>    - t2åœ¨é”è¢«å ç”¨æ—¶è¿›å…¥é˜»å¡çŠ¶æ€
> 4. **ç»“è®º**ï¼š
>    - **m2()éœ€è¦ç­‰å¾…m1()ç»“æŸ**
>    - å› ä¸ºä¸¤ä¸ªæ–¹æ³•éƒ½æ˜¯synchronizedçš„ï¼Œå…±äº«åŒä¸€ä¸ªå¯¹è±¡é”
>    - t2å¿…é¡»ç­‰å¾…t1é‡Šæ”¾é”åæ‰èƒ½æ‰§è¡Œm2()
>
> **è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­m2()`éœ€è¦ç­‰å¾…`m1()æ‰§è¡Œå®Œæˆçš„åŸå› ã€‚**





#### é¢è¯•é¢˜(3)

> + **çº¿ç¨‹åŒæ­¥æœºåˆ¶çš„é¢è¯•é¢˜ï¼šåˆ†æä»¥ä¸‹ç¨‹åº m2 æ–¹æ³•åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œéœ€è¦ç­‰å¾… m1 æ–¹æ³•çš„ç»“æŸå—ï¼Ÿ**
>
>  * **`ä¸éœ€è¦`**

```java
package com.powernode.javase.thread17;

public class ThreadTest {
    public static void main(String[] args) {
        MyClass mc1 = new MyClass();
        MyClass mc2 = new MyClass();
        Thread t1 = new Thread(new MyRunnable(mc1));
        Thread t2 = new Thread(new MyRunnable(mc2));

        t1.setName("t1");
        t2.setName("t2");

        t1.start();
        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        }
        t2.start();
    }
}

class MyRunnable implements Runnable {

    private MyClass mc;

    public MyRunnable(MyClass mc) {
        this.mc = mc;
    }

    @Override
    public void run() {
        if("t1".equals(Thread.currentThread().getName())){
            mc.m1();
        }
        if("t2".equals(Thread.currentThread().getName())){
            mc.m2();
        }
    }
}

class MyClass {
    public synchronized void m1(){
        System.out.println("m1 begin");
        try {
            Thread.sleep(1000 * 5);
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        }
        System.out.println("m1 over");
    }

    public synchronized void m2(){
        System.out.println("m2 begin");
        System.out.println("m2 over");
    }
}
```

```mermaid
sequenceDiagram
    participant Main as ä¸»çº¿ç¨‹
    participant T1 as çº¿ç¨‹t1
    participant T2 as çº¿ç¨‹t2
    participant MC1 as MyClasså¯¹è±¡mc1
    participant MC2 as MyClasså¯¹è±¡mc2

    Main->>Main: åˆ›å»ºä¸¤ä¸ªä¸åŒå¯¹è±¡
    Note over Main: mc1 = new MyClass()<br/>mc2 = new MyClass()

    Main->>T1: å¯åŠ¨t1çº¿ç¨‹(mc1)
    Main->>Main: sleep(1000ms)
    
    T1->>MC1: è°ƒç”¨m1() - synchronizedæ–¹æ³•
    Note over T1,MC1: t1è·å–mc1çš„å¯¹è±¡é”ğŸ”’
    
    T1->>T1: sleep(5000ms)
    Note over T1: m1æ‰§è¡Œä¸­...
    
    Main->>T2: å¯åŠ¨t2çº¿ç¨‹(mc2)
    T2->>MC2: è°ƒç”¨m2() - synchronizedæ–¹æ³•
    Note over T2,MC2: t2è·å–mc2çš„å¯¹è±¡é”ğŸ”’<br/>ä¸åŒå¯¹è±¡ï¼Œäº’ä¸å¹²æ‰°

    T2->>MC2: ç«‹å³æ‰§è¡Œm2()
    T2-->>MC2: m2 over (ç«‹å³è¿”å›)
    Note over T2,MC2: t2é‡Šæ”¾mc2çš„å¯¹è±¡é”ğŸ”“
    
    T1->>T1: sleepç»“æŸ
    T1-->>MC1: m1 over
    Note over T1,MC1: t1é‡Šæ”¾mc1çš„å¯¹è±¡é”ğŸ”“
```

```java
m1 begin
m2 begin
m2 over
m1 over
```

> **æ€»ç»“:**
>
> 1. **å¯¹è±¡é”çš„ä½œç”¨èŒƒå›´**ï¼š
>    - `synchronized`å®ä¾‹æ–¹æ³•é”å®šçš„æ˜¯**å½“å‰å¯¹è±¡å®ä¾‹**
>    - æ¯ä¸ªMyClasså¯¹è±¡éƒ½æœ‰è‡ªå·±çš„å¯¹è±¡é”
> 2. **æ‰§è¡Œæ—¶åº**ï¼š
>    - åˆ›å»ºäº†ä¸¤ä¸ªä¸åŒçš„MyClasså¯¹è±¡ï¼šmc1å’Œmc2
>    - t1æ“ä½œmc1ï¼Œt2æ“ä½œmc2
>    - t1è·å–mc1çš„å¯¹è±¡é”æ‰§è¡Œm1()
>    - t2è·å–mc2çš„å¯¹è±¡é”æ‰§è¡Œm2()
> 3. **é”çš„ç‹¬ç«‹æ€§**ï¼š
>    - mc1å’Œmc2æ˜¯ä¸¤ä¸ªä¸åŒçš„å¯¹è±¡
>    - å®ƒä»¬çš„å¯¹è±¡é”æ˜¯ç›¸äº’ç‹¬ç«‹çš„
>    - t1å’Œt2åˆ†åˆ«è·å–ä¸åŒå¯¹è±¡çš„é”ï¼Œäº’ä¸å¹²æ‰°
> 4. **ç»“è®º**ï¼š
>    - **m2()ä¸éœ€è¦ç­‰å¾…m1()ç»“æŸ**
>    - å› ä¸ºæ“ä½œçš„æ˜¯ä¸åŒçš„å¯¹è±¡å®ä¾‹
>    - æ¯ä¸ªå¯¹è±¡çš„synchronizedæ–¹æ³•åªå½±å“è¯¥å¯¹è±¡çš„é”ç«äº‰
>
> **è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­m2()`ä¸éœ€è¦ç­‰å¾…`m1()æ‰§è¡Œå®Œæˆçš„åŸå› ã€‚å…³é”®åœ¨äº`ä¸¤ä¸ªçº¿ç¨‹`æ“ä½œçš„æ˜¯`ä¸åŒçš„å¯¹è±¡å®ä¾‹`ï¼Œå› æ­¤å®ƒä»¬çš„`synchronizedæ–¹æ³•ä¸ä¼šç›¸äº’é˜»å¡`ã€‚**





#### é¢è¯•é¢˜(4)

>  * **çº¿ç¨‹åŒæ­¥æœºåˆ¶çš„é¢è¯•é¢˜ï¼šåˆ†æä»¥ä¸‹ç¨‹åº m2 æ–¹æ³•åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œéœ€è¦ç­‰å¾… m1 æ–¹æ³•çš„ç»“æŸå—ï¼Ÿ**
>  * **`éœ€è¦ç­‰å¾…`**
>
> 
>
>  * **åœ¨é™æ€æ–¹æ³•ä¸Š`æ·»åŠ synchronized`ä¹‹åï¼Œ`çº¿ç¨‹ä¼šå æœ‰ç±»é”`ã€‚**
>  * **ç±»é”æ˜¯ï¼Œå¯¹äºä¸€ä¸ªç±»æ¥è¯´ï¼Œåªæœ‰ä¸€æŠŠé”ã€‚`ä¸ç®¡åˆ›å»ºäº†å¤šå°‘ä¸ªå¯¹è±¡`ï¼Œ`ç±»é”åªæœ‰ä¸€æŠŠ`ã€‚**
>  * **`é™æ€æ–¹æ³•ä¸Š`æ·»åŠ synchronizedï¼Œå®é™…ä¸Šæ˜¯ä¸ºäº†`ä¿è¯é™æ€å˜é‡çš„å®‰å…¨`ã€‚**
>  * **`å®ä¾‹æ–¹æ³•ä¸Š`æ·»åŠ synchronizedï¼Œå®é™…ä¸Šæ˜¯ä¸ºäº†`ä¿è¯å®ä¾‹å˜é‡çš„å®‰å…¨`ã€‚**

```java
package com.powernode.javase.thread18;

public class ThreadTest {
    public static void main(String[] args) {
        MyClass mc1 = new MyClass();
        MyClass mc2 = new MyClass();
        Thread t1 = new Thread(new MyRunnable(mc1));
        Thread t2 = new Thread(new MyRunnable(mc2));

        t1.setName("t1");
        t2.setName("t2");

        t1.start();
        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        }
        t2.start();
    }
}

class MyRunnable implements Runnable {

    private MyClass mc;

    public MyRunnable(MyClass mc) {
        this.mc = mc;
    }

    @Override
    public void run() {
        if("t1".equals(Thread.currentThread().getName())){
            mc.m1();
        }
        if("t2".equals(Thread.currentThread().getName())){
            mc.m2();
        }
    }
}

class MyClass {
    public static synchronized void m1(){
        System.out.println("m1 begin");
        try {
            Thread.sleep(1000 * 5);
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        }
        System.out.println("m1 over");
    }

    public static synchronized void m2(){
        System.out.println("m2 begin");
        System.out.println("m2 over");
    }
}
```

```mermaid
sequenceDiagram
    participant T1 as çº¿ç¨‹t1
    participant T2 as çº¿ç¨‹t2
    participant MC1 as mc1å¯¹è±¡
    participant MC2 as mc2å¯¹è±¡
    participant ClassLock as MyClassç±»é”

    Note over T1,ClassLock: å¼€å§‹æ‰§è¡Œ
    
    T1->>ClassLock: è¯·æ±‚è·å–ç±»é”
    Note over ClassLock: ğŸ”’ ç±»é”è¢«t1å ç”¨
    T1->>MC1: æ‰§è¡Œm1()é™æ€æ–¹æ³•
    Note over T1: m1 begin<br/>sleep(5000ms)
    
    T2->>ClassLock: è¯·æ±‚è·å–ç±»é”(é˜»å¡ç­‰å¾…)
    Note over T2: âŒ ç­‰å¾…ç±»é”é‡Šæ”¾
    
    Note over T1: sleepç»“æŸ
    T1->>MC1: m1 over
    T1->>ClassLock: é‡Šæ”¾ç±»é”
    Note over ClassLock: ğŸ”“ ç±»é”å¯ç”¨
    
    ClassLock->>T2: åˆ†é…ç±»é”
    Note over ClassLock: ğŸ”’ ç±»é”è¢«t2å ç”¨
    T2->>MC2: æ‰§è¡Œm2()é™æ€æ–¹æ³•
    Note over T2: m2 begin
    T2->>T2: m2 over
    T2->>ClassLock: é‡Šæ”¾ç±»é”
    Note over ClassLock: ğŸ”“ ç±»é”é‡Šæ”¾
```

> **æ€»ç»“:**
>
> 1. **ç±»é”æ¦‚å¿µ**ï¼š
>
>    - `static synchronized` æ–¹æ³•ä½¿ç”¨**ç±»é”**ï¼Œè€Œä¸æ˜¯å¯¹è±¡é”
>    - æ— è®ºåˆ›å»ºå¤šå°‘ä¸ªMyClasså¯¹è±¡ï¼Œç±»é”åªæœ‰ä¸€æŠŠ
>
> 2. **æ‰§è¡Œé¡ºåº**ï¼š
>
>    - t1å…ˆè·å–ç±»é”æ‰§è¡Œm1()
>    - t2å¿…é¡»ç­‰å¾…t1é‡Šæ”¾ç±»é”åæ‰èƒ½æ‰§è¡Œm2()
>    - å³ä½¿t2è°ƒç”¨çš„æ˜¯mc2å¯¹è±¡çš„m2()ï¼Œä»ç„¶éœ€è¦ç­‰å¾…
>
> 3. **è¾“å‡ºç»“æœ**ï¼š
>
>    ```java
>    m1 begin
>    (ç­‰å¾…5ç§’)
>    m1 over
>    m2 begin
>    m2 over
>    ```
>
>    
>
> 4. **å¦‚æœå»æ‰static**ï¼š
>
>    - å¦‚æœm1()å’Œm2()ä¸æ˜¯é™æ€æ–¹æ³•ï¼Œt1å’Œt2å¯ä»¥åŒæ—¶æ‰§è¡Œ
>    - å› ä¸ºéé™æ€synchronizedæ–¹æ³•ä½¿ç”¨å¯¹è±¡é”ï¼Œmc1å’Œmc2æœ‰ä¸åŒçš„å¯¹è±¡é”
>
> **è¿™å°±æ˜¯ä¸ºä»€ä¹ˆm2æ–¹æ³•`éœ€è¦ç­‰å¾…`m1æ–¹æ³•æ‰§è¡Œç»“æŸçš„åŸå› ã€‚**



### Locké”å®ç°çº¿ç¨‹å®‰å…¨

```java
1.Lockæ˜¯æ¥å£ï¼Œä»JDK5å¼€å§‹å¼•å…¥çš„ã€‚
    
2.Lockæ¥å£ä¸‹æœ‰ä¸€ä¸ªå®ç°ç±»ï¼šå¯é‡å…¥é”ï¼ˆReentrantLockï¼‰
	æ³¨æ„ï¼šè¦æƒ³ä½¿ç”¨ReentrantLockè¾¾åˆ°çº¿ç¨‹å®‰å…¨ï¼Œå‡è®¾è¦è®©t1 t2 t3çº¿ç¨‹åŒæ­¥ï¼Œå°±éœ€è¦è®©t1 t2 t3å…±äº«åŒä¸€ä¸ªlockã€‚
    
3.Lock å’Œ synchronized å“ªä¸ªå¥½ï¼ŸLockæ›´å¥½ã€‚ä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºæ›´åŠ çµæ´»ã€‚
```

```java
package com.powernode.javase.thread23;

import java.util.concurrent.locks.ReentrantLock;

class SingletonTest {

    // é™æ€å˜é‡
    private static Singleton s1;
    private static Singleton s2;

    public static void main(String[] args) {

        // è·å–æŸä¸ªç±»ã€‚è¿™æ˜¯åå°„æœºåˆ¶ä¸­çš„å†…å®¹ã€‚
        /*Class stringClass = String.class;
        Class singletonClass = Singleton.class;
        Class dateClass = java.util.Date.class;*/

        // åˆ›å»ºçº¿ç¨‹å¯¹è±¡t1
        Thread t1 = new Thread(new Runnable() {
            @Override
            public void run() {
                s1 = Singleton.getSingleton();
            }
        });

        // åˆ›å»ºçº¿ç¨‹å¯¹è±¡t2
        Thread t2 = new Thread(new Runnable() {
            @Override
            public void run() {
                s2 = Singleton.getSingleton();
            }
        });

        // å¯åŠ¨çº¿ç¨‹
        t1.start();
        t2.start();

        try {
            t1.join();
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        }
        try {
            t2.join();
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        }

        // åˆ¤æ–­è¿™ä¸¤ä¸ªSingletonå¯¹è±¡æ˜¯å¦ä¸€æ ·ã€‚
        System.out.println(s1);
        System.out.println(s2);
        System.out.println(s1 == s2);

    }
}

/**
 * æ‡’æ±‰å¼å•ä¾‹æ¨¡å¼
 */
public class Singleton {
    private static Singleton singleton;

    private Singleton() {
        System.out.println("æ„é€ æ–¹æ³•æ‰§è¡Œäº†ï¼");
    }

    // éçº¿ç¨‹å®‰å…¨çš„ã€‚
    /*public static Singleton getSingleton() {
        if (singleton == null) {
            try {
                Thread.sleep(2000);
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            }
            singleton = new Singleton();
        }
        return singleton;
    }*/

    // çº¿ç¨‹å®‰å…¨çš„ï¼šç¬¬ä¸€ç§æ–¹æ¡ˆï¼ˆåŒæ­¥æ–¹æ³•ï¼‰ï¼Œæ‰¾ç±»é”ã€‚
    /*public static synchronized Singleton getSingleton() {
        if (singleton == null) {
            try {
                Thread.sleep(2000);
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            }
            singleton = new Singleton();
        }
        return singleton;
    }*/

    // çº¿ç¨‹å®‰å…¨çš„ï¼šç¬¬äºŒç§æ–¹æ¡ˆï¼ˆåŒæ­¥ä»£ç å—ï¼‰ï¼Œæ‰¾çš„ç±»é”
    /*public static Singleton getSingleton() {
        // è¿™é‡Œæœ‰ä¸€ä¸ªçŸ¥è¯†ç‚¹æ˜¯åå°„æœºåˆ¶ä¸­çš„å†…å®¹ã€‚å¯ä»¥è·å–æŸä¸ªç±»ã€‚
        synchronized (Singleton.class){
            if (singleton == null) {
                try {
                    Thread.sleep(2000);
                } catch (InterruptedException e) {
                    throw new RuntimeException(e);
                }
                singleton = new Singleton();
            }
        }
        return singleton;
    }*/

    // çº¿ç¨‹å®‰å…¨çš„ï¼šè¿™ä¸ªæ–¹æ¡ˆå¯¹ä¸Šä¸€ä¸ªæ–¹æ¡ˆè¿›è¡Œä¼˜åŒ–ï¼Œæå‡æ•ˆç‡ã€‚
    /*public static Singleton getSingleton() {
        if(singleton == null){
            synchronized (Singleton.class){
                if (singleton == null) {
                    try {
                        Thread.sleep(2000);
                    } catch (InterruptedException e) {
                        throw new RuntimeException(e);
                    }
                    singleton = new Singleton();
                }
            }
        }
        return singleton;
    }*/

    // ä½¿ç”¨Lockæ¥å®ç°çº¿ç¨‹å®‰å…¨
    // Lockæ˜¯æ¥å£ï¼Œä»JDK5å¼€å§‹å¼•å…¥çš„ã€‚
    // Lockæ¥å£ä¸‹æœ‰ä¸€ä¸ªå®ç°ç±»ï¼šå¯é‡å…¥é”ï¼ˆReentrantLockï¼‰
    // æ³¨æ„ï¼šè¦æƒ³ä½¿ç”¨ReentrantLockè¾¾åˆ°çº¿ç¨‹å®‰å…¨ï¼Œå‡è®¾è¦è®©t1 t2 t3çº¿ç¨‹åŒæ­¥ï¼Œå°±éœ€è¦è®©t1 t2 t3å…±äº«åŒä¸€ä¸ªlockã€‚
    // Lock å’Œ synchronized å“ªä¸ªå¥½ï¼ŸLockæ›´å¥½ã€‚ä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºæ›´åŠ çµæ´»ã€‚
    private static final ReentrantLock lock = new ReentrantLock();

    public static Singleton getSingleton() {
        if(singleton == null){

            try {
                // åŠ é”
                lock.lock();
                if (singleton == null) {
                    try {
                        Thread.sleep(2000);
                    } catch (InterruptedException e) {
                        throw new RuntimeException(e);
                    }
                    singleton = new Singleton();
                }
            } finally {
                // è§£é”ï¼ˆéœ€è¦100%ä¿è¯è§£é”ï¼Œæ€ä¹ˆåŠï¼Ÿfinallyï¼‰
                lock.unlock();
            }

        }
        return singleton;
    }
}
```

```mermaid
sequenceDiagram
    participant T1 as Thread 1
    participant T2 as Thread 2
    participant Lock as ReentrantLock
    participant Singleton as Singleton Class
    
    Note over T1,T2: åˆå§‹çŠ¶æ€: singleton = null
    
    T1->>Singleton: getSingleton()
    T2->>Singleton: getSingleton()
    
    Note over T1,T2: ä¸¤ä¸ªçº¿ç¨‹å‡ ä¹åŒæ—¶è°ƒç”¨getSingleton()
    
    T1->>Singleton: if(singleton == null) âœ“
    T2->>Singleton: if(singleton == null) âœ“
    
    T1->>Lock: lock.lock()
    Note over T1,Lock: T1æˆåŠŸè·å–é”
    
    T2->>Lock: lock.lock()
    Note over T2,Lock: T2è¢«é˜»å¡ï¼Œç­‰å¾…é”é‡Šæ”¾
    
    T1->>Singleton: if(singleton == null) âœ“
    T1->>Singleton: Thread.sleep(2000)
    T1->>Singleton: new Singleton()
    Note over Singleton: æ„é€ æ–¹æ³•æ‰§è¡Œäº†ï¼
    T1->>Singleton: singleton = new Singleton()
    
    T1->>Lock: lock.unlock()
    Note over T2,Lock: T2è·å–åˆ°é”ï¼Œç»§ç»­æ‰§è¡Œ
    
    T2->>Singleton: if(singleton == null) âœ—
    T2->>Lock: lock.unlock()
    
    T1->>Singleton: return singleton
    T2->>Singleton: return singleton
    
    Note over T1,T2: ä¸¤ä¸ªçº¿ç¨‹è¿”å›åŒä¸€ä¸ªå®ä¾‹å¯¹è±¡
```

> **æ€»ç»“:**
>
> **1. åˆå§‹çŠ¶æ€**
>
> - `singleton` é™æ€å˜é‡ä¸º `null`
> - ä¸¤ä¸ªçº¿ç¨‹ T1 å’Œ T2 åŒæ—¶å¯åŠ¨
>
> **2. ç¬¬ä¸€æ¬¡ç©ºæ£€æŸ¥**
>
> ```java
> if(singleton == null)  // ä¸¤ä¸ªçº¿ç¨‹éƒ½é€šè¿‡è¿™ä¸ªæ£€æŸ¥
> ```
>
> **3. é”ç«äº‰é˜¶æ®µ**
>
> - **T1** å…ˆè·å–åˆ°é”ï¼š`lock.lock()`
> - **T2** å°è¯•è·å–é”æ—¶è¢«é˜»å¡ï¼Œè¿›å…¥ç­‰å¾…çŠ¶æ€
>
> **4. T1 çš„æ‰§è¡Œæµç¨‹**
>
> ```java
> // åœ¨é”ä¿æŠ¤ä¸‹å†æ¬¡æ£€æŸ¥
> if (singleton == null) {  // ä»ç„¶ä¸ºnull
>     Thread.sleep(2000);   // æ¨¡æ‹Ÿåˆ›å»ºå¯¹è±¡çš„è€—æ—¶æ“ä½œ
>     singleton = new Singleton();  // åˆ›å»ºå•ä¾‹å®ä¾‹
> }
> // åœ¨finallyå—ä¸­é‡Šæ”¾é”
> lock.unlock();
> ```
>
> 
>
> **5.T2 çš„æ‰§è¡Œæµç¨‹**
>
> - å½“ T1 é‡Šæ”¾é”åï¼ŒT2 è·å–åˆ°é”
> - å†æ¬¡æ£€æŸ¥ `singleton == null`ï¼Œæ­¤æ—¶ä¸º `false`ï¼ˆå› ä¸º T1 å·²ç»åˆ›å»ºäº†å®ä¾‹ï¼‰
> - ç›´æ¥è¿”å›å·²å­˜åœ¨çš„å®ä¾‹ï¼Œé‡Šæ”¾é”







## æ­»é”

> **æ­»é”çš„å››ä¸ªå¿…è¦æ¡ä»¶ï¼š**
>
> - âœ… **äº’æ–¥æ¡ä»¶**ï¼šèµ„æºä¸èƒ½è¢«å…±äº«ï¼Œåªèƒ½ç”±ä¸€ä¸ªçº¿ç¨‹å ç”¨
> - âœ… **è¯·æ±‚ä¸ä¿æŒæ¡ä»¶**ï¼šçº¿ç¨‹å·²ç»ä¿æŒäº†è‡³å°‘ä¸€ä¸ªèµ„æºï¼Œä½†åˆæå‡ºäº†æ–°çš„èµ„æºè¯·æ±‚
> - âœ… **ä¸å‰¥å¤ºæ¡ä»¶**ï¼šçº¿ç¨‹å·²è·å¾—çš„èµ„æºï¼Œåœ¨æœªä½¿ç”¨å®Œä¹‹å‰ï¼Œä¸èƒ½è¢«å‰¥å¤º
> - âœ… **å¾ªç¯ç­‰å¾…æ¡ä»¶**ï¼št1ç­‰å¾…t2ï¼Œt2ç­‰å¾…t1

```java
package com.powernode.javase.thread19;

public class ThreadTest {
    public static void main(String[] args) {
        Object o1 = new Object();
        Object o2 = new Object();
        // åˆ›å»ºçº¿ç¨‹å¯¹è±¡
        Thread t1 = new Thread(new MyRunable(o1,o2));
        Thread t2 = new Thread(new MyRunable(o1,o2));

        t1.setName("t1");
        t2.setName("t2");

        // å¯åŠ¨çº¿ç¨‹
        t1.start();
        t2.start();
    }
}


class MyRunable implements Runnable {

    private Object o1;
    private Object o2;

    public MyRunable(Object o1, Object o2) {
        this.o1 = o1;
        this.o2 = o2;
    }

    @Override
    public void run() {
        if("t1".equals(Thread.currentThread().getName())) {
            synchronized (o1) {
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    throw new RuntimeException(e);
                }
                synchronized (o2) {

                }
            }
        }else if("t2".equals(Thread.currentThread().getName())) {
            synchronized (o2) {
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    throw new RuntimeException(e);
                }
                synchronized (o1) {

                }
            }
        }
    }
}
```

```mermaid
sequenceDiagram
    participant T1 as çº¿ç¨‹t1
    participant T2 as çº¿ç¨‹t2
    participant O1 as é”å¯¹è±¡o1
    participant O2 as é”å¯¹è±¡o2

    Note over T1,T2: ç¨‹åºå¼€å§‹æ‰§è¡Œ
    
    T1->>O1: è·å–o1çš„é”
    T2->>O2: è·å–o2çš„é”
    
    Note over T1: æŒæœ‰o1ï¼Œç­‰å¾…o2
    Note over T2: æŒæœ‰o2ï¼Œç­‰å¾…o1
    
    T1->>O2: å°è¯•è·å–o2çš„é”(ç­‰å¾…ä¸­...)
    T2->>O1: å°è¯•è·å–o1çš„é”(ç­‰å¾…ä¸­...)
    
    Note over T1,T2: æ­»é”çŠ¶æ€å½¢æˆï¼
    
    T1-->>T2: äº’ç›¸ç­‰å¾…ï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œ
    T2-->>T1: äº’ç›¸ç­‰å¾…ï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œ
```

> ## æ­»é”å½¢æˆçš„è¯¦ç»†æ­¥éª¤ï¼š
>
> 1. **t1çº¿ç¨‹æ‰§è¡Œ**ï¼š
>    - é¦–å…ˆè·å– `o1` çš„é”
>    - ç¡çœ 1ç§’é’Ÿ
>    - å°è¯•è·å– `o2` çš„é”
> 2. **t2çº¿ç¨‹æ‰§è¡Œ**ï¼š
>    - é¦–å…ˆè·å– `o2` çš„é”
>    - ç¡çœ 1ç§’é’Ÿ
>    - å°è¯•è·å– `o1` çš„é”
> 3. **æ­»é”æ¡ä»¶**ï¼š
>    - t1æŒæœ‰o1ï¼Œç­‰å¾…o2
>    - t2æŒæœ‰o2ï¼Œç­‰å¾…o1
>    - ä¸¤ä¸ªçº¿ç¨‹äº’ç›¸ç­‰å¾…å¯¹æ–¹é‡Šæ”¾é”ï¼Œå½¢æˆå¾ªç¯ç­‰å¾…





### å–ç¥¨é—®é¢˜

```java
package com.powernode.javase.thread20;

/**
 * æ¨¡æ‹Ÿä¸‰ä¸ªçª—å£å–ç¥¨ã€‚
 */
public class SellTicket {
    public static void main(String[] args) {
        // åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œè¿™æ ·è®©å¤šä¸ªçº¿ç¨‹å…±äº«åŒä¸€ä¸ªå¯¹è±¡
        MyRunnable mr = new MyRunnable();

        // åˆ›å»ºä¸‰ä¸ªçº¿ç¨‹ï¼Œæ¨¡æ‹Ÿä¸‰ä¸ªçª—å£
        Thread t1 = new Thread(mr);
        t1.setName("1");
        Thread t2 = new Thread(mr);
        t2.setName("2");
        Thread t3 = new Thread(mr);
        t3.setName("3");

        // å¯åŠ¨çº¿ç¨‹
        t1.start();
        t2.start();
        t3.start();
    }
}

class MyRunnable implements Runnable {

    // å®ä¾‹å˜é‡(å¤šçº¿ç¨‹å…±äº«)
    private int ticketTotal = 100;

    @Override
    public void run() {
        // å®ç°æ ¸å¿ƒä¸šåŠ¡ï¼šå–ç¥¨
        while (true) {
            // synchronized æ˜¯çº¿ç¨‹åŒæ­¥æœºåˆ¶ã€‚
            // synchronized åˆè¢«ç§°ä¸ºäº’æ–¥é”ï¼
            synchronized (this) {
                if (ticketTotal <= 0) {
                    System.out.println("ç¥¨å·²å”®å®Œ...");
                    break; // åœæ­¢å”®ç¥¨
                }
                // ç¥¨è¿˜æœ‰ï¼ˆticketTotal > 0ï¼‰
                // ä¸€èˆ¬å‡ºç¥¨éƒ½éœ€è¦ä¸€ä¸ªæ—¶é•¿ï¼Œæ¨¡æ‹Ÿä¸€ä¸‹
                try {
                    Thread.sleep(50);
                } catch (InterruptedException e) {
                    throw new RuntimeException(e);
                }
                // å‡ºç¥¨äº†
                System.out.println("çª—å£" + Thread.currentThread().getName() + "å”®å‡ºä¸€å¼ ç¥¨ï¼Œè¿˜å‰©" + (--ticketTotal) + "å¼ ç¥¨");
            }
        }

    }
}
```

```java
çª—å£1å”®å‡ºä¸€å¼ ç¥¨ï¼Œè¿˜å‰©99å¼ ç¥¨
...
çª—å£3å”®å‡ºä¸€å¼ ç¥¨ï¼Œè¿˜å‰©35å¼ ç¥¨
...
çª—å£2å”®å‡ºä¸€å¼ ç¥¨ï¼Œè¿˜å‰©34å¼ ç¥¨
...
ç¥¨å·²å”®å®Œ...
ç¥¨å·²å”®å®Œ...
ç¥¨å·²å”®å®Œ...
```

```mermaid
sequenceDiagram
    participant T1 as çª—å£1
    participant T2 as çª—å£2  
    participant T3 as çª—å£3
    participant Lock as synchronized(this)
    participant Ticket as ticketTotal

    Note over T1,T3: åˆå§‹ç¥¨æ•°: 100
    
    T1->>Lock: å°è¯•è·å–é”
    Note over T1: è·å–é”æˆåŠŸ
    T1->>Ticket: æ£€æŸ¥ ticketTotal > 0
    T1->>T1: ç¡çœ 50ms(æ¨¡æ‹Ÿå‡ºç¥¨æ—¶é—´)
    T1->>Ticket: --ticketTotal (99)
    T1->>Lock: é‡Šæ”¾é”
    
    T2->>Lock: å°è¯•è·å–é”
    Note over T2: è·å–é”æˆåŠŸ  
    T2->>Ticket: æ£€æŸ¥ ticketTotal > 0
    T2->>T2: ç¡çœ 50ms(æ¨¡æ‹Ÿå‡ºç¥¨æ—¶é—´)
    T2->>Ticket: --ticketTotal (98)
    T2->>Lock: é‡Šæ”¾é”
    
    T3->>Lock: å°è¯•è·å–é”
    Note over T3: è·å–é”æˆåŠŸ
    T3->>Ticket: æ£€æŸ¥ ticketTotal > 0
    T3->>T3: ç¡çœ 50ms(æ¨¡æ‹Ÿå‡ºç¥¨æ—¶é—´)
    T3->>Ticket: --ticketTotal (97)
    T3->>Lock: é‡Šæ”¾é”

    Note over T1,T3: å¾ªç¯æ‰§è¡Œç›´åˆ°ç¥¨å”®å®Œ
    
    T1->>Lock: å°è¯•è·å–é”
    Note over T1: è·å–é”æˆåŠŸ
    T1->>Ticket: æ£€æŸ¥ ticketTotal = 0
    T1->>T1: è¾“å‡º"ç¥¨å·²å”®å®Œ"
    T1->>Lock: é‡Šæ”¾é”å¹¶é€€å‡ºå¾ªç¯
```





## çº¿ç¨‹é€šä¿¡

```java
1. å†…å®¹æ˜¯å…³äºï¼šçº¿ç¨‹é€šä¿¡ã€‚

2. çº¿ç¨‹é€šä¿¡æ¶‰åŠåˆ°ä¸‰ä¸ªæ–¹æ³•ï¼š
      wait()ã€notify()ã€notifyAll()

3. ä»¥ä¸Šä¸‰ä¸ªæ–¹æ³•éƒ½æ˜¯Objectç±»çš„æ–¹æ³•ã€‚

4. å…¶ä¸­wait()æ–¹æ³•é‡è½½äº†ä¸‰ä¸ªï¼š
      wait():è°ƒç”¨æ­¤æ–¹æ³•ï¼Œçº¿ç¨‹è¿›å…¥â€œç­‰å¾…çŠ¶æ€â€
      wait(æ¯«ç§’)ï¼šè°ƒç”¨æ­¤æ–¹æ³•ï¼Œçº¿ç¨‹è¿›å…¥â€œè¶…æ—¶ç­‰å¾…çŠ¶æ€â€
      wait(æ¯«ç§’, çº³ç§’)ï¼šè°ƒç”¨æ­¤æ–¹æ³•ï¼Œçº¿ç¨‹è¿›å…¥â€œè¶…æ—¶ç­‰å¾…çŠ¶æ€â€

5. è°ƒç”¨waitæ–¹æ³•å’Œnotifyç›¸å…³æ–¹æ³•çš„ï¼Œä¸æ˜¯é€šè¿‡çº¿ç¨‹å¯¹è±¡å»è°ƒç”¨ï¼Œè€Œæ˜¯é€šè¿‡å…±äº«å¯¹è±¡å»è°ƒç”¨ã€‚

6. ä¾‹å¦‚è°ƒç”¨äº†ï¼šobj.wait()ï¼Œä»€ä¹ˆæ•ˆæœï¼Ÿ
      objæ˜¯å¤šçº¿ç¨‹å…±äº«çš„å¯¹è±¡ã€‚
      å½“è°ƒç”¨äº†obj.wait()ä¹‹åï¼Œåœ¨objå¯¹è±¡ä¸Šæ´»è·ƒçš„æ‰€æœ‰çº¿ç¨‹è¿›å…¥æ— æœŸé™ç­‰å¾…ã€‚ç›´åˆ°è°ƒç”¨äº†è¯¥å…±äº«å¯¹è±¡çš„ obj.notify() æ–¹æ³•è¿›è¡Œäº†å”¤é†’ã€‚
      è€Œä¸”å”¤é†’åï¼Œä¼šæ¥ç€ä¸Šä¸€æ¬¡è°ƒç”¨wait()æ–¹æ³•çš„ä½ç½®ç»§ç»­å‘ä¸‹æ‰§è¡Œã€‚

7. obj.wait()æ–¹æ³•è°ƒç”¨ä¹‹åï¼Œä¼šé‡Šæ”¾ä¹‹å‰å ç”¨çš„å¯¹è±¡é”ã€‚

8. å…³äºnotifyå’ŒnotifyAllæ–¹æ³•ï¼š
      å…±äº«å¯¹è±¡.notify(); è°ƒç”¨ä¹‹åæ•ˆæœæ˜¯ä»€ä¹ˆï¼Ÿå”¤é†’ä¼˜å…ˆçº§æœ€é«˜çš„ç­‰å¾…çº¿ç¨‹ã€‚å¦‚æœä¼˜å…ˆçº§ä¸€æ ·ï¼Œåˆ™éšæœºå”¤é†’ä¸€ä¸ªã€‚
      å…±äº«å¯¹è±¡.notifyAll(); è°ƒç”¨ä¹‹åæ•ˆæœæ˜¯ä»€ä¹ˆï¼Ÿå”¤é†’æ‰€æœ‰åœ¨è¯¥å…±äº«å¯¹è±¡ä¸Šç­‰å¾…çš„çº¿ç¨‹ã€‚
 
9.wait()å’Œsleepçš„åŒºåˆ«ï¼Ÿ
ç›¸åŒç‚¹ï¼šéƒ½ä¼šé˜»å¡ã€‚

ä¸åŒç‚¹ï¼š
	waitæ˜¯Objectç±»çš„å®ä¾‹æ–¹æ³•ã€‚sleepæ˜¯Threadçš„é™æ€æ–¹æ³•ã€‚
	waitåªèƒ½ç”¨åœ¨åŒæ­¥ä»£ç å—æˆ–åŒæ­¥æ–¹æ³•ä¸­ã€‚sleepéšæ„ã€‚
	waitæ–¹æ³•æ‰§è¡Œä¼šé‡Šæ”¾å¯¹è±¡é”ã€‚sleepä¸ä¼šã€‚
	waitç»“æŸæ—¶æœºæ˜¯notifyå”¤é†’ï¼Œæˆ–è¾¾åˆ°æŒ‡å®šæ—¶é—´ã€‚sleepç»“æŸæ—¶æœºæ˜¯åˆ°è¾¾æŒ‡å®šæ—¶é—´ã€‚
```

![çº¿ç¨‹é€šä¿¡](./å¤šçº¿ç¨‹/img-13.jpg)



### çº¿ç¨‹äº¤æ›¿è¾“å‡º(1)

> **é¢˜ç›®æè¿°ï¼š`ä¸¤ä¸ªçº¿ç¨‹äº¤æ›¿è¾“å‡º`**
> t1-->1
> t2-->2
> t1-->3
> t2-->4
> t1-->5
> t2-->6
> t1-->7
> t2-->8
> t1-->9
> t2-->10
> t1-->11
> t2-->12
> t1-->13
> t2-->14
> ....

```java
package com.powernode.javase.thread21;

public class ThreadTest {
    public static void main(String[] args) {
        // åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œè¿™æ ·è®©å¤šä¸ªçº¿ç¨‹å…±äº«åŒä¸€ä¸ªå¯¹è±¡
        MyRunnable mr = new MyRunnable();

        // åˆ›å»ºäºŒä¸ªçº¿ç¨‹
        Thread t1 = new Thread(mr);
        t1.setName("t1");
        Thread t2 = new Thread(mr);
        t2.setName("t2");

        // å¯åŠ¨çº¿ç¨‹
        t1.start();
        t2.start();
    }
}

class MyRunnable implements Runnable {

    // å®ä¾‹å˜é‡ï¼šå¤šçº¿ç¨‹å…±äº«
    private int count = 0;

    private Object obj = new Object();

    @Override
    public void run() {
        while (true) {
            //synchronized (this) {
            synchronized (obj) {

                // è®°å¾—å”¤é†’t1çº¿ç¨‹
                // t2çº¿ç¨‹æ‰§è¡Œè¿‡ç¨‹ä¸­æŠŠt1å”¤é†’äº†ã€‚ä½†æ˜¯ç”±äºt2ä»ç„¶å ç”¨å¯¹è±¡é”ï¼Œæ‰€ä»¥å³ä½¿t1é†’äº†ï¼Œä¹Ÿä¸ä¼šå¾€ä¸‹æ‰§è¡Œã€‚
                //this.notify();
                obj.notify();

                if (count >= 100) break;
                // æ¨¡æ‹Ÿå»¶è¿Ÿ
                try {
                    Thread.sleep(50);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                // ç¨‹åºæ‰§è¡Œåˆ°è¿™é‡Œcountä¸€å®šæ˜¯å°äº100
                System.out.println(Thread.currentThread().getName() + "==>" + (++count));

                // è®©å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…ï¼Œè¿™ä¸ªç­‰å¾…çš„çº¿ç¨‹å¯èƒ½æ˜¯t1ï¼Œä¹Ÿå¯èƒ½æ˜¯t2
                // å‡è®¾æ˜¯t1çº¿ç¨‹ç­‰å¾…ã€‚
                // t1çº¿ç¨‹è¿›å…¥æ— æœŸé™çš„ç­‰å¾…ï¼Œå¹¶ä¸”ç­‰å¾…çš„æ—¶å€™ï¼Œä¸å ç”¨å¯¹è±¡é”ã€‚
                //this.wait();
                try {
                    obj.wait();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }
    }
}
```

```java
å¾ªç¯æ¨¡å¼:
1. çº¿ç¨‹A: [è·å–é”] â†’ notify() â†’ ä¸šåŠ¡é€»è¾‘ â†’ wait() â†’ [é‡Šæ”¾é”]
2. çº¿ç¨‹B: [è·å–é”] â†’ notify() â†’ ä¸šåŠ¡é€»è¾‘ â†’ wait() â†’ [é‡Šæ”¾é”]
3. é‡å¤æ­¥éª¤1

è¾“å‡ºç»“æœç¤ºä¾‹:
t1==>1
t2==>2
...
t1==>99
t2==>100
```

```mermaid
sequenceDiagram
    participant T1 as t1çº¿ç¨‹
    participant Lock as objé”
    participant T2 as t2çº¿ç¨‹
    participant Count as å…±äº«count

    Note over T1,T2: åˆå§‹çŠ¶æ€: count=0
    
    rect rgb(119, 136, 153)
        Note over T1: t1è·å–objé”
        T1->>Lock: è¿›å…¥synchronizedå—
        T1->>T2: obj.notify() (æ— æ•ˆæœ)
        T1->>T1: Thread.sleep(50)
        T1->>Count: count++ (0â†’1)
        T1->>T1: è¾“å‡º "t1==>1"
        T1->>Lock: obj.wait() é‡Šæ”¾é”
        Note over T1: t1è¿›å…¥WAITINGçŠ¶æ€
    end

    rect rgb(70, 130, 180)
        Note over T2: t2è·å–objé”
        T2->>Lock: è¿›å…¥synchronizedå—
        T2->>T1: obj.notify() å”¤é†’t1
        Note over T1: t1å˜ä¸ºBLOCKEDçŠ¶æ€
        T2->>T2: Thread.sleep(50)
        T2->>Count: count++ (1â†’2)
        T2->>T2: è¾“å‡º "t2==>2"
        T2->>Lock: obj.wait() é‡Šæ”¾é”
        Note over T2: t2è¿›å…¥WAITINGçŠ¶æ€
    end

    rect rgb(119, 136, 153)
        Note over T1: t1é‡æ–°è·å–objé”
        T1->>Lock: è¿›å…¥synchronizedå—
        T1->>T2: obj.notify() å”¤é†’t2
        Note over T2: t2å˜ä¸ºBLOCKEDçŠ¶æ€
        T1->>T1: Thread.sleep(50)
        T1->>Count: count++ (2â†’3)
        T1->>T1: è¾“å‡º "t1==>3"
        T1->>Lock: obj.wait() é‡Šæ”¾é”
        Note over T1: t1è¿›å…¥WAITINGçŠ¶æ€
    end

    rect rgb(70, 130, 180)
        Note over T2: t2é‡æ–°è·å–objé”
        T2->>Lock: è¿›å…¥synchronizedå—
        T2->>T1: obj.notify() å”¤é†’t1
        Note over T1: t1å˜ä¸ºBLOCKEDçŠ¶æ€
        T2->>T2: Thread.sleep(50)
        T2->>Count: count++ (3â†’4)
        T2->>T2: è¾“å‡º "t2==>4"
        T2->>Lock: obj.wait() é‡Šæ”¾é”
        Note over T2: t2è¿›å…¥WAITINGçŠ¶æ€
    end

    Note over T1,T2: å¦‚æ­¤å¾ªç¯ç›´åˆ°count>=100
```

>  **çº¿ç¨‹çŠ¶æ€è½¬æ¢æµç¨‹**

```mermaid
stateDiagram-v2
    [*] --> RUNNABLE_t1 : åˆå§‹çŠ¶æ€
    [*] --> BLOCKED_t2 : åˆå§‹çŠ¶æ€
    
    state T1_çº¿ç¨‹ {
        RUNNABLE_t1 --> IN_SYNC_t1 : è·å–objé”
        IN_SYNC_t1 --> WAITING_t1 : obj.wait()
        WAITING_t1 --> BLOCKED_t1 : è¢«t2å”¤é†’
        BLOCKED_t1 --> RUNNABLE_t1 : é‡æ–°è·å–é”
    }
    
    state T2_çº¿ç¨‹ {
        BLOCKED_t2 --> RUNNABLE_t2 : è·å–objé”
        RUNNABLE_t2 --> IN_SYNC_t2 : è¿›å…¥åŒæ­¥å—
        IN_SYNC_t2 --> WAITING_t2 : obj.wait()
        WAITING_t2 --> BLOCKED_t2 : è¢«t1å”¤é†’
    }
    
    WAITING_t1 --> BLOCKED_t1 : t2.notify()
    WAITING_t2 --> BLOCKED_t2 : t1.notify()
```







### çº¿ç¨‹äº¤æ›¿è¾“å‡º(2)

> **æ–°é¢˜ç›®ï¼š**
>
>  * t1-->A
>  * t2-->B
>  * t3-->C
>  * t1-->A
>  * t2-->B
>  * t3-->C
>  * ....
>  * t1-->A
>  * t2-->B
>  * t3-->C

```java
package com.powernode.javase.thread22;

public class ThreadTest {

    // å…±äº«å¯¹è±¡ï¼ˆt1 t2 t3çº¿ç¨‹å…±äº«çš„ä¸€ä¸ªå¯¹è±¡ï¼Œéƒ½å»äº‰å¤ºè¿™ä¸€æŠŠé”ï¼‰
    private static final Object lock = new Object();

    // ç»™ä¸€ä¸ªåˆå§‹å€¼ï¼Œè¿™ä¸ªåˆå§‹å€¼è¡¨ç¤ºç¬¬ä¸€æ¬¡è¾“å‡ºçš„æ—¶å€™ï¼Œt1å…ˆè¾“å‡ºã€‚
    private static boolean t1Output = true;
    private static boolean t2Output = false;
    private static boolean t3Output = false;

    public static void main(String[] args) {
        // åˆ›å»ºä¸‰ä¸ªçº¿ç¨‹

        // t1çº¿ç¨‹ï¼šè´Ÿè´£è¾“å‡ºA
        new Thread(new Runnable() {
            @Override
            public void run() {
                synchronized (lock) {
                    for (int i = 0; i < 10; i++) {
                        while (!t1Output) { // åªè¦ä¸æ˜¯t1çº¿ç¨‹è¾“å‡º
                            try {
                                lock.wait();
                            } catch (InterruptedException e) {
                                throw new RuntimeException(e);
                            }
                        }
                        // ç¨‹åºåˆ°è¿™é‡Œè¯´æ˜ï¼šè¯¥t1çº¿ç¨‹è¾“å‡ºäº†ï¼Œå¹¶ä¸”t1çº¿ç¨‹è¢«å”¤é†’äº†ã€‚
                        System.out.println(Thread.currentThread().getName() + " -->A");
                        // è¯¥å¸ƒå°”æ ‡è®°çš„å€¼
                        t1Output = false;
                        t2Output = true;
                        t3Output = false;
                        // å”¤é†’æ‰€æœ‰çº¿ç¨‹
                        lock.notifyAll();
                    }
                }
            }
        }).start();

        // t2çº¿ç¨‹ï¼šè´Ÿè´£è¾“å‡ºB
        new Thread(new Runnable() {
            @Override
            public void run() {
                synchronized (lock) {
                    for (int i = 0; i < 10; i++) {
                        while (!t2Output) { // åªè¦ä¸æ˜¯t2çº¿ç¨‹è¾“å‡º
                            try {
                                lock.wait();
                            } catch (InterruptedException e) {
                                throw new RuntimeException(e);
                            }
                        }
                        // ç¨‹åºåˆ°è¿™é‡Œè¯´æ˜ï¼šè¯¥t2çº¿ç¨‹è¾“å‡ºäº†ï¼Œå¹¶ä¸”t2çº¿ç¨‹è¢«å”¤é†’äº†ã€‚
                        System.out.println(Thread.currentThread().getName() + " -->B");
                        // è¯¥å¸ƒå°”æ ‡è®°çš„å€¼
                        t1Output = false;
                        t2Output = false;
                        t3Output = true;
                        // å”¤é†’æ‰€æœ‰çº¿ç¨‹
                        lock.notifyAll();
                    }
                }
            }

        }).start();

        // t3çº¿ç¨‹ï¼šè´Ÿè´£è¾“å‡ºC
        new Thread(new Runnable() {
            @Override
            public void run() {
                synchronized (lock) {
                    for (int i = 0; i < 10; i++) {
                        while (!t3Output) { // åªè¦ä¸æ˜¯t3çº¿ç¨‹è¾“å‡º
                            try {
                                lock.wait();
                            } catch (InterruptedException e) {
                                throw new RuntimeException(e);
                            }
                        }
                        // ç¨‹åºåˆ°è¿™é‡Œè¯´æ˜ï¼šè¯¥t3çº¿ç¨‹è¾“å‡ºäº†ï¼Œå¹¶ä¸”t3çº¿ç¨‹è¢«å”¤é†’äº†ã€‚
                        System.out.println(Thread.currentThread().getName() + " -->C");
                        // è¯¥å¸ƒå°”æ ‡è®°çš„å€¼
                        t1Output = true;
                        t2Output = false;
                        t3Output = false;
                        // å”¤é†’æ‰€æœ‰çº¿ç¨‹
                        lock.notifyAll();
                    }
                }
            }
        }).start();
    }
}
```

```java
Thread-0 -->A
Thread-1 -->B
Thread-2 -->C
...
Thread-0 -->A
Thread-1 -->B
Thread-2 -->C
```

```mermaid
sequenceDiagram
    participant T1 as Thread-1 (è¾“å‡ºA)
    participant T2 as Thread-2 (è¾“å‡ºB)
    participant T3 as Thread-3 (è¾“å‡ºC)
    participant Lock as å…±äº«é”å¯¹è±¡

    Note over T1,T3: åˆå§‹çŠ¶æ€: t1Output=true, t2Output=false, t3Output=false

    T1->>Lock: è·å–é”(synchronized)
    T1->>T1: æ£€æŸ¥t1Output=trueï¼Œä¸ç­‰å¾…
    T1->>T1: è¾“å‡º"A"
    T1->>T1: è®¾ç½®t1Output=false, t2Output=true, t3Output=false
    T1->>Lock: notifyAll()å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹
    T1->>Lock: é‡Šæ”¾é”(å¾ªç¯ç»§ç»­ï¼Œé‡æ–°è·å–é”)
    
    Note over T2,T3: æ­¤æ—¶T2çš„t2Output=trueï¼ŒT1å’ŒT3çš„æ ‡è®°ä¸ºfalse
    
    T2->>Lock: è·å–é”æˆåŠŸ
    T2->>T2: æ£€æŸ¥t2Output=trueï¼Œä¸ç­‰å¾…
    T2->>T2: è¾“å‡º"B"
    T2->>T2: è®¾ç½®t1Output=false, t2Output=false, t3Output=true
    T2->>Lock: notifyAll()å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹
    T2->>Lock: é‡Šæ”¾é”(å¾ªç¯ç»§ç»­ï¼Œé‡æ–°è·å–é”)
    
    Note over T1,T3: æ­¤æ—¶T3çš„t3Output=trueï¼ŒT1å’ŒT2çš„æ ‡è®°ä¸ºfalse
    
    T3->>Lock: è·å–é”æˆåŠŸ
    T3->>T3: æ£€æŸ¥t3Output=trueï¼Œä¸ç­‰å¾…
    T3->>T3: è¾“å‡º"C"
    T3->>T3: è®¾ç½®t1Output=true, t2Output=false, t3Output=false
    T3->>Lock: notifyAll()å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹
    T3->>Lock: é‡Šæ”¾é”(å¾ªç¯ç»§ç»­ï¼Œé‡æ–°è·å–é”)
    
    Note over T1,T3: æ­¤æ—¶T1çš„t1Output=trueï¼Œå›åˆ°åˆå§‹çŠ¶æ€ï¼Œå¼€å§‹æ–°ä¸€è½®å¾ªç¯
    
    T1->>Lock: è·å–é”æˆåŠŸ
    T1->>T1: æ£€æŸ¥t1Output=trueï¼Œä¸ç­‰å¾…
    T1->>T1: è¾“å‡º"A"(ç¬¬äºŒè½®)
    T1->>T1: è®¾ç½®æ ‡è®°ï¼Œå”¤é†’å…¶ä»–çº¿ç¨‹
    T1->>Lock: é‡Šæ”¾é”
    
    Note over T1,T3: å¦‚æ­¤å¾ªç¯10æ¬¡...
```

> **æ€»ç»“:**
>
> 1. **åˆå§‹çŠ¶æ€**ï¼šåªæœ‰T1å¯ä»¥æ‰§è¡Œï¼ŒT2å’ŒT3åœ¨wait()ä¸­ç­‰å¾…
> 2. **T1æ‰§è¡Œé˜¶æ®µ**ï¼š
>    - è·å–é”åæ£€æŸ¥`t1Output=true`ï¼Œç›´æ¥è¾“å‡º"A"
>    - ä¿®æ”¹æ ‡è®°ï¼š`t1Output=false, t2Output=true, t3Output=false`
>    - å”¤é†’æ‰€æœ‰çº¿ç¨‹ï¼Œé‡Šæ”¾é”
> 3. **T2æ‰§è¡Œé˜¶æ®µ**ï¼š
>    - è·å–é”åæ£€æŸ¥`t2Output=true`ï¼Œç›´æ¥è¾“å‡º"B"
>    - ä¿®æ”¹æ ‡è®°ï¼š`t1Output=false, t2Output=false, t3Output=true`
>    - å”¤é†’æ‰€æœ‰çº¿ç¨‹ï¼Œé‡Šæ”¾é”
> 4. **T3æ‰§è¡Œé˜¶æ®µ**ï¼š
>    - è·å–é”åæ£€æŸ¥`t3Output=true`ï¼Œç›´æ¥è¾“å‡º"C"
>    - ä¿®æ”¹æ ‡è®°ï¼š`t1Output=true, t2Output=false, t3Output=false`ï¼ˆå›åˆ°åˆå§‹çŠ¶æ€ï¼‰
>    - å”¤é†’æ‰€æœ‰çº¿ç¨‹ï¼Œé‡Šæ”¾é”
> 5. **å¾ªç¯é‡å¤**ï¼šè¿™ä¸ªè¿‡ç¨‹é‡å¤10æ¬¡ï¼Œç¡®ä¿Aâ†’Bâ†’Cçš„é¡ºåºè¾“å‡ºå„10æ¬¡
>
> **åŒæ­¥æœºåˆ¶æ ¸å¿ƒï¼š**
>
> - **é”ä¿æŠ¤**ï¼šsynchronizedç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œ
> - **æ¡ä»¶ç­‰å¾…**ï¼šwhileå¾ªç¯+wait()é˜²æ­¢è™šå‡å”¤é†’
> - **çŠ¶æ€åˆ‡æ¢**ï¼šå¸ƒå°”æ ‡è®°æ§åˆ¶æ‰§è¡Œé¡ºåº
> - **é€šçŸ¥æœºåˆ¶**ï¼šnotifyAll()å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹





















